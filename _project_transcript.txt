PROJECT TRANSCRIPT
Date: 02/01/2026, 16:13:27



================================================================================
FILE: .eslintrc.json
================================================================================
{
  "extends": [
    "next/core-web-vitals",
    "plugin:i18next/recommended"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["i18next"],
  "overrides": [
    {
      "files": ["*.tsx", "*.ts"],
      "rules": {
        "i18next/no-literal-string": [
          "error",
          {
            "markupOnly": true,
            "validateTemplate": true,
            "ignoreAttribute": [
              "className", "style", "href", "src", "alt", "key", "id", 
              "width", "height", "fill", "stroke", "viewBox", "d", 
              "target", "rel", "type", "placeholder", "as", "data-testid",
              "name", "value", "defaultValue", "role",
              "k", "label", "title", "aria-label"
            ]
          }
        ]
      }
    }
  ]
}

================================================================================
FILE: app\globals.css
================================================================================
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


================================================================================
FILE: app\[locale]\layout.tsx
================================================================================
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { AuthProvider } from '@/app/providers/AuthProvider';
import { QueryProvider } from '@/app/providers/QueryProvider';
import { ThemeProvider } from '@/app/providers/ThemeProvider';
import { Toaster } from 'sonner';
import { SettingsMenu } from '@/widgets/global-navigation/ui/SettingsMenu'; // [NEW]
import { GlobalModalWrapper } from '@/shared/ui/modal/GlobalModalWrapper';
import '../globals.css';

export const metadata = {
  title: 'Democracy is Dead',
  description: 'Advanced Voting Platform',
};

export default async function RootLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  const messages = await getMessages();

  return (
    <html lang={locale} suppressHydrationWarning>
      <body className="bg-[#030712] text-white antialiased">
        <NextIntlClientProvider messages={messages}>
          <ThemeProvider attribute="class" defaultTheme="dark" enableSystem disableTransitionOnChange>
            <QueryProvider>
              <AuthProvider>
                {/* Global Widgets */}
                <SettingsMenu /> 
                <GlobalModalWrapper />
                
                {children}
                <Toaster position="top-center" theme="dark" />
              </AuthProvider>
            </QueryProvider>
          </ThemeProvider>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

================================================================================
FILE: app\[locale]\lobby\[code]\page.tsx
================================================================================
import { notFound } from 'next/navigation';
import { createClient } from '@/shared/api/supabase'; // Ensure you have a server-safe client if needed, or use the standard one
import { LobbyPage } from '@/views/lobby/ui/LobbyPage';
import { createServerClient, CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';

// Helper to create Server Client
const createServerSupabase = async () => {
  const cookieStore = await cookies();
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
            // Note: This is read-only in Server Components, 
            // but required by the interface.
        },
      },
    }
  );
}

export default async function Page({ params }: { params: Promise<{ code: string }> }) {
  const { code } = await params;
  const supabase = await createServerSupabase();

  // 1. Fetch Lobby ID by Code (Server Side Security)
  const { data: lobby } = await supabase
    .from('lobbies')
    .select('id')
    .eq('code', code.toUpperCase())
    .single();

  if (!lobby) {
    return notFound();
  }

  // 2. Render the FSD Page Widget
  return <LobbyPage lobbyId={lobby.id} />;
}

================================================================================
FILE: app\[locale]\page.tsx
================================================================================
import { HomePage } from '@/views/home/ui/HomePage';

export default function Page() {
  return <HomePage />;
}

================================================================================
FILE: messages\en.json
================================================================================
{
  "Common": {
    "loading": "Loading...",
    "error": "An error occurred. Please try again.",
    "save": "Save",
    "saved": "Saved!",
    "cancel": "Cancel",
    "confirm": "Confirm",
    "delete": "Delete",
    "remove": "Remove",
    "back": "Back",
    "next": "Next",
    "close": "Close",
    "yes": "Yes",
    "no": "No",
    "auth_failed": "Authentication failed",
    "loading_lobby": "Loading Lobby...",
    "authenticating": "Authenticating...",
    "placeholder_name": "E.g. John Doe",
    "upload_image": "Upload Image",
    "remove_image": "Remove Image",
    "shuffle": "Shuffle"
  },
  "Auth": {
    "login_title": "Welcome Back",
    "signup_title": "Create Account",
    "username": "Username",
    "password": "Password",
    "login_btn": "Log In",
    "signup_btn": "Sign Up",
    "switch_signup": "New here? Create account",
    "switch_login": "Have an account? Log In",
    "logout": "Log Out",
    "error_creds": "Invalid credentials",
    "error_generic": "Authentication failed",
    "host_session": "Host Session"
  },
  "Settings": {
    "title": "Settings",
    "profile": "Profile",
    "language": "Language",
    "leave_lobby": "Leave Lobby",
    "logout": "Log Out",
    "current_lobby": "Current: {code}"
  },
  "Profile": {
    "title": "My Profile",
    "update_success": "Profile updated successfully!",
    "change_password": "Change Password",
    "new_password": "New Password",
    "update_btn": "Update Profile",
    "placeholder_name": "Display Name"
  },
  "Dashboard": {
    "my_lobbies": "My History",
    "host_badge": "HOST",
    "guest_badge": "GUEST",
    "no_lobbies": "You haven't joined any lobbies yet.",
    "resume": "Resume",
    "view_results": "View Results"
  },
  "Setup": {
    "step_1": "Step 1: Candidates",
    "step_2": "Step 2: Criteria",
    "step_3": "Step 3: Final Settings",
    "max_scale": "Max Voting Scale",
    "max_scale_desc": "The maximum score a user can give (e.g. 10 or 100).",
    "privacy_label": "Privacy",
    "privacy_public": "Public (Show Names)",
    "privacy_anon": "Anonymous (Hide Names)",
    "placeholder_name": "Name",
    "add_candidate": "+ Add Candidate",
    "add_candidate_desc": "Add options to vote on.",
    "add_factor": "+ Add Criteria",
    "add_factor_desc": "Define how candidates are judged.",
    "launch": "Launch Voting üöÄ",
    "input_type": "Input Type",
    "active_count": "{count} Active",
    "type_label": "Type",
    "control_label": "Control",
    "weight_label": "Weight (Impact)",
    "hidden_label": "Hidden?",
    "static_info_label": "Static Info (Displayed on Card)",
    "add_candidate_btn": "Add Candidate",
    "lobby_name": "Lobby Name",
    "lobby_name_ph": "e.g. Friday Pizza Night",
    "validation_error": "Please fix errors before proceeding.",
    "add_candidates_first": "Add candidates first to use this.",
    "decimal_allowed": "Decimals allowed",
    "disable_for": "Disable for...",
    "types": {
      "numerical": "Vote (Numerical)",
      "constant": "Fixed Info (Constant)"
    },
    "controls": {
      "slider": "Slider",
      "stars": "Stars",
      "number": "Number",
      "toggle": "Yes/No"
    },
    "static_placeholder": "Value for {factor}"
  },
  "Home": {
    "title": "Democracy is Dead",
    "subtitle": "The mathematical way to settle arguments about where to eat dinner.",
    "create_lobby": "Start New Lobby",
    "or_join": "Or Join",
    "join_placeholder": "CODE",
    "join_btn": "Go",
    "no_registration": "No registration required. Anonymous voting.",
    "recent_lobbies": "Recent Sessions",
    "clear_history": "Clear History",
    "last_visited": "Last visited: {date}",
    "welcome_user": "Hello, {name}!",
    "my_lobbies": "My Lobbies",
    "no_active_lobbies": "No active lobbies found.",
    "lobby_code_display": "CODE: {code}",
    "syncing": "Syncing from Cloud"
  },
  "Lobby": {
    "loading": "Loading Lobby...",
    "title": "Lobby {code}",
    "status_waiting": "Waiting for Host",
    "status_setup": "Setup in Progress",
    "status_voting": "Voting Open",
    "status_ended": "Voting Ended",
    "waiting_title": "Waiting for Host",
    "waiting_desc": "Participants are joining...",
    "configure_btn": "Configure Lobby",
    "host_configuring": "Host is configuring...",
    "host_configuring_desc": "Grab a drink, this might take a minute.",
    "loading_icon": "‚ùÑÔ∏è",
    "setup_icon": "‚öôÔ∏è"
  },
  "Host": {
    "title": "Host Controls",
    "anon_active": "Anon Active",
    "public": "Public",
    "end_vote": "End Vote",
    "privacy_updated": "Privacy updated",
    "end_error": "Failed to end voting",
    "tab_privacy": "Privacy",
    "tab_manage": "Manage",
    "suspend_vote": "Suspend & Edit",
    "suspend_desc": "Pause voting to add/remove candidates or factors. Existing votes for kept items remain safe.",
    "privacy_sections": {
      "users": "Participants",
      "candidates": "Candidates",
      "factors": "Factors"
    },
    "toggles": {
      "hide_names": "Hide Names",
      "hide_avatars": "Hide Avatars",
      "hide_values": "Hide Values"
    }
  },
  "Voting": {
    "submit": "Submit All Votes",
    "submitted": "Votes submitted successfully!",
    "failed": "Failed to submit votes.",
    "jolly_title": "Assign your Jolly üÉè",
    "jolly_desc": "Select your favorite candidate to double their score weight.",
    "jolly_none": "No Jolly",
    "static_value": "Fixed Value:",
    "weight_impact": "Impact: {val}",
    "negative_impact": "Negative Impact (Lower is better for candidate)",
    "expand_to_vote": "Tap to Vote",
    "minimized_view": "Current Distribution"
  },
  "Results": {
    "tabs": {
      "weighted": "Weighted",
      "schulze": "Schulze Matrix",
      "radar": "Radar Analysis",
      "badges": "Awards"
    },
    "no_data": "No data available",
    "matrix_legend": "Read ROW vs COLUMN. Green = Row wins.",
    "radar_legend": "Comparison by Criteria",
    "badges_title": "Voter Awards",
    "badges_list": {
      "hater": { "title": "The Hater", "desc": "Gave the lowest average scores." },
      "lover": { "title": "The Lover", "desc": "Gave the highest average scores." },
      "contrarian": { "title": "The Contrarian", "desc": "Disagreed most with the group." },
      "oracle": { "title": "The Oracle", "desc": "Perfectly predicted the winner." },
      "hive_mind": { "title": "Hive Mind", "desc": "Voted exactly like the average." }
    },
    "podium_title": "Top Candidates",
    "winner": "Winner",
    "runner_up": "Runner Up",
    "third": "Third Place",
    "how_it_works": "How it works",
    "system_explainer": {
      "weighted": "Calculates the average score (0-10) given by all voters, adjusted by the weight of each criteria.",
      "schulze": "A Condorcet method. It simulates pairwise duels between every candidate. The winner is the one who beats everyone else in the strongest paths.",
      "radar": "Visualizes the strengths and weaknesses of each candidate across different criteria."
    },
    "need_more_factors": "Need at least 3 numerical factors for Radar Analysis."
  },
  "Share": {
    "invite": "Invite üîó",
    "label_code": "Lobby Code",
    "copy": "Copy Link",
    "copied": "Link copied!"
  },
  "Chat": {
    "title": "Lobby Chat",
    "send": "Send",
    "placeholder": "Type a message...",
    "online_count": "{count} Online",
    "typing": "{name} is typing...",
    "edited": "(edited)",
    "replying_to": "Replying to {name}",
    "empty": "No messages yet.",
    "actions": {
      "reply": "Reply",
      "edit": "Edit",
      "delete": "Delete",
      "copy": "Copy"
    }
  },
  "ImagePicker": {
    "tab_url": "Link URL",
    "tab_upload": "Upload",
    "placeholder_url": "Paste image URL (https://...)",
    "preview": "Preview",
    "invalid_url": "Invalid URL"
  },
  "Language": {
    "switch": "Switch Language",
    "en": "English",
    "it": "Italiano"
  },
  "Modals": {
    "confirm_title": "Are you sure?",
    "confirm_btn": "Confirm",
    "cancel_btn": "Cancel"
  },
  "Tooltips": {
    "desc_prefix": "Description: "
  }
}

================================================================================
FILE: messages\it.json
================================================================================
{
  "Common": {
    "loading": "Caricamento...",
    "error": "Errore. Riprova.",
    "save": "Salva",
    "saved": "Salvato!",
    "cancel": "Annulla",
    "confirm": "Conferma",
    "delete": "Elimina",
    "remove": "Rimuovi",
    "back": "Indietro",
    "next": "Avanti",
    "close": "Chiudi",
    "yes": "S√¨",
    "no": "No",
    "auth_failed": "Autenticazione fallita",
    "loading_lobby": "Caricamento Lobby...",
    "authenticating": "Autenticazione...",
    "placeholder_name": "Es. Mario Rossi",
    "upload_image": "Carica Immagine",
    "remove_image": "Rimuovi Immagine",
    "shuffle": "Mischia"
  },
  "Auth": {
    "login_title": "Bentornato",
    "signup_title": "Crea Account",
    "username": "Nome Utente",
    "password": "Password",
    "login_btn": "Accedi",
    "signup_btn": "Registrati",
    "switch_signup": "Nuovo? Crea account",
    "switch_login": "Hai gi√† un account? Accedi",
    "logout": "Esci",
    "error_creds": "Credenziali non valide",
    "error_generic": "Autenticazione fallita",
    "host_session": "Sessione Host"
  },
  "Settings": {
    "title": "Impostazioni",
    "profile": "Profilo",
    "language": "Lingua",
    "leave_lobby": "Esci dalla Lobby",
    "logout": "Disconnetti",
    "current_lobby": "Attuale: {code}"
  },
  "Profile": {
    "title": "Il Mio Profilo",
    "update_success": "Profilo aggiornato con successo!",
    "change_password": "Cambia Password",
    "new_password": "Nuova Password",
    "update_btn": "Aggiorna Profilo",
    "placeholder_name": "Nome Visualizzato"
  },
  "Dashboard": {
    "my_lobbies": "La Mia Cronologia",
    "host_badge": "HOST",
    "guest_badge": "OSPITE",
    "no_lobbies": "Non hai ancora partecipato a nessuna lobby.",
    "resume": "Riprendi",
    "view_results": "Vedi Risultati"
  },
  "Setup": {
    "step_1": "Step 1: Candidati",
    "step_2": "Step 2: Criteri",
    "step_3": "Step 3: Impostazioni Finali",
    "max_scale": "Scala Massima",
    "max_scale_desc": "Il punteggio massimo assegnabile (es. 10 o 100).",
    "privacy_label": "Privacy",
    "privacy_public": "Pubblico (Mostra Nomi)",
    "privacy_anon": "Anonimo (Nascondi Nomi)",
    "placeholder_name": "Nome",
    "add_candidate": "+ Aggiungi Candidato",
    "add_candidate_desc": "Aggiungi le opzioni su cui votare.",
    "add_factor": "+ Aggiungi Criterio",
    "add_factor_desc": "Definisci come giudicare i candidati.",
    "launch": "Avvia Voto üöÄ",
    "input_type": "Tipo Input",
    "active_count": "{count} Attivi",
    "type_label": "Tipo",
    "control_label": "Controllo",
    "weight_label": "Peso (Impatto)",
    "hidden_label": "Nascosto?",
    "static_info_label": "Info Statiche (Mostrate sulla Carta)",
    "add_candidate_btn": "Aggiungi Candidato",
    "lobby_name": "Nome Lobby",
    "lobby_name_ph": "es. Pizza Venerd√¨",
    "validation_error": "Correggi gli errori prima di procedere.",
    "add_candidates_first": "Aggiungi prima i candidati per usare questa funzione.",
    "decimal_allowed": "Decimali consentiti",
    "disable_for": "Disabilita per...",
    "types": {
      "numerical": "Voto (Numerico)",
      "constant": "Info Fissa (Costante)"
    },
    "controls": {
      "slider": "Slider",
      "stars": "Stelle",
      "number": "Numero",
      "toggle": "S√¨/No"
    },
    "static_placeholder": "Valore per {factor}"
  },
  "Home": {
    "title": "Democracy is Dead",
    "subtitle": "Il modo matematico per decidere dove andare a cena.",
    "create_lobby": "Crea Nuova Lobby",
    "or_join": "O Entra",
    "join_placeholder": "CODICE",
    "join_btn": "Vai",
    "no_registration": "Nessuna registrazione. Voto anonimo.",
    "recent_lobbies": "Sessioni Recenti",
    "clear_history": "Cancella Cronologia",
    "last_visited": "Ultima visita: {date}",
    "welcome_user": "Ciao, {name}!",
    "my_lobbies": "Le Mie Lobby",
    "no_active_lobbies": "Nessuna lobby attiva trovata.",
    "lobby_code_display": "CODICE: {code}",
    "syncing": "Sincronizzazione Cloud"
  },
  "Lobby": {
    "loading": "Caricamento Lobby...",
    "title": "Lobby {code}",
    "status_waiting": "In attesa dell'Host",
    "status_setup": "Setup in Corso",
    "status_voting": "Votazione Aperta",
    "status_ended": "Votazione Terminata",
    "waiting_title": "In attesa dell'Host",
    "waiting_desc": "I partecipanti stanno entrando...",
    "configure_btn": "Configura Lobby",
    "host_configuring": "L'Host sta configurando...",
    "host_configuring_desc": "Prendi da bere, ci vorr√† un minuto.",
    "loading_icon": "‚ùÑÔ∏è",
    "setup_icon": "‚öôÔ∏è"
  },
  "Host": {
    "title": "Controlli Host",
    "anon_active": "Anonimo",
    "public": "Pubblico",
    "end_vote": "Termina Voto",
    "privacy_updated": "Privacy aggiornata",
    "end_error": "Impossibile terminare",
    "tab_privacy": "Privacy",
    "tab_manage": "Gestione",
    "suspend_vote": "Sospendi & Modifica",
    "suspend_desc": "Metti in pausa per modificare candidati/fattori. I voti esistenti rimangono salvi.",
    "privacy_sections": {
      "users": "Partecipanti",
      "candidates": "Candidati",
      "factors": "Fattori"
    },
    "toggles": {
      "hide_names": "Nascondi Nomi",
      "hide_avatars": "Nascondi Avatar",
      "hide_values": "Nascondi Valori"
    }
  },
  "Voting": {
    "submit": "Invia Voti",
    "submitted": "Voti inviati con successo!",
    "failed": "Errore nell'invio voti.",
    "jolly_title": "Assegna il tuo Jolly üÉè",
    "jolly_desc": "Scegli il tuo preferito per raddoppiare il peso del voto.",
    "jolly_none": "Nessun Jolly",
    "static_value": "Valore Fisso:",
    "weight_impact": "Impatto: {val}",
    "negative_impact": "Impatto Negativo (Basso √® meglio per il candidato)",
    "expand_to_vote": "Tocca per Votare",
    "minimized_view": "Distribuzione Attuale"
  },
  "Results": {
    "tabs": {
      "weighted": "Pesata",
      "schulze": "Matrice Schulze",
      "radar": "Analisi Radar",
      "badges": "Premi"
    },
    "no_data": "Nessun dato disponibile",
    "matrix_legend": "Leggi RIGA vs COLONNA. Verde = Riga vince.",
    "radar_legend": "Confronto per Criteri",
    "badges_title": "Premi Votanti",
    "badges_list": {
      "hater": { "title": "Il Critico", "desc": "Ha dato i voti medi pi√π bassi." },
      "lover": { "title": "L'Entusiasta", "desc": "Ha dato i voti medi pi√π alti." },
      "contrarian": { "title": "Bastian Contrario", "desc": "Spesso in disaccordo con il gruppo." },
      "oracle": { "title": "L'Oracolo", "desc": "Ha predetto perfettamente il vincitore." },
      "hive_mind": { "title": "Mente Collettiva", "desc": "Ha votato esattamente come la media." }
    },
    "podium_title": "Migliori Candidati",
    "winner": "Vincitore",
    "runner_up": "Secondo Posto",
    "third": "Terzo Posto",
    "how_it_works": "Come funziona",
    "system_explainer": {
      "weighted": "Calcola il punteggio medio (0-10) dato da tutti i votanti, aggiustato per il peso di ogni criterio.",
      "schulze": "Un metodo di Condorcet. Simula duelli a coppie tra ogni candidato. Vince chi batte tutti gli altri nei percorsi pi√π forti.",
      "radar": "Visualizza i punti di forza e debolezza di ogni candidato attraverso i diversi criteri."
    },
    "need_more_factors": "Servono almeno 3 fattori numerici per l'Analisi Radar."
  },
  "Share": {
    "invite": "Invita üîó",
    "label_code": "Codice Lobby",
    "copy": "Copia Link",
    "copied": "Link copiato!"
  },
  "Chat": {
    "title": "Chat Lobby",
    "send": "Invia",
    "placeholder": "Scrivi un messaggio...",
    "online_count": "{count} Online",
    "typing": "{name} sta scrivendo...",
    "edited": "(modificato)",
    "replying_to": "In risposta a {name}",
    "empty": "Nessun messaggio.",
    "actions": {
      "reply": "Rispondi",
      "edit": "Modifica",
      "delete": "Elimina",
      "copy": "Copia"
    }
  },
  "ImagePicker": {
    "tab_url": "Link URL",
    "tab_upload": "Carica",
    "placeholder_url": "Incolla URL immagine (https://...)",
    "preview": "Anteprima",
    "invalid_url": "URL non valido"
  },
  "Language": {
    "switch": "Cambia Lingua",
    "en": "English",
    "it": "Italiano"
  },
  "Modals": {
    "confirm_title": "Sei sicuro?",
    "confirm_btn": "Conferma",
    "cancel_btn": "Annulla"
  },
  "Tooltips": {
    "desc_prefix": "Descrizione: "
  }
}

================================================================================
FILE: middleware.ts
================================================================================
import createMiddleware from 'next-intl/middleware';
// [FIX] Update import path to point into src/
import { routing } from './src/i18n/routing'; 
 
export default createMiddleware(routing);
 
export const config = {
  // Match all paths except internal Next.js files, APIs, and static files
  matcher: ['/((?!api|_next|_vercel|.*\\..*).*)']
};

================================================================================
FILE: next-env.d.ts
================================================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


================================================================================
FILE: next.config.ts
================================================================================
import type { NextConfig } from "next";
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

const nextConfig: NextConfig = {
  images: {
    dangerouslyAllowSVG: true, // [FIX] Allow DiceBear SVGs
    contentDispositionType: 'attachment',
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
    remotePatterns: [
      { protocol: 'https', hostname: 'api.dicebear.com' },
      { protocol: 'https', hostname: '**' }
    ],
  },
};

export default withNextIntl(nextConfig);

================================================================================
FILE: package.json
================================================================================
{
  "name": "democracy-is-dead",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "scan": "node scan-codebase.js",
    "clean:comments": "node clean-comments.js"
  },
  "dependencies": {
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-tooltip": "^1.2.8",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.89.0",
    "@tanstack/react-query": "^5.90.15",
    "@types/lodash": "^4.17.21",
    "chart.js": "^4.5.1",
    "framer-motion": "^12.23.26",
    "lodash": "^4.17.21",
    "lucide-react": "^0.562.0",
    "next": "16.1.0",
    "next-intl": "^4.6.1",
    "next-themes": "^0.4.6",
    "qrcode.react": "^4.2.0",
    "react": "19.2.3",
    "react-chartjs-2": "^5.3.1",
    "react-dom": "19.2.3",
    "react-hook-form": "^7.69.0",
    "react-qr-code": "^2.0.18",
    "recharts": "^3.6.0",
    "root": "github:tanstack/react-query",
    "sonner": "^2.0.7",
    "zod": "^4.2.1",
    "zustand": "^5.0.9"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@typescript-eslint/parser": "^8.50.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^8.57.1",
    "eslint-config-next": "^14.1.0",
    "eslint-plugin-i18next": "^6.1.3",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "typescript": "^5"
  }
}


================================================================================
FILE: src\app\globals.css
================================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    @apply bg-[#030712] text-white overflow-x-hidden;
    background-image: 
      radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
      radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
  }
}

@layer components {
  /* Glassmorphism Card */
  .glass-card {
    @apply bg-gray-900/40 backdrop-blur-xl border border-white/10 shadow-xl rounded-3xl;
  }
  
  /* Modern Input */
  .glass-input {
    @apply bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-sm 
    focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 
    placeholder:text-gray-600 transition-all duration-300;
  }

  /* Neon Button */
  .btn-primary {
    @apply bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-xl
    shadow-[0_0_20px_-5px_rgba(79,70,229,0.5)] hover:shadow-[0_0_25px_-5px_rgba(79,70,229,0.6)]
    transition-all duration-300 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed;
  }
}

================================================================================
FILE: src\app\providers\AuthProvider.tsx
================================================================================
'use client'
import React, { createContext, useContext, useEffect, useState, useMemo } from 'react';
import { User } from '@supabase/supabase-js';
import { createClient } from '@/shared/api/supabase';

interface AuthContextType {
  user: User | null;
  loading: boolean;
}

const AuthContext = createContext<AuthContextType>({ user: null, loading: true });

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  
  // [FIX] Memoize client to keep it stable across renders
  const supabase = useMemo(() => createClient(), []);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    return () => subscription.unsubscribe();
  }, [supabase]); // [FIX] Added dependency

  return (
    <AuthContext.Provider value={{ user, loading }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => useContext(AuthContext);

================================================================================
FILE: src\app\providers\QueryProvider.tsx
================================================================================
'use client'

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState } from 'react';

export const QueryProvider = ({ children }: { children: React.ReactNode }) => {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60 * 1000, // 1 minute
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

================================================================================
FILE: src\app\providers\ThemeProvider.tsx
================================================================================
'use client'

import * as React from 'react';
import { ThemeProvider as NextThemesProvider } from 'next-themes';

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}

================================================================================
FILE: src\entities\candidate\model\types.ts
================================================================================
import { z } from 'zod';

export const CandidateSchema = z.object({
  id: z.string().uuid().optional(),
  name: z.string().min(1, "Name is required").max(50),
  description: z.string().max(300).optional(),
  image_url: z.string().url().nullable().optional(),
  // Static values for "Constant" factors (e.g. Price: 100)
  static_values: z.record(z.string(), z.number()).optional(),
});

export type Candidate = z.infer<typeof CandidateSchema> & {
  id: string; // ID is required in the application type
  lobby_id: string;
};

================================================================================
FILE: src\entities\candidate\ui\CandidateCard.tsx
================================================================================
import React from 'react';
import { Candidate } from '../model/types';
import { SmartEntity } from '@/shared/ui/smart-entity';

interface CandidateCardProps {
  candidate: Candidate;
  onClick?: () => void;
  isSelected?: boolean;
  className?: string;
}

export const CandidateCard = ({ 
  candidate, 
  onClick, 
  isSelected, 
  className = '' 
}: CandidateCardProps) => {
  return (
    <div 
      onClick={onClick}
      className={`
        relative p-4 rounded-xl border transition-all duration-200 
        flex items-center gap-4 group cursor-pointer
        ${isSelected 
          ? 'bg-indigo-900/20 border-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.2)]' 
          : 'bg-gray-900/50 border-gray-800 hover:border-gray-600 hover:bg-gray-800'
        }
        ${className}
      `}
    >
      <div className="shrink-0">
        <SmartEntity 
          seed={candidate.id} 
          label={candidate.name} 
          imageUrl={candidate.image_url} 
          className="pointer-events-none" // Text handling handled below for layout reasons
        />
      </div>
      
      <div className="min-w-0 flex-1">
        <h4 className={`font-bold truncate ${isSelected ? 'text-indigo-300' : 'text-gray-200'}`}>
          {candidate.name}
        </h4>
        {candidate.description && (
          <p className="text-xs text-gray-500 truncate">
            {candidate.description}
          </p>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: src\entities\factor\model\types.ts
================================================================================
import { z } from 'zod';

export type FactorType = 'numerical' | 'constant';
export type Trend = 'higher_better' | 'lower_better';
export type InputControl = 'slider' | 'stars' | 'number' | 'toggle';

export const FactorSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1, "Required"),
  description: z.string().optional(),
  weight: z.number().min(-10).max(10).default(1),
  type: z.enum(['numerical', 'constant']).default('numerical'),
  input_control: z.enum(['slider', 'stars', 'number', 'toggle']).default('slider'),
  step: z.number().default(1),
  trend: z.enum(['higher_better', 'lower_better']).default('higher_better'),
  image_url: z.string().optional(),
  is_hidden: z.boolean().default(false),
  
  // [NEW] List of Candidate IDs for whom this factor does not apply
  disabled_candidates: z.array(z.string()).default([]), 
});

export type Factor = z.infer<typeof FactorSchema>;

================================================================================
FILE: src\entities\factor\ui\FactorIcon.tsx
================================================================================
import React from 'react';
import Image from 'next/image';
import { Factor } from '../model/types';

interface FactorIconProps {
  factor: Factor;
  className?: string;
}

export const FactorIcon = ({ factor, className = "w-10 h-10" }: FactorIconProps) => {
  if (factor.image_url) {
    return (
      <div className={`relative rounded-lg overflow-hidden bg-gray-800 border border-gray-700 ${className}`}>
        <Image 
          src={factor.image_url} 
          alt={factor.name} 
          fill
          sizes="40px"
          className="object-cover"
        />
      </div>
    );
  }

  return (
    <div className={`rounded-lg flex items-center justify-center bg-gray-800 border border-gray-700 font-bold text-gray-400 ${className}`}>
      {factor.name.charAt(0).toUpperCase()}
    </div>
  );
};

================================================================================
FILE: src\entities\lobby\lib\status-helpers.ts
================================================================================
import { LobbyStatus } from '../model/types';

export const isLobbyActive = (status: LobbyStatus) => status === 'voting';
export const isLobbySetup = (status: LobbyStatus) => status === 'setup';
export const isLobbyEnded = (status: LobbyStatus) => status === 'ended';
export const isLobbyWaiting = (status: LobbyStatus) => status === 'waiting';

export const getStatusLabelKey = (status: LobbyStatus) => {
  switch (status) {
    case 'waiting': return 'status_waiting';
    case 'setup': return 'status_setup';
    case 'voting': return 'status_voting';
    case 'ended': return 'status_ended';
    default: return 'status_waiting';
  }
};

export const getStatusColor = (status: LobbyStatus) => {
  switch (status) {
    case 'voting': return 'text-green-400 bg-green-400/10 border-green-400/20';
    case 'setup': return 'text-amber-400 bg-amber-400/10 border-amber-400/20';
    case 'ended': return 'text-gray-400 bg-gray-400/10 border-gray-400/20';
    default: return 'text-indigo-400 bg-indigo-400/10 border-indigo-400/20';
  }
};

================================================================================
FILE: src\entities\lobby\model\lobby-store.ts
================================================================================
import { create } from 'zustand';
import { Lobby } from './types';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';

interface LobbyState {
  lobby: Lobby | null;
  candidates: Candidate[];
  factors: Factor[];
  
  setLobby: (lobby: Lobby) => void;
  setCandidates: (candidates: Candidate[]) => void;
  updateStatus: (status: Lobby['status']) => void;
}

// [FIX] Added <LobbyState> generic to create()
export const useLobbyStore = create<LobbyState>((set) => ({
  lobby: null,
  candidates: [],
  factors: [],

  setLobby: (lobby: Lobby) => set({ 
    lobby, 
    factors: lobby.settings.factors || [] 
  }),

  setCandidates: (candidates: Candidate[]) => set({ candidates }),

  updateStatus: (status: Lobby['status']) => set((state) => ({
    lobby: state.lobby ? { ...state.lobby, status } : null
  })),
}));

================================================================================
FILE: src\entities\lobby\model\types.ts
================================================================================
import { z } from 'zod';
import { FactorSchema } from '@/entities/factor/model/types';

export const VotingScaleSchema = z.object({
  max: z.number().min(5).max(100).default(10),
});

export const LobbySettingsSchema = z.object({
  privacy: z.enum(['public', 'anonymous', 'blind']).default('public'),
  voting_scale: VotingScaleSchema,
  allow_decimals: z.boolean().default(false),
  factors: z.array(FactorSchema).default([]),
});

export type LobbySettings = z.infer<typeof LobbySettingsSchema>;

export type LobbyStatus = 'waiting' | 'setup' | 'voting' | 'ended';

export interface Lobby {
  id: string;
  code: string;
  host_id: string;
  // [FIX] Added name property
  name: string;
  status: LobbyStatus;
  settings: LobbySettings;
  created_at: string;
}

================================================================================
FILE: src\entities\participant\model\badges.ts
================================================================================
export type BadgeType = 'hater' | 'lover' | 'contrarian' | 'oracle' | 'hive_mind';

interface UserStat {
  userId: string;
  avgScore: number;      // Average score given by this user across all candidates
  deviation: number;     // How far their votes are from the group average
  topPickId: string;     // The candidate they gave the highest score to
  maxScore: number;      // The highest score they gave
}

export const calculateBadges = (
  votes: any[], 
  winnerId: string, 
  // optional: candidates count or factors could be passed for deeper analysis
): Record<string, BadgeType[]> => {
  if (!votes || votes.length === 0) return {};

  const userStats: Record<string, UserStat> = {};
  const allScores: number[] = [];

  // 1. Aggregation: Calculate per-user stats
  votes.forEach(v => {
    if (!userStats[v.voter_id]) {
      userStats[v.voter_id] = { 
        userId: v.voter_id, 
        avgScore: 0, 
        deviation: 0, 
        topPickId: '', 
        maxScore: -1 
      };
    }

    const scores = Object.values(v.scores).map(val => Number(val));
    const voteSum = scores.reduce((a, b) => a + b, 0);
    const voteAvg = scores.length ? voteSum / scores.length : 0;

    // Track global scores for group average
    allScores.push(voteAvg);

    // Update User Running Stats (Simplified: we treat each vote row as a separate entry, 
    // but usually 1 row = 1 candidate. So we average the averages later)
    // Actually, let's store arrays first to be precise.
  });

  // Re-loop properly with grouped data
  const votesByUser: Record<string, any[]> = {};
  votes.forEach(v => {
    if (!votesByUser[v.voter_id]) votesByUser[v.voter_id] = [];
    votesByUser[v.voter_id].push(v);
  });

  const statsList: UserStat[] = [];

  Object.entries(votesByUser).forEach(([uid, userVotes]) => {
    let totalUserScore = 0;
    let totalItems = 0;
    let bestCandId = "";
    let highestScoreFound = -1;

    userVotes.forEach(v => {
      const s = Object.values(v.scores).map(x => Number(x));
      const sum = s.reduce((a, b) => a + b, 0);
      totalUserScore += sum;
      totalItems += s.length;

      // Find their favorite
      if (sum > highestScoreFound) {
        highestScoreFound = sum;
        bestCandId = v.candidate_id;
      }
    });

    const avg = totalItems ? totalUserScore / totalItems : 0;
    
    statsList.push({
      userId: uid,
      avgScore: avg,
      deviation: 0, // Calculated next
      topPickId: bestCandId,
      maxScore: highestScoreFound
    });
  });

  if (statsList.length < 2) return {};

  // 2. Calculate Group Average & Deviation
  const groupSum = statsList.reduce((a, b) => a + b.avgScore, 0);
  const groupAvg = groupSum / statsList.length;

  statsList.forEach(stat => {
    stat.deviation = Math.abs(stat.avgScore - groupAvg);
  });

  // 3. Assign Badges
  const badges: Record<string, BadgeType[]> = {};
  const addBadge = (uid: string, b: BadgeType) => {
    if (!badges[uid]) badges[uid] = [];
    if (!badges[uid].includes(b)) badges[uid].push(b);
  };

  // Sorts for assignments
  const byScore = [...statsList].sort((a, b) => a.avgScore - b.avgScore);
  const byDeviation = [...statsList].sort((a, b) => a.deviation - b.deviation);

  // HATER: Lowest Average Score
  addBadge(byScore[0].userId, 'hater');

  // LOVER: Highest Average Score
  addBadge(byScore[byScore.length - 1].userId, 'lover');

  // HIVE MIND: Lowest Deviation (Closest to average)
  addBadge(byDeviation[0].userId, 'hive_mind');

  // CONTRARIAN: Highest Deviation (Furthest from average)
  // Only assign if deviation is significant (> 10% of scale usually, but simple here)
  if (byDeviation[byDeviation.length - 1].deviation > 0.5) {
    addBadge(byDeviation[byDeviation.length - 1].userId, 'contrarian');
  }

  // ORACLE: Voted most heavily for the eventual winner
  statsList.forEach(stat => {
    if (stat.topPickId === winnerId) {
      addBadge(stat.userId, 'oracle');
    }
  });

  return badges;
};

================================================================================
FILE: src\entities\participant\model\types.ts
================================================================================
export interface Participant {
  user_id: string;
  nickname: string; // Will be "Anonymous Voter" if masked
  avatar_url: string | null; // Will be null if masked
  has_voted: boolean;
  badges: string[]; // JSONB array from DB
}

================================================================================
FILE: src\entities\participant\ui\ParticipantAvatar.tsx
================================================================================
import React from 'react';
import { SmartEntity } from '@/shared/ui/smart-entity';

interface Participant {
  user_id: string;
  nickname: string;
  avatar_url?: string | null;
}

interface ParticipantAvatarProps {
  participant: Participant;
  isPrivacyMode?: boolean; // If true, masks name and avatar
  className?: string;
  showLabel?: boolean;
}

export const ParticipantAvatar = ({ 
  participant, 
  isPrivacyMode = false, 
  className = "",
  showLabel = true
}: ParticipantAvatarProps) => {
  
  if (!showLabel) {
    // Just the image (masked if needed)
    return (
      <SmartEntity 
        label="" // Label hidden via css/layout in this mode usually, or we just want the circle
        imageUrl={participant.avatar_url}
        seed={participant.user_id}
        isMasked={isPrivacyMode}
        className={className}
      />
    );
  }

  return (
    <SmartEntity 
      label={participant.nickname}
      imageUrl={participant.avatar_url}
      seed={participant.user_id}
      isMasked={isPrivacyMode}
      fallbackLabel="Anonymous Voter"
      className={className}
    />
  );
};

================================================================================
FILE: src\features\auth\ui\AuthForm.tsx
================================================================================
'use client'
import { useState } from 'react';
import { createClient } from '@/shared/api/supabase';
import { Button } from '@/shared/ui/button';
import { Input } from '@/shared/ui/input';
import { useTranslations } from 'next-intl';
import { toast } from 'sonner';

interface AuthFormProps {
  onSuccess: () => void;
}

export const AuthForm = ({ onSuccess }: AuthFormProps) => {
  const t = useTranslations('Auth');
  const tCommon = useTranslations('Common');
  
  const [isLogin, setIsLogin] = useState(true);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const supabase = createClient();

  const handleAuth = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!username || !password) return;
    setLoading(true);

    // Create a consistent fake email
    const email = `${username.trim().toLowerCase().replace(/\s+/g, '')}@did.app`;

    try {
      if (isLogin) {
        // LOGIN
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
      } else {
        // SIGN UP
        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password,
          options: { data: { nickname: username } } 
        });
        
        if (error) throw error;
        
        // [FIX] Check if session was created. If not, Email Confirm is likely ON.
        if (!data.session) {
            throw new Error("CONFIRMATION_REQUIRED");
        }
      }
      
      onSuccess();
    } catch (err: any) {
      console.error("Auth Error:", err);
      
      if (err.message === 'CONFIRMATION_REQUIRED') {
          toast.error("Error: You must disable 'Confirm Email' in Supabase Dashboard -> Auth -> Providers.");
      } else if (err.message.includes('Invalid login')) {
          toast.error(t('error_creds'));
      } else if (err.message.includes('already registered')) {
          toast.error("Username already taken. Try logging in.");
      } else {
          toast.error(t('error_generic'));
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="glass-card p-8 w-full max-w-sm mx-auto animate-in fade-in">
      <h2 className="text-2xl font-bold mb-6 text-center text-white">
        {isLogin ? t('login_title') : t('signup_title')}
      </h2>
      
      <form onSubmit={handleAuth} className="space-y-4">
        <Input 
          placeholder={t('username')}
          value={username}
          onChange={e => setUsername(e.target.value)}
          className="glass-input text-white"
          autoFocus
        />
        <Input 
          type="password"
          placeholder={t('password')}
          value={password}
          onChange={e => setPassword(e.target.value)}
          className="glass-input text-white"
        />
        <Button type="submit" isLoading={loading} className="w-full btn-primary">
          {isLogin ? t('login_btn') : t('signup_btn')}
        </Button>
      </form>

      <div className="mt-4 text-center">
        <button 
          onClick={() => setIsLogin(!isLogin)}
          className="text-xs text-gray-400 hover:text-indigo-400 transition-colors"
        >
          {isLogin ? t('switch_signup') : t('switch_login')}
        </button>
      </div>
    </div>
  );
};

================================================================================
FILE: src\features\cast-vote\api\vote-api.ts
================================================================================
import { createClient } from '@/shared/api/supabase';

export interface SubmitVotePayload {
  lobby_id: string;
  voter_id: string;
  candidate_id: string;
  scores: Record<string, number>;
}

export const submitVote = async (payload: SubmitVotePayload) => {
  const supabase = createClient();
  
  const { error } = await supabase
    .from('votes')
    .upsert({
      lobby_id: payload.lobby_id,
      voter_id: payload.voter_id,
      candidate_id: payload.candidate_id,
      scores: payload.scores,
      updated_at: new Date().toISOString()
    }, { onConflict: 'voter_id,candidate_id' });

  if (error) throw error;
  return true;
};

================================================================================
FILE: src\features\cast-vote\model\useCastVote.ts
================================================================================
import { useState } from 'react';
import { submitVote } from '../api/vote-api';
import { toast } from 'sonner';

export const useCastVote = (lobbyId: string, userId: string) => {
  // Local state for optimistic UI (instant feedback)
  const [localVotes, setLocalVotes] = useState<Record<string, Record<string, number>>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);

  const registerVote = (candidateId: string, factorId: string, value: number) => {
    setLocalVotes(prev => ({
      ...prev,
      [candidateId]: {
        ...(prev[candidateId] || {}),
        [factorId]: value
      }
    }));
  };

  const commitVotes = async () => {
    setIsSubmitting(true);
    const promises = Object.entries(localVotes).map(([candidateId, scores]) => 
      submitVote({
        lobby_id: lobbyId,
        voter_id: userId,
        candidate_id: candidateId,
        scores
      })
    );

    try {
      await Promise.all(promises);
      toast.success("Votes submitted successfully!");
    } catch (e) {
      toast.error("Failed to submit votes.");
      console.error(e);
    } finally {
      setIsSubmitting(false);
    }
  };

  return {
    localVotes,
    registerVote,
    commitVotes,
    isSubmitting
  };
};

================================================================================
FILE: src\features\change-language\ui\LanguageSwitcher.tsx
================================================================================
'use client'
import { useLocale } from 'next-intl';
import { usePathname, useRouter } from '@/i18n/routing';

export const LanguageSwitcher = () => {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  const switchLocale = (newLocale: 'en' | 'it') => {
    router.replace(pathname, { locale: newLocale });
  };

  return (
    <div className="fixed top-4 right-4 z-[200] flex items-center bg-black/40 backdrop-blur-md border border-white/10 rounded-full p-1 shadow-2xl">
      <button 
        onClick={() => switchLocale('en')}
        className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-300 ${locale === 'en' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
      >
        EN
      </button>
      <button 
        onClick={() => switchLocale('it')}
        className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-300 ${locale === 'it' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
      >
        IT
      </button>
    </div>
  );
};

================================================================================
FILE: src\features\chat\model\types.ts
================================================================================
export interface ChatMessage {
  id: string;
  user_id: string;
  nickname: string;
  content: string;
  created_at: string;
  is_edited?: boolean;
  reply_to_id?: string | null;
  // Join fields (if you fetch them via Supabase join, optional for now)
  reply_to?: {
    nickname: string;
    content: string;
  };
}

export interface PresenceState {
  user_id: string;
  nickname: string;
  online_at: string;
}

================================================================================
FILE: src\features\chat\model\useChat.ts
================================================================================
import { useState, useEffect, useRef, useMemo } from 'react';
import { createClient } from '@/shared/api/supabase';
import { ChatMessage } from './types';

export const useChat = (lobbyId: string, userId: string, nickname: string) => {
  // [FIX] Memoize Supabase client
  const supabase = useMemo(() => createClient(), []);
  
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [typingUsers, setTypingUsers] = useState<Set<string>>(new Set());
  
  const channelRef = useRef<any>(null);

  useEffect(() => {
    const fetchHistory = async () => {
      const { data } = await supabase
        .from('lobby_messages')
        .select(`*, reply_to:lobby_messages!reply_to_id(nickname, content)`)
        .eq('lobby_id', lobbyId)
        .order('created_at', { ascending: true });
      
      if (data) setMessages(data as any);
    };
    fetchHistory();

    const channel = supabase.channel(`chat_logic:${lobbyId}`)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'lobby_messages', filter: `lobby_id=eq.${lobbyId}` }, 
        async (payload) => {
          if (payload.eventType === 'INSERT') {
            let newMsg = payload.new as ChatMessage;
            if (newMsg.reply_to_id) {
               const { data } = await supabase.from('lobby_messages').select('nickname, content').eq('id', newMsg.reply_to_id).single();
               newMsg.reply_to = data as any;
            }
            setMessages(prev => [...prev, newMsg]);
          } 
          else if (payload.eventType === 'DELETE') {
            setMessages(prev => prev.filter(m => m.id !== payload.old.id));
          }
          else if (payload.eventType === 'UPDATE') {
            setMessages(prev => prev.map(m => m.id === payload.new.id ? { ...m, ...payload.new } : m));
          }
        }
      )
      .on('broadcast', { event: 'typing' }, ({ payload }) => {
        if (payload.user_id !== userId) {
          setTypingUsers(prev => {
            const next = new Set(prev);
            next.add(payload.nickname);
            return next;
          });
          setTimeout(() => {
            setTypingUsers(prev => {
              const next = new Set(prev);
              next.delete(payload.nickname);
              return next;
            });
          }, 3000);
        }
      })
      .subscribe();

    channelRef.current = channel;

    return () => { supabase.removeChannel(channel); };
  }, [lobbyId, userId, supabase]); // [FIX] Added supabase dependency

  const sendMessage = async (content: string, replyToId?: string) => {
    if (!content.trim()) return;
    await supabase.from('lobby_messages').insert({
      lobby_id: lobbyId,
      user_id: userId,
      nickname,
      content,
      reply_to_id: replyToId || null
    });
  };

const deleteMessage = async (msgId: string) => {
    // Optimistic update
    setMessages(prev => prev.filter(m => m.id !== msgId));
    await supabase.from('lobby_messages').delete().eq('id', msgId);
  };

  const editMessage = async (msgId: string, newContent: string) => {
    await supabase.from('lobby_messages').update({ content: newContent, is_edited: true }).eq('id', msgId);
  };

  const broadcastTyping = () => {
    if (channelRef.current) {
      channelRef.current.send({
        type: 'broadcast',
        event: 'typing',
        payload: { user_id: userId, nickname }
      });
    }
  };

  return {
    messages,
    typingUsers: Array.from(typingUsers),
    sendMessage,
    deleteMessage,
    editMessage,
    broadcastTyping
  };
};

================================================================================
FILE: src\features\chat\model\usePresence.ts
================================================================================
import { useState, useEffect, useMemo } from 'react';
import { createClient } from '@/shared/api/supabase';
import { PresenceState } from './types';

export const usePresence = (lobbyId: string, userId: string, nickname: string) => {
  const [onlineUsers, setOnlineUsers] = useState<PresenceState[]>([]);
  
  // [FIX] Memoize Supabase client
  const supabase = useMemo(() => createClient(), []);

  useEffect(() => {
    const channel = supabase.channel(`presence:${lobbyId}`, {
      config: {
        presence: {
          key: userId,
        },
      },
    });

    channel
      .on('presence', { event: 'sync' }, () => {
        const newState = channel.presenceState<PresenceState>();
        const users = Object.values(newState).flat();
        const uniqueUsers = Array.from(new Map(users.map(u => [u.user_id, u])).values());
        setOnlineUsers(uniqueUsers);
      })
      .subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          await channel.track({
            user_id: userId,
            nickname: nickname || 'Anonymous',
            online_at: new Date().toISOString(),
          });
        }
      });

    return () => {
      channel.unsubscribe();
    };
  }, [lobbyId, userId, nickname, supabase]); // [FIX] Added supabase dependency

  return { onlineUsers };
};

================================================================================
FILE: src\features\configure-lobby\model\config-schema.ts
================================================================================
import { z } from 'zod';
import { FactorSchema } from '@/entities/factor/model/types';

// Relaxed Candidate Schema for the Form (Handles empty strings from inputs)
const FormCandidateSchema = z.object({
  id: z.string().optional(),
  name: z.string().min(1, "Candidate Name is required"),
  description: z.string().optional().or(z.literal('')),
  image_url: z.string().optional().or(z.literal('')), // [FIX] Allow empty string
  static_values: z.record(z.string(), z.number()).optional()
});

export const SetupWizardSchema = z.object({
  lobby_name: z.string().min(3, "Lobby Name must be at least 3 chars").default("My Lobby"),
  settings: z.object({
    privacy: z.enum(['public', 'anonymous']),
    voting_scale: z.object({ max: z.number() }),
    factors: z.array(FactorSchema).min(1, "Add at least 1 criteria"),
  }),
  candidates: z.array(FormCandidateSchema).min(2, "Add at least 2 candidates"),
});

export type SetupWizardValues = z.infer<typeof SetupWizardSchema>;

================================================================================
FILE: src\features\configure-lobby\model\useLobbyConfig.ts
================================================================================
import { useState, useMemo, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { SetupWizardSchema, SetupWizardValues } from './config-schema';
import { createClient } from '@/shared/api/supabase';
import { toast } from 'sonner';
import { omit } from 'lodash'; 

export const useLobbyConfig = (lobbyId: string, onComplete: () => void) => {
  const [step, setStep] = useState<1 | 2 | 3>(1);
  const [isSaving, setIsSaving] = useState(false);
  const supabase = useMemo(() => createClient(), []);
  
  const DRAFT_KEY = `draft_${lobbyId}`;

  const form = useForm<SetupWizardValues>({
    resolver: zodResolver(SetupWizardSchema) as any,
    defaultValues: {
      lobby_name: "", 
      settings: {
        privacy: 'public',
        voting_scale: { max: 10 },
        factors: []
      },
      candidates: []
    },
    mode: 'onChange',
    shouldUnregister: false 
  });

  // 1. Load Draft
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const draft = localStorage.getItem(DRAFT_KEY);
      if (draft) {
        try {
          const parsed = JSON.parse(draft);
          form.reset(parsed);
          toast.info("Restored previous draft");
        } catch (e) {
          console.error("Failed to load draft", e);
        }
      }
    }
  }, [DRAFT_KEY, form]);

  // 2. Save Draft
  useEffect(() => {
    const subscription = form.watch((value) => {
      const safeData = JSON.parse(JSON.stringify(value));
      
      if (safeData.candidates) {
        safeData.candidates.forEach((c: any) => {
          if (c.image_url?.startsWith('data:')) c.image_url = null;
        });
      }
      if (safeData.settings?.factors) {
        safeData.settings.factors.forEach((f: any) => {
          if (f.image_url?.startsWith('data:')) f.image_url = null;
        });
      }

      localStorage.setItem(DRAFT_KEY, JSON.stringify(safeData));
    });
    return () => subscription.unsubscribe();
  }, [form, DRAFT_KEY]); // [FIX] Added form dependency

  const saveConfiguration = async (data: SetupWizardValues) => {
    setIsSaving(true);
    try {
      const { error: lobbyError } = await supabase
        .from('lobbies')
        .update({ 
          name: data.lobby_name,
          settings: data.settings, 
          status: 'voting' 
        })
        .eq('id', lobbyId);

      if (lobbyError) throw lobbyError;

      if (data.candidates.length > 0) {
        // First delete existing candidates to prevent duplicates (simple approach)
        await supabase.from('candidates').delete().eq('lobby_id', lobbyId);

        const cleanCandidates = data.candidates.map(c => ({
          lobby_id: lobbyId,
          name: c.name,
          description: c.description || '',
          image_url: c.image_url || null,
          static_values: c.static_values || {}
        }));

        const { error: candError } = await supabase
          .from('candidates')
          .insert(cleanCandidates);

        if (candError) throw candError;
      }

      localStorage.removeItem(DRAFT_KEY);
      toast.success("Lobby Configured!");
      onComplete();
    } catch (e) {
      console.error(e);
      toast.error("Failed to save configuration");
    } finally {
      setIsSaving(false);
    }
  };

  return {
    step,
    setStep,
    form,
    isSaving,
    saveConfiguration
  };
};

================================================================================
FILE: src\features\configure-lobby\ui\ConfigForm.tsx
================================================================================
import React from 'react';
import { useTranslations } from 'next-intl';
import { useLobbyConfig } from '../model/useLobbyConfig';
import { Button } from '@/shared/ui/button';
import { Input } from '@/shared/ui/input';
import { ImagePicker } from '@/shared/ui/image-picker';
import { CustomSelect } from '@/shared/ui/custom-select'; // [NEW]
import { CustomToggle } from '@/shared/ui/custom-toggle'; // [NEW]
import { useFieldArray, Controller } from 'react-hook-form';
import { ArrowRight, ArrowLeft, Trash2, Plus, CheckCircle, Info } from 'lucide-react';
import { toast } from 'sonner';

export const ConfigForm = ({ lobbyId, onSuccess }: { lobbyId: string, onSuccess: () => void }) => {
  const t = useTranslations('Setup');
  const tCommon = useTranslations('Common');
  
  const { step, setStep, form, isSaving, saveConfiguration } = useLobbyConfig(lobbyId, onSuccess);
  const { register, control, handleSubmit, watch, setValue, formState: { errors } } = form;
  
  const candidatesField = useFieldArray({ control, name: "candidates" });
  const factorsField = useFieldArray({ control, name: "settings.factors" });
  
  const currentFactors = watch("settings.factors");
  const constantFactors = currentFactors?.filter(f => f.type === 'constant') || [];

  const onSubmit = (data: any) => saveConfiguration(data);

  const onError = (errors: any) => {
    console.error("Form Validation Errors:", errors);
    toast.error(t('validation_error'));
  };

  const toggleDisabledCandidate = (factorIndex: number, candidateId: string) => {
    const current = factorsField.fields[factorIndex].disabled_candidates || [];
    const newSet = new Set(current);
    if (newSet.has(candidateId)) newSet.delete(candidateId);
    else newSet.add(candidateId);
    setValue(`settings.factors.${factorIndex}.disabled_candidates`, Array.from(newSet));
  };

  return (
    <div className="space-y-8 max-w-5xl mx-auto pb-32">
      
      {/* Step Progress */}
      <div className="flex justify-center gap-3 mb-10">
        {[1, 2, 3].map(s => (
          <div key={s} className={`h-1.5 flex-1 rounded-full transition-all duration-500 ${step >= s ? 'bg-gradient-to-r from-indigo-500 to-purple-500 shadow-lg shadow-purple-900/50' : 'bg-gray-800'}`} />
        ))}
      </div>

      {/* --- STEP 1: CANDIDATES --- */}
      {step === 1 && (
        <div className="space-y-6 animate-in slide-in-from-right-8 duration-500">
          <div className="text-center mb-8">
             <h3 className="text-3xl font-black text-white tracking-tight">{t('step_1')}</h3>
             <p className="text-gray-400 text-sm mt-1">{t('add_candidate_desc')}</p>
          </div>
          
          <div className="grid lg:grid-cols-2 gap-6">
            {candidatesField.fields.map((field, index) => (
              <div key={field.id} className="glass-card p-5 relative group border-t-4 border-t-indigo-500/50 hover:border-indigo-500 transition-colors">
                <button 
                    onClick={() => candidatesField.remove(index)} 
                    className="absolute top-4 right-4 text-gray-600 hover:text-red-400 bg-black/40 p-2 rounded-lg transition-colors z-10 opacity-0 group-hover:opacity-100"
                >
                    <Trash2 size={16} />
                </button>

                <div className="flex gap-5 items-start">
                    <div className="shrink-0 w-24">
                        <Controller
                            control={control}
                            name={`candidates.${index}.image_url`}
                            render={({ field: { value, onChange } }) => (
                                <ImagePicker value={value || null} onChange={onChange} className="w-24 h-24 rounded-xl" />
                            )}
                        />
                    </div>
                    <div className="flex-1 space-y-4">
                        <Input 
                            placeholder={t('placeholder_name')} 
                            {...register(`candidates.${index}.name`)} 
                            className="glass-input font-bold text-lg" 
                        />
                        <div className="relative">
                            <textarea 
                                placeholder="Description / Tagline..." 
                                {...register(`candidates.${index}.description`)}
                                className="w-full h-20 glass-input resize-none py-2 text-xs leading-relaxed"
                            />
                        </div>
                    </div>
                </div>
              </div>
            ))}
            
            <button 
                onClick={() => candidatesField.append({ name: "", id: crypto.randomUUID() } as any)}
                className="glass-card flex flex-col items-center justify-center gap-4 min-h-[200px] border-dashed border-2 border-gray-700 hover:border-indigo-500/50 hover:bg-indigo-500/5 transition-all text-gray-500 hover:text-white group cursor-pointer"
            >
                <div className="w-14 h-14 rounded-full bg-gray-800 group-hover:bg-indigo-600 flex items-center justify-center transition-colors shadow-lg">
                    <Plus size={28} />
                </div>
                <span className="font-bold text-sm tracking-widest uppercase">{t('add_candidate_btn')}</span>
            </button>
          </div>
          {errors.candidates && <p className="text-red-400 text-center bg-red-900/10 p-2 rounded">{errors.candidates.message}</p>}
        </div>
      )}

      {/* --- STEP 2: FACTORS --- */}
      {step === 2 && (
        <div className="space-y-6 animate-in slide-in-from-right-8 duration-500">
          <div className="text-center mb-8">
             <h3 className="text-3xl font-black text-white tracking-tight">{t('step_2')}</h3>
             <p className="text-gray-400 text-sm mt-1">{t('add_factor_desc')}</p>
          </div>

          <div className="space-y-4">
            {factorsField.fields.map((field, index) => (
               <div key={field.id} className="glass-card p-6 relative group">
                  <button onClick={() => factorsField.remove(index)} className="absolute top-4 right-4 text-gray-600 hover:text-red-400 p-2 bg-black/40 rounded-lg z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                    <Trash2 size={16} />
                  </button>

                  <div className="flex gap-6 items-start">
                    <div className="shrink-0 pt-1">
                        <Controller
                            control={control}
                            name={`settings.factors.${index}.image_url`}
                            render={({ field: { value, onChange } }) => (
                                <ImagePicker value={value || null} onChange={onChange} className="w-16 h-16 rounded-xl" />
                            )}
                        />
                    </div>
                    
                    <div className="flex-1 space-y-5">
                        <div className="grid md:grid-cols-2 gap-4">
                            <Input placeholder="Criteria Name (e.g. Taste)" {...register(`settings.factors.${index}.name`)} className="glass-input font-bold" />
                            <Input placeholder="Description..." {...register(`settings.factors.${index}.description`)} className="glass-input text-sm" />
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 bg-black/20 p-4 rounded-xl border border-white/5">
                            <CustomSelect 
                                label={t('type_label')}
                                {...register(`settings.factors.${index}.type`)}
                                options={[
                                    { label: t('types.numerical'), value: 'numerical' },
                                    { label: t('types.constant'), value: 'constant' }
                                ]}
                            />
                            
                            {watch(`settings.factors.${index}.type`) === 'numerical' && (
                                <>
                                    <CustomSelect 
                                        label={t('control_label')}
                                        {...register(`settings.factors.${index}.input_control`)}
                                        options={[
                                            { label: t('controls.slider'), value: 'slider' },
                                            { label: t('controls.stars'), value: 'stars' },
                                            { label: t('controls.number'), value: 'number' },
                                            { label: t('controls.toggle'), value: 'toggle' }
                                        ]}
                                    />

                                    <div>
                                        <label className="text-[10px] uppercase text-gray-500 font-bold mb-1 block">{t('decimal_allowed')}</label>
                                        <Controller
                                            control={control}
                                            name={`settings.factors.${index}.step`}
                                            render={({ field: { value, onChange } }) => (
                                                <CustomToggle 
                                                    checked={value === 0.1}
                                                    onChange={(checked) => onChange(checked ? 0.1 : 1)}
                                                />
                                            )}
                                        />
                                    </div>
                                </>
                            )}

                            <div>
                                <label className="text-[10px] uppercase text-gray-500 font-bold mb-2 block">{t('weight_label')}</label>
                                <input 
                                    type="number" 
                                    step="0.1" 
                                    {...register(`settings.factors.${index}.weight`, { valueAsNumber: true })} 
                                    className="w-full bg-black/40 border border-white/10 rounded-xl px-2 py-2.5 text-sm text-center font-mono focus:border-indigo-500 outline-none" 
                                />
                            </div>
                        </div>

                        {/* Disable For Selector */}
                        {watch(`settings.factors.${index}.type`) === 'numerical' && (
                            <div className="border-t border-white/5 pt-3">
                                <label className="text-[10px] uppercase text-gray-500 font-bold mb-2 block flex items-center gap-1">
                                    {t('disable_for')}
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    {candidatesField.fields.map((cand) => {
                                        const disabledList = watch(`settings.factors.${index}.disabled_candidates`) || [];
                                        const isDisabled = disabledList.includes(cand.id);
                                        return (
                                            <button
                                                key={cand.id}
                                                type="button"
                                                onClick={() => toggleDisabledCandidate(index, cand.id)}
                                                className={`
                                                    px-3 py-1.5 rounded-lg text-xs font-bold transition-all border
                                                    ${isDisabled 
                                                        ? 'bg-red-500/10 border-red-500/50 text-red-400' 
                                                        : 'bg-black/40 border-transparent text-gray-400 hover:bg-white/5'
                                                    }
                                                `}
                                            >
                                                {cand.name || "Unnamed"}
                                            </button>
                                        );
                                    })}
                                    {candidatesField.fields.length === 0 && <span className="text-xs text-gray-600 italic">{t('add_candidates_first')}</span>}
                                </div>
                            </div>
                        )}
                    </div>
                  </div>
               </div>
            ))}
          </div>

          <Button 
            variant="secondary" 
            onClick={() => factorsField.append({ id: crypto.randomUUID(), name: "", weight: 1, type: 'numerical', input_control: 'slider', trend: 'higher_better', is_hidden: false, step: 1, disabled_candidates: [] } as any)}
            className="w-full py-6 border-dashed border-2 border-gray-700 hover:border-indigo-500/50 text-gray-400 hover:text-white bg-transparent hover:bg-indigo-500/5 transition-all"
          >
            <Plus size={20} /> {t('add_factor')}
          </Button>
        </div>
      )}

      {/* --- STEP 3: REVIEW & SETTINGS --- */}
      {step === 3 && (
        <div className="space-y-8 animate-in slide-in-from-right-8 duration-500">
          <div className="glass-card p-8 max-w-2xl mx-auto text-center border-t-4 border-t-green-500/50">
            <CheckCircle size={48} className="mx-auto mb-6 text-green-400" />
            <h3 className="text-3xl font-black mb-8">{t('step_3')}</h3>
            
            <div className="space-y-8 text-left">
              <Input 
                  label={t('lobby_name')} 
                  placeholder={t('lobby_name_ph')}
                  {...register("lobby_name")} 
                  className="glass-input text-xl font-bold text-center h-14"
              />

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                  <div className="space-y-2">
                      <label className="text-xs font-bold text-gray-500 uppercase ml-1 block">{t('privacy_label')}</label>
                      <div className="flex bg-black/40 p-1 rounded-xl">
                        {['public', 'anonymous'].map((mode) => (
                          <label key={mode} className={`flex-1 text-center py-3 rounded-lg cursor-pointer transition-all ${watch('settings.privacy') === mode ? 'bg-indigo-600 text-white shadow-lg font-bold' : 'text-gray-400 hover:bg-white/5'}`}>
                            <input type="radio" value={mode} {...register('settings.privacy')} className="hidden" />
                            <span className="capitalize text-sm">{mode === 'public' ? t('privacy_public') : t('privacy_anon')}</span>
                          </label>
                        ))}
                      </div>
                  </div>
                  
                  <div className="space-y-2">
                        <Input 
                            label={t('max_scale')} 
                            type="number" 
                            {...register("settings.voting_scale.max", { valueAsNumber: true })} 
                            className="glass-input text-center font-mono"
                        />
                        <p className="text-[10px] text-gray-500 text-center">{t('max_scale_desc')}</p>
                  </div>
              </div>
            </div>
          </div>

          {/* STATIC VALUES INPUT */}
          {constantFactors.length > 0 && (
            <div className="glass-card p-6 border-t-4 border-t-yellow-500/50 max-w-4xl mx-auto">
                <h4 className="text-lg font-bold mb-4 flex items-center gap-2 text-yellow-100">
                    <Info size={18} className="text-yellow-500" />
                    {t('static_info_label')}
                </h4>
                <div className="space-y-3">
                    {candidatesField.fields.map((cand, idx) => (
                        <div key={cand.id} className="grid grid-cols-12 gap-4 items-center bg-black/20 p-3 rounded-xl border border-white/5">
                            <div className="col-span-4 font-bold text-sm truncate px-2">{cand.name}</div>
                            <div className="col-span-8 grid gap-2">
                                {constantFactors.map(cf => (
                                    <div key={cf.id} className="flex items-center gap-2">
                                        <span className="text-[10px] uppercase text-gray-500 w-1/3 text-right truncate">{cf.name}:</span>
                                        <input 
                                            type="number" 
                                            step="any" 
                                            placeholder="-"
                                            {...register(`candidates.${idx}.static_values.${cf.id}`, { valueAsNumber: true })}
                                            className="flex-1 bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-yellow-500/50 outline-none text-right font-mono"
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          )}
        </div>
      )}

      {/* --- FOOTER --- */}
      <div className="fixed bottom-0 left-0 w-full bg-[#030712]/90 backdrop-blur-xl border-t border-white/10 p-4 md:p-6 z-40">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
            <Button variant="ghost" disabled={step === 1} onClick={() => setStep(prev => prev - 1 as any)} className="text-gray-400 hover:text-white">
                <ArrowLeft size={18} /> {tCommon('back')}
            </Button>
            
            {step < 3 ? (
                <Button onClick={() => setStep(prev => prev + 1 as any)} className="btn-primary px-8">
                    {tCommon('next')} <ArrowRight size={18} className="ml-2" />
                </Button>
            ) : (
                <Button 
                  onClick={handleSubmit(onSubmit, onError)} 
                  isLoading={isSaving} 
                  className="btn-primary bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 shadow-green-900/30 px-12 py-4 text-lg"
                >
                    {t('launch')}
                </Button>
            )}
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: src\features\session-auth\model\useSessionAuth.ts
================================================================================
import { useState, useEffect, useMemo } from 'react';
import { createClient } from '@/shared/api/supabase';
import { User } from '@supabase/supabase-js';

export const useSessionAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  
  // [FIX] Memoize client
  const supabase = useMemo(() => createClient(), []);

  useEffect(() => {
    const initAuth = async () => {
      const { data: { user: existingUser } } = await supabase.auth.getUser();
      
      if (existingUser) {
        setUser(existingUser);
      } else {
        const { data: { user: anonUser }, error } = await supabase.auth.signInAnonymously();
        if (!error && anonUser) {
          setUser(anonUser);
        }
      }
      setLoading(false);
    };

    initAuth();

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, [supabase]); // [FIX] Added dependency

  return { user, loading };
};

================================================================================
FILE: src\features\session-auth\ui\ProfileSetup.tsx
================================================================================
'use client'
import { useState, useRef } from 'react';
import { createClient } from '@/shared/api/supabase';
import { Button } from '@/shared/ui/button';
import { Input } from '@/shared/ui/input';
// [FIX] Updated import to ImagePicker
import { ImagePicker } from '@/shared/ui/image-picker';
import { useTranslations } from 'next-intl';
import { Upload, RefreshCw, X, Camera } from 'lucide-react';
import Image from 'next/image';

interface ProfileSetupProps {
  userId: string;
  onComplete: () => void;
}

export const ProfileSetup = ({ userId, onComplete }: ProfileSetupProps) => {
  const t = useTranslations('Profile');
  const tCommon = useTranslations('Common');
  
  const [nickname, setNickname] = useState('');
  const [avatarUrl, setAvatarUrl] = useState<string | null>(`https://api.dicebear.com/9.x/avataaars/svg?seed=${userId}`);
  const [loading, setLoading] = useState(false);
  const supabase = createClient();

  const handleSave = async () => {
    if (!nickname.trim()) return;
    setLoading(true);
    
    await supabase.auth.updateUser({
      data: { nickname, avatar_url: avatarUrl }
    });
    
    setLoading(false);
    onComplete();
  };

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-[#030712] p-4">
      <div className="glass-card w-full max-w-md p-8 flex flex-col items-center gap-10 animate-in zoom-in-95 duration-500 border border-indigo-500/20 shadow-[0_0_100px_rgba(79,70,229,0.1)]">
        
        <div className="text-center space-y-2">
          <h2 className="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-b from-white to-gray-500 tracking-tighter">
            {t('title')}
          </h2>
          <p className="text-gray-400 text-sm font-medium">{t('subtitle')}</p>
        </div>

        {/* Using the new ImagePicker for consistency */}
        <div className="w-40 h-40">
            <ImagePicker 
                value={avatarUrl} 
                onChange={setAvatarUrl} 
                allowShuffle={true} 
                seed={userId}
                className="w-full h-full rounded-full border-4 border-indigo-500/30 shadow-2xl" 
            />
        </div>

        <div className="w-full space-y-6 mt-4">
          <Input 
            placeholder={tCommon('placeholder_name')} 
            value={nickname} 
            onChange={(e) => setNickname(e.target.value)}
            className="text-center font-bold text-2xl bg-transparent border-0 border-b-2 border-gray-800 focus:border-indigo-500 rounded-none px-0 py-2 focus:ring-0 placeholder:text-gray-700 transition-colors"
            autoFocus
          />

          <Button 
            onClick={handleSave} 
            disabled={!nickname.trim() || loading} 
            className="w-full btn-primary py-4 text-lg shadow-indigo-500/20"
          >
            {loading ? tCommon('loading') : tCommon('next')}
          </Button>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: src\features\share-lobby\ui\ShareButton.tsx
================================================================================
'use client'
import { useState } from 'react';
import { QRCodeSVG } from 'qrcode.react';
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';
import { Modal } from '@/shared/ui/modal';
import { Button } from '@/shared/ui/button';

export const ShareButton = ({ code }: { code: string }) => {
  const t = useTranslations('Share');
  const [isOpen, setIsOpen] = useState(false);
  
  const getUrl = () => {
    if (typeof window === 'undefined') return '';
    return `${window.location.origin}/lobby/${code}`;
  };

  const handleCopy = () => {
    navigator.clipboard.writeText(getUrl());
    toast.success(t('copied'));
  };

  return (
    <>
      <Button variant="secondary" onClick={() => setIsOpen(true)} className="px-3">
        {t('invite')}
      </Button>

      <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title={t('invite')}>
        <div className="flex flex-col items-center gap-6 p-4">
          <div className="bg-white p-4 rounded-xl">
            <QRCodeSVG value={getUrl()} size={200} />
          </div>
          
          <div className="text-center">
            <p className="text-xs text-gray-500 uppercase font-bold mb-2">{t('label_code')}</p>
            <p className="text-4xl font-mono font-black tracking-widest">{code}</p>
          </div>

          <Button onClick={handleCopy} className="w-full">
            {t('copy')}
          </Button>
        </div>
      </Modal>
    </>
  );
};

================================================================================
FILE: src\i18n\request.ts
================================================================================
import { getRequestConfig } from 'next-intl/server';
import { routing } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  // 1. Await the locale promise
  let locale = await requestLocale;

  // 2. Validate the locale. If invalid (or undefined), fallback to default.
  // We cast 'as any' to avoid strict string literal checks against the routing array.
  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale;
  }

  return {
    // [FIX] You must return the valid locale here
    locale,
    // 3. Load the corresponding message file
    messages: (await import(`../../messages/${locale}.json`)).default
  };
});

================================================================================
FILE: src\i18n\routing.ts
================================================================================
import { defineRouting } from 'next-intl/routing';
import { createNavigation } from 'next-intl/navigation';

export const routing = defineRouting({
  // A list of all locales that are supported
  locales: ['en', 'it'],
 
  // Used when no locale matches
  defaultLocale: 'en'
});

// Lightweight wrappers around Next.js' navigation APIs
// that will consider the routing configuration
export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);

================================================================================
FILE: src\processes\lobby-flow\model.ts
================================================================================
import { useState, useEffect, useMemo, useCallback } from 'react';
import { createClient } from '@/shared/api/supabase';
import { Lobby, LobbyStatus } from '@/entities/lobby/model/types';
import { Candidate } from '@/entities/candidate/model/types';
import { Participant } from '@/entities/participant/model/types';
import { toast } from 'sonner';

export const useLobbyState = (initialLobbyId: string) => {
  const [lobby, setLobby] = useState<Lobby | null>(null);
  const [candidates, setCandidates] = useState<Candidate[]>([]);
  const [participants, setParticipants] = useState<Participant[]>([]);
  const [votes, setVotes] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  const supabase = useMemo(() => createClient(), []);

  // Fetchers
  const fetchCandidates = useCallback(async () => {
    const { data } = await supabase.from('candidates').select('*').eq('lobby_id', initialLobbyId);
    if (data) setCandidates(data);
  }, [initialLobbyId, supabase]);

  const fetchParticipants = useCallback(async () => {
    const { data } = await supabase.rpc('get_secure_participants', { target_lobby_id: initialLobbyId });
    if (data) setParticipants(data as unknown as Participant[]);
  }, [initialLobbyId, supabase]);

  const fetchVotes = useCallback(async () => {
    const { data } = await supabase.from('votes').select('*').eq('lobby_id', initialLobbyId);
    setVotes(data || []);
  }, [initialLobbyId, supabase]);

  // [NEW] Manual State Updater (Optimistic UI)
  const updateLocalStatus = (newStatus: LobbyStatus) => {
    if (lobby) {
      setLobby({ ...lobby, status: newStatus });
      // If entering voting, ensure candidates are ready
      if (newStatus === 'voting') fetchCandidates();
      // If entering results, ensure votes are ready
      if (newStatus === 'ended') fetchVotes();
    }
  };

  useEffect(() => {
    const fetchData = async () => {
      const { data: lobbyData, error } = await supabase.from('lobbies').select('*').eq('id', initialLobbyId).single();
      if (error || !lobbyData) { toast.error("Lobby not found"); return; }
      
      setLobby(lobbyData);

      if (lobbyData.status !== 'waiting') await fetchCandidates();
      await fetchParticipants();
      if (lobbyData.status === 'ended') await fetchVotes();
      
      setLoading(false);
    };

    fetchData();

    // Realtime Subscriptions
    const lobbyChannel = supabase.channel(`lobby_main:${initialLobbyId}`)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'lobbies', filter: `id=eq.${initialLobbyId}` },
        (payload) => {
          const newLobby = payload.new as Lobby;
          setLobby(newLobby);
          
          // React to status changes from OTHER users/devices
          if (payload.old.status !== 'voting' && newLobby.status === 'voting') fetchCandidates();
          if (newLobby.status === 'ended') fetchVotes();
        }
      )
      .subscribe();

    const candidateChannel = supabase.channel(`lobby_cands:${initialLobbyId}`)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'candidates', filter: `lobby_id=eq.${initialLobbyId}` },
        () => fetchCandidates()
      )
      .subscribe();

    const partsChannel = supabase.channel(`lobby_parts:${initialLobbyId}`)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'lobby_participants', filter: `lobby_id=eq.${initialLobbyId}` },
        () => fetchParticipants()
      )
      .subscribe();

    const voteChannel = supabase.channel(`lobby_votes:${initialLobbyId}`)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'votes', filter: `lobby_id=eq.${initialLobbyId}` },
        () => {
            if (lobby?.status === 'ended') fetchVotes();
        }
      )
      .subscribe();

    return () => { 
      supabase.removeChannel(lobbyChannel); 
      supabase.removeChannel(candidateChannel);
      supabase.removeChannel(partsChannel);
      supabase.removeChannel(voteChannel);
    };
  }, [initialLobbyId, supabase, fetchCandidates, fetchParticipants, fetchVotes, lobby?.status]);

  return { lobby, candidates, participants, votes, loading, updateLocalStatus, refreshCandidates: fetchCandidates };
};

================================================================================
FILE: src\processes\lobby-flow\ui.tsx
================================================================================
import React from 'react';

interface LobbyFlowLayoutProps {
  children: React.ReactNode;
  status: 'waiting' | 'setup' | 'voting' | 'ended';
}

export const LobbyFlowLayout = ({ children, status }: LobbyFlowLayoutProps) => {
  // Dynamic background based on status
  const getBackground = () => {
    switch (status) {
      case 'waiting': return 'bg-gray-950'; // Plain dark
      case 'setup': return 'bg-gray-950';
      case 'voting': return 'bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/20 via-gray-950 to-gray-950'; // Subtle glow
      case 'ended': return 'bg-gray-950'; 
      default: return 'bg-gray-950';
    }
  };

  return (
    <div className={`min-h-screen transition-colors duration-700 ${getBackground()} relative overflow-hidden`}>
      {/* Optional: Grid Background Pattern */}
      <div 
        className="absolute inset-0 opacity-[0.03] pointer-events-none"
        style={{ backgroundImage: `url("/grid.svg")` }} 
      />
      
      {/* Content Container */}
      <div className="relative z-10 w-full">
        {children}
      </div>
    </div>
  );
};

================================================================================
FILE: src\shared\api\supabase.ts
================================================================================
import { createBrowserClient } from '@supabase/ssr';

export const createClient = () => {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

  if (!supabaseUrl || !supabaseKey) {
    throw new Error("Missing Supabase Environment Variables");
  }

  return createBrowserClient(supabaseUrl, supabaseKey);
};

================================================================================
FILE: src\shared\config\constants.ts
================================================================================
export const CONSTANTS = {
  limits: {
    MAX_VOTE_SCALE: 100,
    MIN_VOTE_SCALE: 5,
    MAX_FILE_SIZE_MB: 2,
    LOBBY_CODE_LENGTH: 6,
  },
  colors: {
    primary: "indigo",
    success: "green",
    warning: "amber",
    danger: "red",
    background: "gray-950",
  },
  defaults: {
    LOCALE: 'en',
    AVATAR_API: "https://api.dicebear.com/9.x/avataaars/svg?seed=",
  }
} as const;

================================================================================
FILE: src\shared\lib\date-utils.ts
================================================================================
export const formatDate = (dateString: string, locale: string = 'en') => {
  return new Date(dateString).toLocaleDateString(locale, {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

export const timeAgo = (dateString: string) => {
  const seconds = Math.floor((new Date().getTime() - new Date(dateString).getTime()) / 1000);
  let interval = seconds / 31536000;

  if (interval > 1) return Math.floor(interval) + " years ago";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + " months ago";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + " days ago";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + " hours ago";
  return "Just now";
};

================================================================================
FILE: src\shared\lib\history-manager.ts
================================================================================
interface HistoryItem {
  code: string;
  name: string;
  lastVisited: string;
  role: 'host' | 'guest';
}

const KEY = 'did_history';

export const addToHistory = (item: Omit<HistoryItem, 'lastVisited'>) => {
  if (typeof window === 'undefined') return;
  
  const raw = localStorage.getItem(KEY);
  let history: HistoryItem[] = raw ? JSON.parse(raw) : [];
  
  // Remove duplicate if exists
  history = history.filter(h => h.code !== item.code);
  
  // Add to top
  history.unshift({ ...item, lastVisited: new Date().toISOString() });
  
  // Limit to 5
  localStorage.setItem(KEY, JSON.stringify(history.slice(0, 5)));
};

export const getHistory = (): HistoryItem[] => {
  if (typeof window === 'undefined') return [];
  const raw = localStorage.getItem(KEY);
  return raw ? JSON.parse(raw) : [];
};

export const clearHistory = () => {
  if (typeof window === 'undefined') return;
  localStorage.removeItem(KEY);
};

================================================================================
FILE: src\shared\lib\voting-math.ts
================================================================================
// --- Statistical Helpers ---
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
/**
 * Calculates Z-Score for a dataset.
 * Formula: Z = (x - mean) / stdDev
 * Returns array of 0s if stdDev is 0 (all votes identical).
 */
export const calculateZScores = (values: number[]): number[] => {
  if (values.length === 0) return [];
  
  const sum = values.reduce((a, b) => a + b, 0);
  const mean = sum / values.length;
  
  const squareDiffs = values.map(v => Math.pow(v - mean, 2));
  const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / values.length;
  const stdDev = Math.sqrt(avgSquareDiff);

  if (stdDev === 0) return values.map(() => 0);

  return values.map(v => (v - mean) / stdDev);
};

// --- Schulze Method (Beatpath) ---

/**
 * Computes the Schulze Method winner.
 * @param candidates Array of candidate IDs
 * @param ballots Array of ranked preferences (candidate IDs ordered best to worst)
 */
export const calculateSchulze = (candidates: string[], ballots: string[][]) => {
  const n = candidates.length;
  const idx = (id: string) => candidates.indexOf(id);
  
  // 1. Initialize Pairwise Matrix (d[i][j] = number of voters preferring i over j)
  const d: number[][] = Array(n).fill(0).map(() => Array(n).fill(0));

  ballots.forEach(ballot => {
    for (let i = 0; i < ballot.length; i++) {
      for (let j = i + 1; j < ballot.length; j++) {
        const winner = idx(ballot[i]);
        const loser = idx(ballot[j]);
        if (winner !== -1 && loser !== -1) d[winner][loser]++;
      }
      // Unranked candidates are assumed to lose against ranked ones
      for (let k = 0; k < n; k++) {
        const candidateId = candidates[k];
        if (!ballot.includes(candidateId)) {
            const winner = idx(ballot[i]);
            if(winner !== -1) d[winner][k]++;
        }
      }
    }
  });

  // 2. Initialize Path Strength Matrix (p)
  const p: number[][] = Array(n).fill(0).map(() => Array(n).fill(0));
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < n; j++) {
      if (i !== j) {
        p[i][j] = d[i][j] > d[j][i] ? d[i][j] : 0;
      }
    }
  }

  // 3. Floyd-Warshall Algorithm for Strongest Paths
  for (let k = 0; k < n; k++) {
    for (let i = 0; i < n; i++) {
      if (i !== k) {
        for (let j = 0; j < n; j++) {
          if (j !== k && i !== j) {
            p[i][j] = Math.max(p[i][j], Math.min(p[i][k], p[k][j]));
          }
        }
      }
    }
  }

  // 4. Determine Winners
  const wins: Record<string, number> = {};
  candidates.forEach(c => wins[c] = 0);

  for (let i = 0; i < n; i++) {
    for (let j = 0; j < n; j++) {
      if (i !== j && p[i][j] > p[j][i]) {
        wins[candidates[i]]++;
      }
    }
  }

  return {
    ranking: [...candidates].sort((a, b) => wins[b] - wins[a]),
    matrix: d,
    strongestPaths: p
  };
};

/**
 * Calculates a normalized score (0-100%) for a candidate, 
 * respecting weights and ignoring disabled factors (Nulls).
 */
export const calculateWeightedScore = (
  candidateId: string,
  votes: Record<string, number>, // FactorID -> Value
  factors: Factor[],
  maxScale: number
): number => {
  let totalScore = 0;
  let totalMaxPossible = 0;

  factors.forEach(factor => {
    // 1. Skip if Factor is disabled for this candidate (Null Factor Logic)
    if (factor.disabled_candidates?.includes(candidateId)) return;
    
    // 2. Skip if hidden or not numerical (visual only)
    if (factor.type !== 'numerical') return;

    let rawValue = votes[factor.id] ?? 0; // Default 0 if not voted
    const weight = Math.abs(factor.weight); // Magnitude of importance

    // Handle "Lower is Better" (Flip the value)
    if (factor.trend === 'lower_better') {
      rawValue = maxScale - rawValue;
    }

    totalScore += rawValue * weight;
    totalMaxPossible += maxScale * weight;
  });

  if (totalMaxPossible === 0) return 0;
  
  // Return percentage 0-100
  return (totalScore / totalMaxPossible) * 100;
};

================================================================================
FILE: src\shared\model\modal-store.ts
================================================================================
import { create } from 'zustand';
import { ReactNode } from 'react';

interface ModalState {
  isOpen: boolean;
  title: string | null;
  content: ReactNode | null;
  type: 'info' | 'confirm' | 'alert';
  onConfirm?: () => void;
  onCancel?: () => void;
  
  openModal: (opts: { 
    title: string; 
    content: ReactNode; 
    type?: 'info' | 'confirm' | 'alert';
    onConfirm?: () => void;
    onCancel?: () => void;
  }) => void;
  
  closeModal: () => void;
}

export const useModalStore = create<ModalState>((set) => ({
  isOpen: false,
  title: null,
  content: null,
  type: 'info',
  onConfirm: undefined,
  onCancel: undefined,

  openModal: (opts) => set({ 
    isOpen: true, 
    title: opts.title, 
    content: opts.content,
    type: opts.type || 'info',
    onConfirm: opts.onConfirm,
    onCancel: opts.onCancel
  }),

  closeModal: () => set({ isOpen: false, content: null, onConfirm: undefined })
}));

================================================================================
FILE: src\shared\ui\avatar-container.tsx
================================================================================
import Image from 'next/image';
import { User, Image as ImageIcon } from 'lucide-react';

interface AvatarContainerProps {
  src?: string | null;
  alt: string;
  size?: 'sm' | 'md' | 'lg' | 'xl';
  className?: string;
  seed?: string; // Fallback seed for dicebear
}

export const AvatarContainer = ({ src, alt, size = 'md', className = "", seed }: AvatarContainerProps) => {
  const sizes = {
    sm: "w-8 h-8",
    md: "w-12 h-12",
    lg: "w-20 h-20",
    xl: "w-32 h-32"
  };

  // Determine Source: Custom Upload -> DiceBear -> Placeholder
  const finalSrc = src 
    ? src 
    : (seed ? `https://api.dicebear.com/9.x/avataaars/svg?seed=${seed}` : null);

  return (
    <div className={`relative rounded-2xl overflow-hidden bg-gray-900 border border-white/10 shadow-inner flex items-center justify-center shrink-0 ${sizes[size]} ${className}`}>
      {finalSrc ? (
        <Image 
          src={finalSrc} 
          alt={alt} 
          fill 
          className="object-cover" 
          sizes="(max-width: 768px) 100vw, 33vw"
        />
      ) : (
        <User className="text-gray-600" />
      )}
    </div>
  );
};

================================================================================
FILE: src\shared\ui\button.tsx
================================================================================
import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'ghost';
  isLoading?: boolean;
}

export const Button = ({ 
  children, 
  variant = 'primary', 
  isLoading, 
  className = '', 
  disabled,
  ...props 
}: ButtonProps) => {
  
  const baseStyles = "px-6 py-3 rounded-xl font-bold transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
  
  const variants = {
    primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/20",
    secondary: "bg-gray-800 hover:bg-gray-700 text-white border border-gray-700",
    danger: "bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/20",
    ghost: "bg-transparent hover:bg-white/10 text-gray-400 hover:text-white",
  };

  return (
    <button 
      disabled={isLoading || disabled} 
      className={`${baseStyles} ${variants[variant]} ${className}`}
      {...props}
    >
      {isLoading ? (
        <span className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin" />
      ) : children}
    </button>
  );
};

================================================================================
FILE: src\shared\ui\custom-select.tsx
================================================================================
import { ChevronDown } from 'lucide-react';
import React from 'react';

interface Option {
  label: string;
  value: string | number;
}

interface CustomSelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  options: Option[];
}

export const CustomSelect = React.forwardRef<HTMLSelectElement, CustomSelectProps>(
  ({ label, options, className = '', ...props }, ref) => {
    return (
      <div className="w-full space-y-2">
        {label && (
          <label className="text-[10px] uppercase font-bold text-gray-500 tracking-wider ml-1">
            {label}
          </label>
        )}
        <div className="relative group">
          <select
            ref={ref}
            className={`
              w-full appearance-none bg-black/20 border border-white/10 rounded-xl px-4 py-3 pr-10
              text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500/50 
              focus:border-indigo-500/50 transition-all duration-300 cursor-pointer
              hover:bg-black/30 hover:border-white/20
              ${className}
            `}
            {...props}
          >
            {options.map((opt) => (
              <option key={opt.value} value={opt.value} className="bg-gray-900 text-gray-200">
                {opt.label}
              </option>
            ))}
          </select>
          <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500 group-hover:text-white transition-colors">
            <ChevronDown size={16} />
          </div>
        </div>
      </div>
    );
  }
);
CustomSelect.displayName = 'CustomSelect';

================================================================================
FILE: src\shared\ui\custom-toggle.tsx
================================================================================
import React from 'react';

interface CustomToggleProps {
  label?: string;
  checked: boolean;
  onChange: (checked: boolean) => void;
  className?: string;
}

export const CustomToggle = ({ label, checked, onChange, className = '' }: CustomToggleProps) => {
  return (
    <div className={`flex flex-col gap-2 ${className}`}>
      {label && (
        <label className="text-[10px] uppercase font-bold text-gray-500 tracking-wider ml-1">
          {label}
        </label>
      )}
      <button
        type="button"
        role="switch"
        aria-checked={checked}
        onClick={() => onChange(!checked)}
        className={`
          relative h-10 w-full rounded-xl border transition-all duration-300 flex items-center px-1
          ${checked 
            ? 'bg-indigo-600/20 border-indigo-500/50' 
            : 'bg-black/20 border-white/10 hover:border-white/20'
          }
        `}
      >
        <span className="sr-only">{label}</span>
        <span
          className={`
            inline-block h-8 w-1/2 rounded-lg bg-white shadow-lg ring-0 transition-transform duration-300 ease-out
            flex items-center justify-center text-[10px] font-black uppercase tracking-widest
            ${checked ? 'translate-x-[95%] bg-indigo-500 text-white' : 'translate-x-0 bg-gray-700 text-gray-300'}
          `}
        >
          {checked ? 'ON' : 'OFF'}
        </span>
      </button>
    </div>
  );
};

================================================================================
FILE: src\shared\ui\image-picker.tsx
================================================================================
'use client'
import { useState, useRef } from 'react';
import { Image as ImageIcon, Upload, X, RefreshCw } from 'lucide-react';
import Image from 'next/image';
import { useTranslations } from 'next-intl';

interface ImagePickerProps {
  value: string | null;
  onChange: (val: string | null) => void;
  allowShuffle?: boolean; // For Avatars
  seed?: string; // Seed for shuffle
  className?: string;
}

// [FIX] Renamed component to match import in ConfigForm
export const ImagePicker = ({ 
  value, 
  onChange, 
  allowShuffle, 
  seed,
  className = ""
}: ImagePickerProps) => {
  const t = useTranslations('Common');
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  // Local state for shuffle logic
  const [currentSeed, setCurrentSeed] = useState(seed || 'default');

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        onChange(reader.result as string); // Save as Base64
      };
      reader.readAsDataURL(file);
    }
    // Reset input value so same file can be selected again
    e.target.value = '';
  };

  const handleRemove = () => {
    onChange(null);
  };

  const handleShuffle = () => {
    const newSeed = Math.random().toString();
    setCurrentSeed(newSeed);
    if (allowShuffle) {
        onChange(`https://api.dicebear.com/9.x/avataaars/svg?seed=${newSeed}`);
    }
  };

  // Determine what to show
  const hasCustomImage = value && (value.startsWith('data:') || value.startsWith('http'));
  const displaySrc = hasCustomImage ? value : (allowShuffle ? `https://api.dicebear.com/9.x/avataaars/svg?seed=${currentSeed}` : null);

  return (
    <div className={`relative group ${className}`}>
      <div className="w-full h-full min-w-[3rem] min-h-[3rem] rounded-xl overflow-hidden bg-gray-900 border border-gray-700 shadow-inner flex items-center justify-center relative">
        {displaySrc ? (
          <Image src={displaySrc} alt="Preview" fill className="object-cover" />
        ) : (
          <ImageIcon className="text-gray-600" size={24} />
        )}
        
        {/* Overlay Actions */}
        <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 z-10">
          <button 
            onClick={() => fileInputRef.current?.click()}
            className="p-1.5 bg-indigo-600 rounded-full text-white hover:bg-indigo-500 transition-transform hover:scale-110"
            title={t('upload_image')}
            type="button"
          >
            <Upload size={14} />
          </button>
          
          {allowShuffle && (
            <button 
                onClick={handleShuffle}
                className="p-1.5 bg-gray-700 rounded-full text-white hover:bg-gray-600 transition-transform hover:scale-110"
                title={t('shuffle')}
                type="button"
            >
                <RefreshCw size={14} />
            </button>
          )}

          {displaySrc && (
            <button 
                onClick={handleRemove}
                className="p-1.5 bg-red-600 rounded-full text-white hover:bg-red-500 transition-transform hover:scale-110"
                title={t('remove_image')}
                type="button"
            >
                <X size={14} />
            </button>
          )}
        </div>
      </div>

      <input 
        type="file" 
        ref={fileInputRef} 
        onChange={handleFileChange} 
        className="hidden" 
        accept="image/*"
      />
    </div>
  );
};

================================================================================
FILE: src\shared\ui\input.tsx
================================================================================
import React from 'react';

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
}

export const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ label, error, className = '', ...props }, ref) => {
    return (
      <div className="w-full space-y-2">
        {label && (
          <label className="text-xs font-bold uppercase text-gray-500 tracking-wider ml-1">
            {label}
          </label>
        )}
        <input
          ref={ref}
          suppressHydrationWarning // [FIX] Ignores browser extension injections
          className={`w-full bg-gray-950 border ${error ? 'border-red-500' : 'border-gray-800'} rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all placeholder:text-gray-700 ${className}`}
          {...props}
        />
        {error && <p className="text-red-400 text-xs ml-1">{error}</p>}
      </div>
    );
  }
);
Input.displayName = 'Input';

================================================================================
FILE: src\shared\ui\modal\GlobalModalWrapper.tsx
================================================================================
'use client'
import { useModalStore } from '@/shared/model/modal-store';
import { Modal } from '@/shared/ui/modal';
import { Button } from '@/shared/ui/button';
import { useTranslations } from 'next-intl';

export const GlobalModalWrapper = () => {
  const { isOpen, title, content, type, onConfirm, closeModal } = useModalStore();
  const t = useTranslations('Modals');

  if (!isOpen) return null;

  const handleConfirm = () => {
    if (onConfirm) onConfirm();
    closeModal();
  };

  return (
    <Modal isOpen={isOpen} onClose={closeModal} title={title || ""}>
      <div className="space-y-6">
        <div className="text-gray-300 leading-relaxed">
          {content}
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t border-gray-800">
          {type === 'confirm' && (
            <Button variant="ghost" onClick={closeModal}>
              {t('cancel_btn')}
            </Button>
          )}
          <Button 
            variant={type === 'alert' ? 'danger' : 'primary'} 
            onClick={handleConfirm}
          >
            {type === 'confirm' ? t('confirm_btn') : t('close')}
          </Button>
        </div>
      </div>
    </Modal>
  );
}; 

================================================================================
FILE: src\shared\ui\modal.tsx
================================================================================
'use client'
import { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { X } from 'lucide-react';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  children: React.ReactNode;
}

export const Modal = ({ isOpen, onClose, title, children }: ModalProps) => {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [onClose]);

  if (!mounted || !isOpen || typeof document === 'undefined') return null;

  return createPortal(
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="relative w-full max-w-lg bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl animate-in zoom-in-95 duration-200">
        <div className="flex items-center justify-between p-6 border-b border-gray-800">
          <h2 className="text-xl font-bold text-white">{title}</h2>
          <button onClick={onClose} className="p-2 text-gray-400 hover:text-white rounded-full">
            <X size={20} />
          </button>
        </div>
        <div className="p-6 max-h-[80vh] overflow-y-auto">
          {children}
        </div>
      </div>
    </div>,
    document.body
  );
};

================================================================================
FILE: src\shared\ui\smart-entity\index.tsx
================================================================================
import React from 'react';
import Image from 'next/image'; // [FIX]
import { CONSTANTS } from '@/shared/config/constants';

interface SmartEntityProps {
  label: string;
  imageUrl?: string | null;
  seed: string;
  isMasked?: boolean;
  fallbackLabel?: string;
  className?: string;
}

export const SmartEntity = ({
  label,
  imageUrl,
  seed,
  isMasked = false,
  fallbackLabel = "Anonymous",
  className = ""
}: SmartEntityProps) => {
  
  const displayLabel = isMasked ? fallbackLabel : label;
  const shouldUseRealImage = !isMasked && imageUrl;
  
  const avatarSrc = shouldUseRealImage 
    ? imageUrl!
    : `${CONSTANTS.defaults.AVATAR_API}${seed}`;

  return (
    <div className={`flex items-center gap-3 ${className}`}>
      <div className="relative w-10 h-10 rounded-full overflow-hidden bg-gray-800 border border-gray-700 shrink-0">
        <Image 
          src={avatarSrc} 
          alt={displayLabel} 
          fill
          sizes="40px"
          className="object-cover"
        />
      </div>
      <span className={`font-medium truncate ${isMasked ? "italic opacity-60" : "text-gray-200"}`}>
        {displayLabel}
      </span>
    </div>
  );
};

================================================================================
FILE: src\shared\ui\tooltip.tsx
================================================================================
'use client'
import * as TooltipPrimitive from '@radix-ui/react-tooltip';
import { useTranslations } from 'next-intl';

interface SmartTooltipProps {
  children: React.ReactNode;
  content?: string | null;
  side?: 'top' | 'bottom' | 'left' | 'right';
}

export const SmartTooltip = ({ children, content, side = 'top' }: SmartTooltipProps) => {
  const t = useTranslations('Tooltips');
  
  if (!content) return <>{children}</>;

  return (
    <TooltipPrimitive.Provider delayDuration={300}>
      <TooltipPrimitive.Root>
        <TooltipPrimitive.Trigger asChild>
          <span className="cursor-help">{children}</span>
        </TooltipPrimitive.Trigger>
        <TooltipPrimitive.Portal>
          <TooltipPrimitive.Content
            side={side}
            sideOffset={5}
            className="z-50 max-w-xs rounded-lg bg-gray-900 px-3 py-2 text-xs text-gray-200 border border-gray-700 shadow-xl animate-in fade-in zoom-in-95"
          >
            <span className="font-bold text-indigo-400">{t('desc_prefix')}</span>
            {content}
            <TooltipPrimitive.Arrow className="fill-gray-900" />
          </TooltipPrimitive.Content>
        </TooltipPrimitive.Portal>
      </TooltipPrimitive.Root>
    </TooltipPrimitive.Provider>
  );
};

================================================================================
FILE: src\views\home\ui\HomePage.tsx
================================================================================
'use client'
import { useState, useEffect } from 'react';
import { useRouter } from '@/i18n/routing';
import { useTranslations } from 'next-intl';
import { createClient } from '@/shared/api/supabase';
import { Button } from '@/shared/ui/button';
import { Input } from '@/shared/ui/input';
import { AuthForm } from '@/features/auth/ui/AuthForm';
import { ArrowRight, Clock, Plus, Play } from 'lucide-react';
import { useSessionAuth } from '@/features/session-auth/model/useSessionAuth';
import { ProfileEditor } from '@/widgets/user-dashboard/ui/ProfileEditor';

export const HomePage = () => {
  const t = useTranslations('Home');
  const tDash = useTranslations('Dashboard');
  const router = useRouter();
  const supabase = createClient();
  const { user } = useSessionAuth();
  
  const [joinCode, setJoinCode] = useState('');
  const [myLobbies, setMyLobbies] = useState<any[]>([]);
  const [isCreating, setIsCreating] = useState(false);

  // Fetch User's Lobbies (Correct Join Query)
  useEffect(() => {
    if (user && !user.is_anonymous) {
      const fetchLobbies = async () => {
        const { data, error } = await supabase
            .from('lobby_participants')
            .select(`
                lobby_id,
                last_seen_at,
                lobbies (
                    id, code, name, host_id, status
                )
            `)
            .eq('user_id', user.id)
            .order('last_seen_at', { ascending: false })
            .limit(10);

        if (!error && data) {
            // Flatten structure
            const lobbies = data
                .map((row: any) => row.lobbies)
                .filter((l: any) => l !== null); // Filter out deleted lobbies
            setMyLobbies(lobbies);
        }
      };
      fetchLobbies();
    }
  }, [user, supabase]);

  const handleCreate = async () => {
    if (!user) return; 
    setIsCreating(true);
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    
    const { data } = await supabase.from('lobbies').insert({
        code,
        host_id: user.id,
        name: "Untitled Lobby",
        settings: { factors: [] }
    }).select('code').single();
    
    if (data) router.push(`/lobby/${data.code}`);
    setIsCreating(false);
  };

  const handleJoin = () => {
    if (joinCode.length < 4) return;
    router.push(`/lobby/${joinCode.toUpperCase()}`);
  };

  // --- GUEST VIEW ---
  if (!user || user.is_anonymous) {
    return (
      <div className="min-h-screen flex items-center justify-center p-4 bg-[#030712] relative overflow-hidden">
        <div className="absolute inset-0 bg-[url('/grid.svg')] opacity-[0.03]" />
        <div className="w-full max-w-md space-y-8 relative z-10">
          <div className="text-center space-y-4">
            <h1 className="text-6xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-b from-white to-gray-600">
              {t('title')}
            </h1>
            <p className="text-gray-400 text-lg">{t('subtitle')}</p>
          </div>
          <AuthForm onSuccess={() => window.location.reload()} />
        </div>
      </div>
    );
  }

  // --- DASHBOARD VIEW ---
  return (
    <div className="min-h-screen p-4 md:p-8 bg-[#030712] text-white">
      <div className="max-w-7xl mx-auto grid lg:grid-cols-12 gap-8">
        
        {/* LEFT COL: Profile & Actions (4 cols) */}
        <div className="lg:col-span-4 space-y-8">
            <ProfileEditor user={user} />
            
            <div className="glass-card p-6 space-y-6">
                <Button onClick={handleCreate} isLoading={isCreating} className="w-full py-4 text-lg btn-primary">
                    <Plus className="mr-2" /> {t('create_lobby')}
                </Button>
                <div className="flex gap-2">
                    <Input 
                        value={joinCode} 
                        onChange={e => setJoinCode(e.target.value.toUpperCase())}
                        placeholder={t('join_placeholder')}
                        className="glass-input text-center font-mono font-bold uppercase"
                        maxLength={6}
                    />
                    <Button onClick={handleJoin} className="bg-white text-black hover:bg-gray-200 rounded-xl px-4">
                        <ArrowRight />
                    </Button>
                </div>
            </div>
        </div>

        {/* RIGHT COL: My Lobbies (8 cols) */}
        <div className="lg:col-span-8">
            <div className="glass-card p-8 min-h-[600px] flex flex-col animate-in slide-in-from-right-4 duration-500 delay-100">
                <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
                    <Clock className="text-indigo-400" /> {tDash('my_lobbies')}
                </h2>

                <div className="grid md:grid-cols-2 gap-4">
                    {myLobbies.length === 0 && (
                        <div className="col-span-2 text-center py-20 text-gray-600 italic border-2 border-dashed border-gray-800 rounded-2xl">
                            {tDash('no_lobbies')}
                        </div>
                    )}

                    {myLobbies.map((l) => (
                        <div 
                            key={l.id} 
                            className="bg-black/20 hover:bg-indigo-900/10 border border-white/5 hover:border-indigo-500/30 rounded-2xl p-5 transition-all group relative overflow-hidden"
                        >
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h3 className="font-bold text-lg text-white group-hover:text-indigo-200 transition-colors truncate max-w-[200px]">
                                        {l.name || "Untitled Lobby"}
                                    </h3>
                                    <span className="text-xs font-mono text-gray-500 bg-black/40 px-2 py-1 rounded">
                                        {l.code}
                                    </span>
                                </div>
                                <span className={`text-[10px] font-black px-2 py-1 rounded border ${l.host_id === user.id ? 'border-yellow-500/30 text-yellow-500' : 'border-blue-500/30 text-blue-500'}`}>
                                    {l.host_id === user.id ? tDash('host_badge') : tDash('guest_badge')}
                                </span>
                            </div>

                            <div className="flex items-center justify-between mt-4">
                                <span className={`text-xs uppercase font-bold ${l.status === 'voting' ? 'text-green-400 animate-pulse' : 'text-gray-600'}`}>
                                    {l.status}
                                </span>
                                <Button 
                                    onClick={() => router.push(`/lobby/${l.code}`)} 
                                    className="h-8 text-xs bg-white text-black hover:bg-gray-200 shadow-none"
                                >
                                    {l.status === 'ended' ? tDash('view_results') : tDash('resume')} <Play size={10} className="ml-1" />
                                </Button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

      </div>
    </div>
  );
};

================================================================================
FILE: src\views\lobby\ui\LobbyPage.tsx
================================================================================
'use client'
import { useState, useEffect, useCallback } from 'react';
import { useTranslations } from 'next-intl';
import { useLobbyState } from '@/processes/lobby-flow/model';
import { useSessionAuth } from '@/features/session-auth/model/useSessionAuth';
import { ConfigForm } from '@/features/configure-lobby/ui/ConfigForm';
import { ProfileSetup } from '@/features/session-auth/ui/ProfileSetup';
import { VotingInterface } from '@/widgets/voting-interface/ui/VotingInterface';
import { ResultsDashboard } from '@/widgets/results-dashboard/ui/ResultsDashboard';
import { HostControlPanel } from '@/widgets/host-controls/ui/HostControlPanel';
import { ChatWidget } from '@/widgets/chat-room/ui/ChatWidget';
import { LobbyFlowLayout } from '@/processes/lobby-flow/ui';
import { ShareButton } from '@/features/share-lobby/ui/ShareButton';
import { createClient } from '@/shared/api/supabase';
import { ParticipantAvatar } from '@/entities/participant/ui/ParticipantAvatar';
import { Button } from '@/shared/ui/button';

export const LobbyPage = ({ lobbyId }: { lobbyId: string }) => {
  const t = useTranslations('Lobby');
  const tCommon = useTranslations('Common');
  
  // [FIX] Destructure updateLocalStatus
  const { lobby, candidates, participants, votes, loading, updateLocalStatus, refreshCandidates } = useLobbyState(lobbyId);
  
  const { user } = useSessionAuth();
  const [profileSet, setProfileSet] = useState(false);
  const supabase = createClient();

  useEffect(() => {
    if (user?.user_metadata?.nickname) setProfileSet(true);
  }, [user]);

  const isHost = user && lobby && user.id === lobby.host_id;

  const handleStartSetup = useCallback(async () => {
    if (!isHost) return;
    updateLocalStatus('setup'); // Immediate local update
    await supabase.from('lobbies').update({ status: 'setup' }).eq('id', lobbyId);
  }, [isHost, lobbyId, supabase, updateLocalStatus]);

  // Auto-Redirect Host
  useEffect(() => {
    if (isHost && lobby?.status === 'waiting' && profileSet) {
      const timer = setTimeout(() => handleStartSetup(), 500);
      return () => clearTimeout(timer);
    }
  }, [isHost, lobby?.status, profileSet, handleStartSetup]);

  // [NEW] Handlers for optimistic updates
  const handleLaunchSuccess = () => {
    refreshCandidates(); // Ensure we have the latest data
    updateLocalStatus('voting'); // Switch view immediately
  };

  const handleSuspend = () => {
    updateLocalStatus('setup'); // Switch view immediately
  };

  const handleEnd = () => {
    updateLocalStatus('ended'); // Switch view immediately
  };

  const handleResume = async () => {
    updateLocalStatus('voting'); // Immediate local update
    await supabase.from('lobbies').update({ status: 'voting' }).eq('id', lobbyId);
  };

  if (loading || !lobby || !user) {
    return (
      <div className="h-screen flex flex-col items-center justify-center bg-[#030712] text-indigo-500 gap-4">
        <div className="animate-spin text-4xl">{t('loading_icon')}</div>
        <p className="animate-pulse tracking-widest text-xs font-bold uppercase">{tCommon('loading_lobby')}</p>
      </div>
    );
  }

  if (!profileSet) {
    return <ProfileSetup userId={user.id} onComplete={() => setProfileSet(true)} />;
  }

  return (
    <LobbyFlowLayout status={lobby.status}>
      <main className="min-h-screen p-4 md:p-8 pb-32">
        <header className="flex justify-between items-center mb-8 max-w-6xl mx-auto">
          <div>
             <h1 className="text-2xl font-black tracking-tighter text-white">
               {lobby.name && lobby.name !== 'Untitled Lobby' ? lobby.name : t('title', { code: lobby.code })}
             </h1>
             <div className="flex items-center gap-2 mt-1">
               <span className={`w-2 h-2 rounded-full ${lobby.status === 'voting' ? 'bg-green-500 animate-pulse' : 'bg-gray-500'}`} />
               <span className="text-xs text-gray-400 font-bold uppercase tracking-widest">
                 {t(lobby.status === 'waiting' ? 'status_waiting' : lobby.status === 'setup' ? 'status_setup' : lobby.status === 'voting' ? 'status_voting' : 'status_ended')}
               </span>
             </div>
          </div>
          <ShareButton code={lobby.code} />
        </header>

        <div className="max-w-6xl mx-auto">
          {/* WAITING */}
          {lobby.status === 'waiting' && (
            <div className="glass-card p-12 text-center max-w-xl mx-auto mt-20 animate-in zoom-in-95 border-indigo-500/20">
               <div className="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl border border-gray-700">
                 <span className="animate-pulse text-4xl">‚è≥</span>
               </div>
               <h2 className="text-3xl font-bold mb-3 text-white">{t('waiting_title')}</h2>
               <p className="text-gray-400 leading-relaxed mb-8">{t('waiting_desc')}</p>
               
               <div className="flex flex-wrap justify-center gap-3 mb-8">
                 {participants.map(p => (
                   <div key={p.user_id} className="animate-in fade-in slide-in-from-bottom-2 flex flex-col items-center gap-1">
                     <ParticipantAvatar participant={p} className="w-12 h-12 ring-2 ring-gray-900 shadow-lg" />
                     <span className="text-[10px] text-gray-500">{p.nickname}</span>
                   </div>
                 ))}
               </div>

               {isHost && (
                 <Button onClick={handleStartSetup} className="btn-primary w-full max-w-xs mx-auto animate-pulse">
                   {t('configure_btn')}
                 </Button>
               )}
            </div>
          )}

          {/* SETUP */}
          {lobby.status === 'setup' && (
            isHost ? (
               // [FIX] Pass handleLaunchSuccess
               <ConfigForm lobbyId={lobbyId} onSuccess={handleLaunchSuccess} />
            ) : (
               <div className="glass-card p-12 text-center max-w-xl mx-auto mt-20 animate-in zoom-in-95">
                  <div className="w-20 h-20 bg-indigo-900/30 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl border border-indigo-500/30">
                    <span className="animate-spin text-4xl">{t('setup_icon')}</span>
                  </div>
                  <h2 className="text-2xl font-bold text-white">{t('host_configuring')}</h2>
                  <p className="text-gray-400 mt-2">{t('host_configuring_desc')}</p>
               </div>
            )
          )}

          {/* VOTING */}
          {lobby.status === 'voting' && (
            <VotingInterface 
              lobbyId={lobbyId} 
              userId={user.id} 
              candidates={candidates}
              factors={lobby.settings.factors}
              maxScale={lobby.settings.voting_scale.max}
            />
          )}

          {/* ENDED */}
          {lobby.status === 'ended' && (
            <ResultsDashboard 
              candidates={candidates} 
              votes={votes}
              factors={lobby.settings.factors}
              onResume={isHost ? handleResume : undefined} // [NEW] Pass Resume handler
            />
          )}
        </div>

        {isHost && (
            <HostControlPanel 
                lobbyId={lobbyId} 
                settings={lobby.settings} 
                status={lobby.status} 
                onSuspend={handleSuspend} // [NEW] Optimistic callbacks
                onEnd={handleEnd}
            />
        )}
        <ChatWidget lobbyId={lobbyId} userId={user.id} />
      </main>
    </LobbyFlowLayout>
  );
};

================================================================================
FILE: src\widgets\chat-room\ui\ChatWidget.tsx
================================================================================
import { useState, useRef, useEffect, useMemo } from 'react';
import { useTranslations } from 'next-intl';
import { useChat } from '@/features/chat/model/useChat';
import { usePresence } from '@/features/chat/model/usePresence';
import { MessageBubble } from './MessageBubble';
import { Button } from '@/shared/ui/button';
import { MessageSquare, X, Send, CornerDownRight } from 'lucide-react';
import { ChatMessage } from '@/features/chat/model/types';

export const ChatWidget = ({ lobbyId, userId }: { lobbyId: string, userId: string }) => {
  const t = useTranslations('Chat');
  const [isOpen, setIsOpen] = useState(false);
  const [input, setInput] = useState("");
  const [replyTarget, setReplyTarget] = useState<ChatMessage | null>(null);
  
  const { messages, typingUsers, sendMessage, deleteMessage, editMessage, broadcastTyping } = useChat(lobbyId, userId, "User");
  const { onlineUsers } = usePresence(lobbyId, userId, "User");

  const bottomRef = useRef<HTMLDivElement>(null);

  // Auto-scroll
  useEffect(() => {
    if (isOpen) bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isOpen]);

  // Handle ESC key
  useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape') setIsOpen(false);
    };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, []);

  const handleSend = (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim()) return;
    sendMessage(input, replyTarget?.id);
    setInput("");
    setReplyTarget(null);
  };

  if (!isOpen) {
    return (
      <div className="fixed bottom-24 right-4 z-50 flex flex-col items-end gap-3 md:bottom-8">
      {onlineUsers.length > 0 && (
          <div className="bg-black/60 backdrop-blur border border-white/10 px-3 py-1 rounded-full text-xs font-bold text-green-400 shadow-xl animate-in fade-in">
            {'\u25CF'} {t('online_count', { count: onlineUsers.length })}
          </div>
        )}
        <Button onClick={() => setIsOpen(true)} className="rounded-full w-14 h-14 shadow-2xl p-0 btn-primary">
          <MessageSquare />
        </Button>
      </div>
    );
  }

  return (
    <>
      {/* Backdrop for click-outside dismissal */}
      <div 
        className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[49]" 
        onClick={() => setIsOpen(false)} 
      />

      {/* Sidebar Panel */}
      <div className="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-[#0b0f19] border-l border-white/10 shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300">
        
        {/* Header */}
        <div className="p-4 bg-gray-900/50 border-b border-gray-800 flex justify-between items-center backdrop-blur-md">
          <div>
            <h3 className="font-bold text-white">{t('title')}</h3>
            <span className="text-xs text-green-400 font-mono flex items-center gap-1">
              <span className="animate-pulse">{'\u25CF'}</span> {/* [FIX] Unicode bullet */}
              {t('online_count', { count: onlineUsers.length })}
            </span>
          </div>
          <button onClick={() => setIsOpen(false)} className="p-2 hover:bg-white/10 rounded-full transition-colors"><X size={20} /></button>
        </div>
        
        {/* Messages Area */}
        <div className="flex-1 overflow-y-auto p-4 space-y-1 scrollbar-thin scrollbar-thumb-gray-800">
          {messages.length === 0 && (
            <div className="h-full flex flex-col items-center justify-center text-gray-600 space-y-4 opacity-50">
               <MessageSquare size={48} />
               <p>{t('empty')}</p>
            </div>
          )}
          
          {messages.map((m, index) => {
            // Grouping Logic: Hide header if previous msg was from same user within 5 mins
            const prevMsg = messages[index - 1];
            const isSequence = prevMsg && prevMsg.user_id === m.user_id && (new Date(m.created_at).getTime() - new Date(prevMsg.created_at).getTime() < 300000);
            
            return (
              <div key={m.id} className={isSequence ? "mt-0.5" : "mt-4"}>
                {/* We pass a custom 'hideHeader' prop if you update MessageBubble to support it, 
                    or handle it via CSS/Structure here. 
                    For now, MessageBubble handles structure internally, so we might keep it simple or refactor MessageBubble.
                    Let's assume MessageBubble is smart enough or we wrap it. */}
                <MessageBubble 
                  message={m} 
                  isMe={m.user_id === userId}
                  onReply={setReplyTarget}
                  onEdit={editMessage}
                  onDelete={deleteMessage}
                  // You might need to add a prop to MessageBubble like 'compact={isSequence}' to hide avatar/name
                />
              </div>
            );
          })}
          
          {typingUsers.length > 0 && (
            <div className="text-xs text-indigo-400 italic ml-4 animate-pulse mt-2">
              {t('typing', { name: typingUsers.join(", ") })}
            </div>
          )}
          <div ref={bottomRef} />
        </div>

        {/* Reply Context Bar */}
        {replyTarget && (
          <div className="bg-gray-900/80 px-4 py-3 border-t border-gray-800 flex justify-between items-center backdrop-blur">
            <div className="text-xs text-gray-300 truncate max-w-[250px] border-l-2 border-indigo-500 pl-2">
              <span className="font-bold text-indigo-400 block">@{replyTarget.nickname}</span>
              <span className="opacity-70">{replyTarget.content}</span>
            </div>
            <button onClick={() => setReplyTarget(null)} className="p-1 hover:bg-white/10 rounded"><X size={14} /></button>
          </div>
        )}

        {/* Input Area */}
        <form onSubmit={handleSend} className="p-4 bg-[#0b0f19]/90 border-t border-white/10 flex gap-2 backdrop-blur-md">
          <input 
            className="flex-1 glass-input focus:ring-indigo-500 bg-black/40 text-white placeholder-gray-500"
            value={input}
            onChange={e => {
              setInput(e.target.value);
              broadcastTyping(); 
            }}
            placeholder={t('placeholder')}
            autoFocus={isOpen}
          />
          <Button type="submit" variant="primary" className="px-4 rounded-xl h-full shadow-lg shadow-indigo-500/20">
            <Send size={18} />
          </Button>
        </form>
      </div>
    </>
  );
};

================================================================================
FILE: src\widgets\chat-room\ui\MessageBubble.tsx
================================================================================
import { useState } from 'react';
import { SmartEntity } from '@/shared/ui/smart-entity';
import { ChatMessage } from '@/features/chat/model/types';
import { useTranslations } from 'next-intl';
import { Pencil, Trash2, Reply, X, Check } from 'lucide-react';

interface MessageBubbleProps {
  message: ChatMessage;
  isMe: boolean;
  onReply: (msg: ChatMessage) => void;
  onEdit: (id: string, newContent: string) => void;
  onDelete: (id: string) => void;
}

export const MessageBubble = ({ message, isMe, onReply, onEdit, onDelete }: MessageBubbleProps) => {
  const t = useTranslations('Chat');
  const [isHovered, setIsHovered] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editContent, setEditContent] = useState(message.content);

  const handleSaveEdit = () => {
    if (editContent.trim() !== message.content) {
      onEdit(message.id, editContent);
    }
    setIsEditing(false);
  };

  return (
    <div 
      className={`flex gap-3 group mb-4 ${isMe ? 'flex-row-reverse' : ''}`}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <SmartEntity 
        label={message.nickname} 
        seed={message.user_id} 
        className={isMe ? "hidden" : "self-end"} 
      />
      
      <div className={`flex flex-col max-w-[75%] ${isMe ? 'items-end' : 'items-start'}`}>
        {/* Reply Context */}
        {message.reply_to && (
          <div className="text-[10px] text-gray-500 bg-gray-800/50 px-2 py-1 rounded-t-md border-b-0 border border-gray-700 w-fit mb-[-4px] z-0 opacity-80">
            <span className="font-bold">@{message.reply_to.nickname}:</span> {message.reply_to.content.substring(0, 20)}...
          </div>
        )}

        <div className={`
          relative rounded-2xl px-4 py-2 text-sm leading-relaxed shadow-sm z-10 min-w-[120px]
          ${isMe 
            ? 'bg-indigo-600 text-white rounded-tr-sm' 
            : 'bg-gray-800 text-gray-200 border border-gray-700 rounded-tl-sm'
          }
        `}>
          {!isMe && !message.reply_to && <div className="text-[10px] font-bold opacity-50 mb-1">{message.nickname}</div>}
          
          {isEditing ? (
            <div className="flex flex-col gap-2 min-w-[200px]">
              <input 
                value={editContent} 
                onChange={(e) => setEditContent(e.target.value)}
                className="bg-black/20 rounded p-1 text-white outline-none w-full"
                autoFocus
              />
              <div className="flex justify-end gap-2">
                <button onClick={() => setIsEditing(false)} className="text-xs hover:text-red-300"><X size={14} /></button>
                <button onClick={handleSaveEdit} className="text-xs hover:text-green-300"><Check size={14} /></button>
              </div>
            </div>
          ) : (
            <p className="break-words">
              {message.content}
              {message.is_edited && <span className="text-[10px] opacity-60 ml-1 italic">{t('edited')}</span>}
            </p>
          )}
        </div>

        {/* Action Buttons (Visible on Hover) */}
        <div className={`flex gap-1 mt-1 opacity-0 transition-opacity ${isHovered ? 'opacity-100' : ''}`}>
          <button onClick={() => onReply(message)} className="p-1 text-gray-500 hover:text-indigo-400" title={t('actions.reply')}>
            <Reply size={12} />
          </button>
          {isMe && (
            <>
              <button onClick={() => setIsEditing(true)} className="p-1 text-gray-500 hover:text-yellow-400" title={t('actions.edit')}>
                <Pencil size={12} />
              </button>
              <button onClick={() => onDelete(message.id)} className="p-1 text-gray-500 hover:text-red-400" title={t('actions.delete')}>
                <Trash2 size={12} />
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\global-navigation\ui\SettingsMenu.tsx
================================================================================
'use client'
import { useState, useRef, useEffect } from 'react';
import { useTranslations, useLocale } from 'next-intl';
import { useRouter, usePathname } from '@/i18n/routing';
import { createClient } from '@/shared/api/supabase';
import { Settings, LogOut, Globe, Home as HomeIcon, X, User as UserIcon } from 'lucide-react';
import { Button } from '@/shared/ui/button';
import { useParams } from 'next/navigation';

export const SettingsMenu = () => {
  const t = useTranslations('Settings');
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();
  const params = useParams();
  const supabase = createClient();
  
  const [isOpen, setIsOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  // Close on click outside
  useEffect(() => {
    const handleClick = (e: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, []);

  const handleLogout = async () => {
    await supabase.auth.signOut();
    window.location.href = '/'; // Hard reload to clear state
  };

  const switchLocale = (newLocale: 'en' | 'it') => {
    router.replace(pathname, { locale: newLocale });
  };

  const leaveLobby = () => {
    router.push('/');
    setIsOpen(false);
  };

  const lobbyCode = params?.code as string;

  return (
    <div className="fixed top-6 right-6 z-[100]" ref={menuRef}>
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className={`p-3 rounded-full transition-all duration-300 shadow-xl border border-white/10 ${isOpen ? 'bg-indigo-600 text-white rotate-90' : 'bg-[#0b0f19]/80 text-gray-300 hover:bg-indigo-600 hover:text-white backdrop-blur-md'}`}
      >
        <Settings size={24} />
      </button>

      {isOpen && (
        <div className="absolute top-14 right-0 w-64 glass-card p-4 animate-in slide-in-from-top-4 fade-in duration-200 flex flex-col gap-4 border border-indigo-500/30">
          
          {/* Header */}
          <div className="flex items-center justify-between border-b border-white/10 pb-2">
            <span className="text-xs font-bold uppercase tracking-widest text-gray-500">{t('title')}</span>
            {lobbyCode && (
              <span className="text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded">
                {t('current_lobby', { code: lobbyCode })}
              </span>
            )}
          </div>

          {/* Language Switcher */}
          <div className="space-y-2">
            <label className="text-xs text-gray-400 flex items-center gap-2">
                <Globe size={12} /> {t('language')}
            </label>
            <div className="flex bg-black/40 p-1 rounded-lg">
                {['en', 'it'].map((l) => (
                    <button
                        key={l}
                        onClick={() => switchLocale(l as 'en' | 'it')}
                        className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-colors ${locale === l ? 'bg-indigo-600 text-white' : 'text-gray-500 hover:text-gray-300'}`}
                    >
                        {l.toUpperCase()}
                    </button>
                ))}
            </div>
          </div>

          {/* Navigation Actions */}
          <div className="space-y-2">
            {lobbyCode && (
                <Button variant="secondary" onClick={leaveLobby} className="w-full justify-start text-xs h-9">
                    <HomeIcon size={14} className="mr-2" /> {t('leave_lobby')}
                </Button>
            )}
            
            <Button variant="danger" onClick={handleLogout} className="w-full justify-start text-xs h-9 bg-red-900/20 hover:bg-red-600 border-red-900/30 text-red-200 hover:text-white">
                <LogOut size={14} className="mr-2" /> {t('logout')}
            </Button>
          </div>

        </div>
      )}
    </div>
  );
};

================================================================================
FILE: src\widgets\host-controls\model\useHostActions.ts
================================================================================
import { createClient } from '@/shared/api/supabase';
import { toast } from 'sonner';
import { LobbySettings } from '@/entities/lobby/model/types';

export const useHostActions = (lobbyId: string, currentSettings: LobbySettings) => {
  const supabase = createClient();

  const togglePrivacy = async () => {
    const newMode = currentSettings.privacy === 'anonymous' ? 'public' : 'anonymous';
    
    // Optimistic update handled by Realtime in the UI, 
    // here we just send the command.
    const { error } = await supabase
      .from('lobbies')
      .update({ 
        settings: { ...currentSettings, privacy: newMode } 
      })
      .eq('id', lobbyId);

    if (error) toast.error("Failed to update privacy");
    else toast.success(`Privacy set to: ${newMode}`);
  };

  const endVoting = async () => {
    const { error } = await supabase
      .from('lobbies')
      .update({ status: 'ended' })
      .eq('id', lobbyId);

    if (error) toast.error("Failed to end voting");
  };

  return { togglePrivacy, endVoting };
};

================================================================================
FILE: src\widgets\host-controls\ui\HostControlPanel.tsx
================================================================================
import React, { useState } from 'react';
import { useTranslations } from 'next-intl';
import { LobbySettings } from '@/entities/lobby/model/types';
import { Button } from '@/shared/ui/button';
import { Settings, StopCircle } from 'lucide-react';
import { HostSettingsModal } from '@/widgets/lobby-settings/ui/HostSettingsModal';
import { createClient } from '@/shared/api/supabase';

interface HostControlPanelProps {
  lobbyId: string;
  settings: LobbySettings;
  status: string;
  onSuspend: () => void;
  onEnd: () => void;
}

export const HostControlPanel = ({ lobbyId, settings, status, onSuspend, onEnd }: HostControlPanelProps) => {
  const t = useTranslations('Host');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const supabase = createClient();

  const handleEnd = async () => {
    // 1. Optimistic Update (Switch View Immediately)
    onEnd(); 
    
    // 2. DB Update
    await supabase.from('lobbies').update({ status: 'ended' }).eq('id', lobbyId);
  };

  return (
    <>
      <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-40 flex items-center gap-3 p-3 glass-card rounded-full scale-90 md:scale-100 origin-bottom border-indigo-500/20 shadow-2xl">
        <div className="pl-3 pr-1 text-[10px] font-black text-indigo-400 uppercase tracking-widest hidden md:block">
            {t('title')}
        </div>
      
        <div className="w-px h-6 bg-white/10 hidden md:block"></div>

        {/* Settings Trigger */}
        <Button 
            variant="secondary" 
            onClick={() => setIsModalOpen(true)}
            className="rounded-full px-5 h-10 text-xs font-bold border bg-gray-800 border-gray-700 text-gray-300 hover:text-white transition-colors"
        >
            <Settings size={16} className="mr-2" />
            {t('tab_manage')}
        </Button>

        {/* End Vote (Only visible during voting) */}
        {status === 'voting' && (
            <>
                <div className="w-px h-6 bg-white/10 mx-1"></div>
                <Button 
                    variant="danger" 
                    onClick={handleEnd}
                    className="rounded-full px-6 h-10 text-xs font-bold uppercase tracking-widest bg-red-600 hover:bg-red-500 text-white shadow-[0_0_20px_-5px_rgba(220,38,38,0.5)] border border-red-400/20"
                >
                    <StopCircle size={14} className="mr-2" />
                    {t('end_vote')}
                </Button>
            </>
        )}
      </div>

      <HostSettingsModal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        lobbyId={lobbyId} 
        settings={settings}
        onSuspend={onSuspend}
      />
    </>
  );
};

================================================================================
FILE: src\widgets\lobby-settings\ui\HostSettingsModal.tsx
================================================================================
'use client'
import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { createClient } from '@/shared/api/supabase';
import { Modal } from '@/shared/ui/modal';
import { Button } from '@/shared/ui/button';
import { LobbySettings } from '@/entities/lobby/model/types';
import { PauseCircle, Eye, EyeOff } from 'lucide-react';
import { toast } from 'sonner';

interface HostSettingsModalProps {
  isOpen: boolean;
  onClose: () => void;
  lobbyId: string;
  settings: LobbySettings;
  onSuspend?: () => void;
}

export const HostSettingsModal = ({ isOpen, onClose, lobbyId, settings, onSuspend }: HostSettingsModalProps) => {
  const t = useTranslations('Host');
  const [tab, setTab] = useState<'privacy' | 'manage'>('privacy');
  const supabase = createClient();

  // Normalize privacy settings safely
  const currentPrivacy = (typeof settings.privacy === 'object' && settings.privacy !== null)
    ? settings.privacy as Record<string, string>
    : { users: 'visible', candidates: 'visible', factors: 'visible' };

  const updatePrivacy = async (key: string, val: string) => {
    const newPrivacy = { ...currentPrivacy, [key]: val };
    
    // Optimistic / Fire-and-forget for UI responsiveness
    const { error } = await supabase
      .from('lobbies')
      .update({ settings: { ...settings, privacy: newPrivacy } })
      .eq('id', lobbyId);
      
    if (!error) toast.success(t('privacy_updated'));
  };

  const handleSuspend = async () => {
    // 1. Optimistic Update (Switch View Immediately)
    if (onSuspend) onSuspend();
    
    // 2. DB Update
    const { error } = await supabase
      .from('lobbies')
      .update({ status: 'setup' })
      .eq('id', lobbyId);

    if (error) {
        toast.error(t('end_error'));
    } else {
        toast.success("Lobby Suspended");
        onClose(); 
    }
  };

  // Define the sections for the map loop
  const sections = ['users', 'candidates', 'factors'] as const;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={t('title')}>
      {/* Tabs */}
      <div className="flex gap-2 mb-6 border-b border-gray-700 pb-2">
        <button 
            onClick={() => setTab('privacy')} 
            className={`px-4 py-2 text-sm font-bold rounded-lg transition-colors ${tab === 'privacy' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white'}`}
        >
            {t('tab_privacy')}
        </button>
        <button 
            onClick={() => setTab('manage')} 
            className={`px-4 py-2 text-sm font-bold rounded-lg transition-colors ${tab === 'manage' ? 'bg-indigo-600 text-white' : 'text-gray-400 hover:text-white'}`}
        >
            {t('tab_manage')}
        </button>
      </div>

      {/* Privacy Tab */}
      {tab === 'privacy' && (
        <div className="space-y-4">
            {sections.map((section) => (
                <div key={section} className="flex items-center justify-between bg-gray-800 p-3 rounded-xl border border-gray-700">
                    <span className="font-bold text-sm text-gray-300 capitalize">
                        {t(`privacy_sections.${section}` as any)}
                    </span>
                    <div className="flex bg-black/40 rounded-lg p-1">
                        <button 
                            onClick={() => updatePrivacy(section, 'visible')}
                            className={`p-1.5 rounded-md transition-all ${currentPrivacy[section] !== 'hidden' ? 'bg-green-500/20 text-green-400' : 'text-gray-600 hover:text-gray-400'}`}
                            title="Visible"
                        >
                            <Eye size={16} />
                        </button>
                        <button 
                            onClick={() => updatePrivacy(section, 'hidden')}
                            className={`p-1.5 rounded-md transition-all ${currentPrivacy[section] === 'hidden' ? 'bg-red-500/20 text-red-400' : 'text-gray-600 hover:text-gray-400'}`}
                            title="Hidden"
                        >
                            <EyeOff size={16} />
                        </button>
                    </div>
                </div>
            ))}
        </div>
      )}

      {/* Manage Tab */}
      {tab === 'manage' && (
        <div className="space-y-6 text-center">
            <div className="bg-yellow-900/20 border border-yellow-500/20 p-4 rounded-xl">
                <p className="text-xs text-yellow-200/80 mb-4 leading-relaxed">
                    {t('suspend_desc')}
                </p>
                <Button variant="danger" onClick={handleSuspend} className="w-full justify-center">
                    <PauseCircle size={18} className="mr-2" /> {t('suspend_vote')}
                </Button>
            </div>
        </div>
      )}
    </Modal>
  );
};

================================================================================
FILE: src\widgets\results-dashboard\ui\ChartsContainer.tsx
================================================================================
'use client'
import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid } from 'recharts';
import { useTranslations } from 'next-intl';

interface ChartData {
  name: string;
  score: number;
}

export const ChartsContainer = ({ data }: { data: ChartData[] }) => {
  const t = useTranslations('Results');

  if (data.length === 0) return (
    <div className="text-center text-gray-500">{t('no_data')}</div>
  );

  return (
    <div className="h-[300px] w-full bg-gray-900/30 rounded-xl p-4 border border-gray-800">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart data={data} layout="vertical" margin={{ left: 20 }}>
          <CartesianGrid strokeDasharray="3 3" stroke="#374151" horizontal={false} />
          <XAxis type="number" hide />
          <YAxis 
            dataKey="name" 
            type="category" 
            width={100} 
            tick={{ fill: '#9CA3AF', fontSize: 12 }} 
            interval={0}
          />
          <Tooltip 
            cursor={{ fill: 'rgba(255,255,255,0.05)' }}
            contentStyle={{ backgroundColor: '#111827', borderColor: '#374151', color: '#fff' }}
          />
          <Bar 
            dataKey="score" 
            fill="#6366f1" 
            radius={[0, 4, 4, 0]} 
            barSize={24}
          />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};

================================================================================
FILE: src\widgets\results-dashboard\ui\Podium.tsx
================================================================================
import React, { useState, useMemo } from 'react';
import { useTranslations } from 'next-intl';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
import { calculateSchulze } from '@/shared/lib/voting-math';
import { ChartsContainer } from './ChartsContainer';
import { SchulzeMatrix } from './SchulzeMatrix';
import { RadarAnalysis } from './RadarAnalysis';
import { Podium } from './Podium';
import { Info, Play } from 'lucide-react';
import { SmartTooltip } from '@/shared/ui/tooltip';
import { Button } from '@/shared/ui/button';

interface ResultsDashboardProps {
  candidates: Candidate[];
  votes: any[];
  factors: Factor[];
  onResume?: () => void;
}

export const ResultsDashboard = ({ candidates, votes, factors, onResume }: ResultsDashboardProps) => {
  const t = useTranslations('Results');
  const tDash = useTranslations('Dashboard');
  const [tab, setTab] = useState<'weighted' | 'schulze' | 'radar'>('weighted');

  // --- Calculations ---
  const weightedResults = useMemo(() => {
    return candidates.map(c => {
      const cVotes = votes.filter(v => v.candidate_id === c.id);
      if (cVotes.length === 0) return { candidate: c, score: 0, name: c.name };
      
      // Calculate Weighted Average per candidate (Simplified for view)
      // In production, use the `calculateWeightedScore` from voting-math for full accuracy
      let total = 0;
      let count = 0;
      let maxPossible = 0;

      cVotes.forEach(v => {
        Object.keys(v.scores).forEach(factorId => {
            const val = Number(v.scores[factorId]);
            const factor = factors.find(f => f.id === factorId);
            if (factor && factor.type === 'numerical' && !factor.disabled_candidates?.includes(c.id)) {
                total += val * (factor.weight || 1);
                // Rough normalization for display
                count++; 
            }
        });
      });
      
      const score = count ? (total / count) : 0;
      return { candidate: c, name: c.name, score };
    }).sort((a, b) => b.score - a.score);
  }, [candidates, votes, factors]);

  const schulzeData = useMemo(() => {
    const voterIds = Array.from(new Set(votes.map(v => v.voter_id)));
    const ballots = voterIds.map(vid => {
        const userVotes = votes.filter(v => v.voter_id === vid);
        // Sort candidates by this user's total score to determine rank
        return userVotes
            .sort((a, b) => {
                const sumA = Object.values(a.scores).reduce((x: any, y: any) => x + y, 0) as number;
                const sumB = Object.values(b.scores).reduce((x: any, y: any) => x + y, 0) as number;
                return sumB - sumA;
            })
            .map(v => v.candidate_id);
    });
    // Add candidates who received 0 votes to the end of ballots implicitly
    return calculateSchulze(candidates.map(c => c.id), ballots);
  }, [candidates, votes]);

  return (
    <div className="space-y-8 pb-32">
      
      {/* Header Controls */}
      <div className="flex flex-col md:flex-row justify-between items-center gap-4">
         
         {/* Tabs */}
         <div className="flex flex-wrap gap-2 p-1 bg-gray-900/80 border border-white/10 rounded-xl backdrop-blur-md">
            {(['weighted', 'schulze', 'radar'] as const).map(key => (
            <button 
                key={key}
                onClick={() => setTab(key)}
                className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${tab === key ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}
            >
                {t(`tabs.${key}`)}
            </button>
            ))}
         </div>

         {/* Right Side: Resume Button & Info */}
         <div className="flex items-center gap-3">
            <SmartTooltip content={t(`system_explainer.${tab}`)} side="left">
                <div className="p-2 bg-gray-800 rounded-full text-gray-400 hover:text-white cursor-help border border-white/5">
                    <Info size={20} />
                </div>
            </SmartTooltip>

            {onResume && (
                <Button 
                    onClick={onResume} 
                    className="btn-primary bg-white text-black hover:bg-gray-200 border-none shadow-xl"
                >
                    <Play size={16} className="mr-2 fill-black" /> {tDash('resume')}
                </Button>
            )}
         </div>
      </div>

      {/* Podium (Weighted Only) */}
      {tab === 'weighted' && <Podium candidates={weightedResults} />}

      {/* Main Content View */}
      <div className="glass-card p-6 min-h-[400px]">
        {tab === 'weighted' && <ChartsContainer data={weightedResults} />}
        
        {tab === 'schulze' && (
            <SchulzeMatrix 
                candidates={candidates} 
                matrix={schulzeData.matrix} 
            />
        )}

        {tab === 'radar' && (
            <RadarAnalysis 
                candidates={candidates} 
                factors={factors} 
                votes={votes} 
            />
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\results-dashboard\ui\RadarAnalysis.tsx
================================================================================
'use client'
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
import { useTranslations } from 'next-intl';

interface RadarAnalysisProps {
  candidates: Candidate[];
  factors: Factor[];
  votes: any[];
}

export const RadarAnalysis = ({ candidates, factors, votes }: RadarAnalysisProps) => {
  const t = useTranslations('Results');

  // Transform data: One object per Factor, keys are candidate IDs
  const activeFactors = factors.filter(f => f.type === 'numerical' && !f.is_hidden);
  
  const data = activeFactors.map(factor => {
      const point: any = { factor: factor.name, fullMark: 10 }; 
      
      candidates.forEach(c => {
        // Skip null factors
        if (factor.disabled_candidates?.includes(c.id)) {
            point[c.id] = 0; 
            return;
        }

        const cVotes = votes.filter(v => v.candidate_id === c.id);
        const total = cVotes.reduce((sum, v) => sum + (v.scores[factor.id] || 0), 0);
        point[c.id] = cVotes.length ? (total / cVotes.length) : 0;
      });
      return point;
    });

  const colors = ['#818cf8', '#34d399', '#fbbf24', '#f472b6', '#60a5fa'];

  if (activeFactors.length < 3) {
      // [FIX] Used translation key
      return <div className="text-center text-gray-500 py-20 italic">{t('need_more_factors')}</div>;
  }

  return (
    <div className="h-[500px] w-full">
      <h3 className="text-center text-gray-400 text-sm mb-2">{t('radar_legend')}</h3>
      <ResponsiveContainer width="100%" height="100%">
        <RadarChart cx="50%" cy="50%" outerRadius="70%" data={data}>
          <PolarGrid stroke="#374151" strokeDasharray="3 3" />
          <PolarAngleAxis dataKey="factor" tick={{ fill: '#e5e7eb', fontSize: 11, fontWeight: 'bold' }} />
          <PolarRadiusAxis angle={30} domain={[0, 10]} tick={false} axisLine={false} />
          
          <Tooltip 
            contentStyle={{ backgroundColor: '#0f172a', borderColor: '#374151', borderRadius: '12px', color: '#fff' }}
            itemStyle={{ fontSize: '12px' }}
          />

          {candidates.map((c, i) => (
            <Radar
              key={c.id}
              name={c.name}
              dataKey={c.id}
              stroke={colors[i % colors.length]}
              strokeWidth={3}
              fill={colors[i % colors.length]}
              fillOpacity={0.2}
            />
          ))}
          <Legend wrapperStyle={{ paddingTop: '20px' }} />
        </RadarChart>
      </ResponsiveContainer>
    </div>
  );
};

================================================================================
FILE: src\widgets\results-dashboard\ui\ResultsDashboard.tsx
================================================================================
import React, { useState, useMemo } from 'react';
import { useTranslations } from 'next-intl';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
import { calculateSchulze } from '@/shared/lib/voting-math';
import { ChartsContainer } from './ChartsContainer';
import { SchulzeMatrix } from './SchulzeMatrix';
import { RadarAnalysis } from './RadarAnalysis';
import { VoterAnalysis } from './VoterAnalysis'; // [NEW]
import { Podium } from './Podium';
import { Info, Play, Users } from 'lucide-react';
import { SmartTooltip } from '@/shared/ui/tooltip';
import { Button } from '@/shared/ui/button';
import { createClient } from '@/shared/api/supabase'; // To get participants? Or pass them in props

interface ResultsDashboardProps {
  candidates: Candidate[];
  votes: any[];
  factors: Factor[];
  onResume?: () => void;
}

export const ResultsDashboard = ({ candidates, votes, factors, onResume }: ResultsDashboardProps) => {
  const t = useTranslations('Results');
  const tDash = useTranslations('Dashboard');
  // [NEW] Added 'badges' tab
  const [tab, setTab] = useState<'weighted' | 'schulze' | 'radar' | 'badges'>('weighted');
  
  // Need participants for Badge view. Ideally passed as prop, fetching here for MVP fix.
  const [participants, setParticipants] = useState<any[]>([]);
  
  useMemo(async () => {
    const supabase = createClient();
    // In production, pass this down from LobbyPage
    const { data } = await supabase.from('lobby_participants').select('*').eq('lobby_id', candidates[0]?.lobby_id);
    if(data) setParticipants(data);
  }, [candidates]);

  // --- Calculations ---
  const weightedResults = useMemo(() => {
    return candidates.map(c => {
      const cVotes = votes.filter(v => v.candidate_id === c.id);
      if (cVotes.length === 0) return { candidate: c, score: 0, name: c.name };
      
      let total = 0;
      let count = 0;
      cVotes.forEach(v => {
        Object.keys(v.scores).forEach(factorId => {
            const val = Number(v.scores[factorId]);
            const factor = factors.find(f => f.id === factorId);
            if (factor && factor.type === 'numerical' && !factor.disabled_candidates?.includes(c.id)) {
                total += val * (factor.weight || 1);
                count++; 
            }
        });
      });
      const score = count ? (total / count) : 0;
      return { candidate: c, name: c.name, score };
    }).sort((a, b) => b.score - a.score);
  }, [candidates, votes, factors]);

  const schulzeData = useMemo(() => {
    const voterIds = Array.from(new Set(votes.map(v => v.voter_id)));
    const ballots = voterIds.map(vid => {
        const userVotes = votes.filter(v => v.voter_id === vid);
        return userVotes
            .sort((a, b) => {
                const sumA = Object.values(a.scores).reduce((x: any, y: any) => x + y, 0) as number;
                const sumB = Object.values(b.scores).reduce((x: any, y: any) => x + y, 0) as number;
                return sumB - sumA;
            })
            .map(v => v.candidate_id);
    });
    return calculateSchulze(candidates.map(c => c.id), ballots);
  }, [candidates, votes]);

  return (
    <div className="space-y-8 pb-32">
      
      {/* Header */}
      <div className="flex flex-col xl:flex-row justify-between items-center gap-4">
         <div className="flex flex-wrap gap-2 p-1 bg-gray-900/80 border border-white/10 rounded-xl backdrop-blur-md">
            {(['weighted', 'schulze', 'radar', 'badges'] as const).map(key => (
            <button 
                key={key}
                onClick={() => setTab(key)}
                className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${tab === key ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}
            >
                {t(`tabs.${key}`)}
            </button>
            ))}
         </div>

         <div className="flex items-center gap-3">
            {tab !== 'badges' && (
                <SmartTooltip content={t(`system_explainer.${tab}` as any)} side="left">
                    <div className="p-2 bg-gray-800 rounded-full text-gray-400 hover:text-white cursor-help border border-white/5">
                        <Info size={20} />
                    </div>
                </SmartTooltip>
            )}

            {onResume && (
                <Button onClick={onResume} className="btn-primary bg-white text-black hover:bg-gray-200 border-none shadow-xl">
                    <Play size={16} className="mr-2 fill-black" /> {tDash('resume')}
                </Button>
            )}
         </div>
      </div>

      {/* Podium (Always visible on top of Weighted for impact) */}
      {tab === 'weighted' && <Podium candidates={weightedResults} />}

      {/* Content */}
      <div className="glass-card p-6 min-h-[400px]">
        {tab === 'weighted' && <ChartsContainer data={weightedResults} />}
        
        {tab === 'schulze' && <SchulzeMatrix candidates={candidates} matrix={schulzeData.matrix} />}

        {tab === 'radar' && <RadarAnalysis candidates={candidates} factors={factors} votes={votes} />}

        {tab === 'badges' && (
            <VoterAnalysis 
                participants={participants} 
                votes={votes} 
                winnerId={weightedResults[0]?.candidate.id} 
            />
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\results-dashboard\ui\SchulzeMatrix.tsx
================================================================================
import { Candidate } from '@/entities/candidate/model/types';
import { useTranslations } from 'next-intl';
import { AvatarContainer } from '@/shared/ui/avatar-container';
import { SmartTooltip } from '@/shared/ui/tooltip';

interface SchulzeMatrixProps {
  candidates: Candidate[];
  matrix: number[][]; // d[i][j] - Votes where i > j
}

export const SchulzeMatrix = ({ candidates, matrix }: SchulzeMatrixProps) => {
  const t = useTranslations('Results');

  return (
    <div className="overflow-x-auto">
      <div className="min-w-[600px]">
        <p className="text-xs text-gray-500 mb-6 text-center italic">{t('matrix_legend')}</p>
        
        <table className="w-full text-xs md:text-sm border-collapse table-fixed">
          <thead>
            <tr>
              <th className="p-2 w-32 bg-transparent"></th>
              {candidates.map(c => (
                <th key={c.id} className="p-2 w-20 text-center align-bottom">
                  <div className="flex flex-col items-center gap-2">
                    <AvatarContainer src={c.image_url} alt={c.name} seed={c.id} size="sm" className="mx-auto" />
                    <span className="truncate w-full block text-[10px] text-gray-400 font-mono">{c.name.substring(0, 6)}</span>
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {candidates.map((rowCand, i) => (
              <tr key={rowCand.id} className="border-t border-white/5">
                <td className="p-3 flex items-center gap-3 justify-end">
                   <span className="font-bold text-gray-200 text-right truncate w-24">{rowCand.name}</span>
                   <AvatarContainer src={rowCand.image_url} alt={rowCand.name} seed={rowCand.id} size="sm" />
                </td>
                
                {candidates.map((colCand, j) => {
                  if (i === j) return <td key={colCand.id} className="bg-white/5 diagonal-stripe"></td>;
                  
                  const wins = matrix[i][j];
                  const losses = matrix[j][i];
                  const isWinner = wins > losses;
                  const isTie = wins === losses;
                  
                  // Color Logic
                  let bgClass = 'bg-gray-900/50 text-gray-600';
                  if (isWinner) bgClass = 'bg-green-500/20 text-green-400 font-bold shadow-[inset_0_0_10px_rgba(74,222,128,0.1)]';
                  if (!isWinner && !isTie) bgClass = 'bg-red-500/10 text-red-400/50';

                  return (
                    <td key={colCand.id} className={`p-2 text-center border border-white/5 transition-colors hover:bg-white/10 ${bgClass}`}>
                      <SmartTooltip content={`${rowCand.name} beats ${colCand.name} by ${wins} vs ${losses} votes`}>
                        <span className="block w-full h-full cursor-help">
                            {wins}
                        </span>
                      </SmartTooltip>
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\results-dashboard\ui\VoterAnalysis.tsx
================================================================================
import { Participant } from '@/entities/participant/model/types';
import { calculateBadges, BadgeType } from '@/entities/participant/model/badges';
import { AvatarContainer } from '@/shared/ui/avatar-container';
import { SmartTooltip } from '@/shared/ui/tooltip';
import { useTranslations } from 'next-intl';
import { Brain, Heart, Frown, Sparkles, TrendingUp } from 'lucide-react';

interface VoterAnalysisProps {
  participants: Participant[];
  votes: any[];
  winnerId?: string; 
}

const BadgeIcon = ({ type }: { type: BadgeType }) => {
  switch(type) {
    case 'hater': return <Frown size={16} className="text-red-400" />;
    case 'lover': return <Heart size={16} className="text-pink-400" />;
    case 'oracle': return <Sparkles size={16} className="text-yellow-400" />;
    case 'contrarian': return <TrendingUp size={16} className="text-orange-400" />;
    case 'hive_mind': return <Brain size={16} className="text-indigo-400" />;
    default: return null;
  }
};

export const VoterAnalysis = ({ participants, votes, winnerId }: VoterAnalysisProps) => {
  const t = useTranslations('Results');
  
  // [FIX] Removed 3rd argument to match function signature
  const badgesMap = calculateBadges(votes, winnerId || ""); 

  return (
    <div className="space-y-4">
      <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
        {t('badges_title')}
      </h3>

      <div className="grid gap-3">
        {participants.filter(p => p.has_voted).map(p => {
          const userBadges = badgesMap[p.user_id] || [];
          const userVoteCount = votes.filter(v => v.voter_id === p.user_id).length;

          return (
            <div key={p.user_id} className="flex items-center justify-between bg-gray-900/40 border border-white/5 rounded-xl p-4 hover:bg-white/5 transition-colors">
              
              <div className="flex items-center gap-4">
                <AvatarContainer 
                    src={p.avatar_url} 
                    alt={p.nickname} 
                    seed={p.user_id} 
                    className="ring-2 ring-indigo-500/30"
                />
                <div>
                    <div className="font-bold text-gray-200">{p.nickname}</div>
                    <div className="text-[10px] text-gray-500 uppercase font-bold tracking-widest">
                        {userVoteCount > 0 ? "Voted" : "Spectating"}
                    </div>
                </div>
              </div>

              <div className="flex gap-2">
                {userBadges.map(badge => (
                    <SmartTooltip key={badge} content={`${t(`badges_list.${badge}.title`)}: ${t(`badges_list.${badge}.desc`)}`}>
                        <div className="p-2 bg-black/40 rounded-lg border border-white/10 hover:border-white/30 cursor-help transition-colors">
                            <BadgeIcon type={badge} />
                        </div>
                    </SmartTooltip>
                ))}
              </div>

            </div>
          );
        })}
        {participants.filter(p => p.has_voted).length === 0 && (
            // [FIX] Used translation key
            <div className="text-center text-gray-500 py-10 italic">{t('no_data')}</div>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\user-dashboard\ui\ProfileEditor.tsx
================================================================================
'use client'
import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { createClient } from '@/shared/api/supabase';
import { Button } from '@/shared/ui/button';
import { Input } from '@/shared/ui/input';
import { ImagePicker } from '@/shared/ui/image-picker';
import { User } from '@supabase/supabase-js';
import { toast } from 'sonner';
import { Lock, User as UserIcon, Save } from 'lucide-react';

export const ProfileEditor = ({ user }: { user: User }) => {
  const t = useTranslations('Profile');
  const supabase = createClient();
  
  const [nickname, setNickname] = useState(user.user_metadata?.nickname || '');
  const [avatarUrl, setAvatarUrl] = useState(user.user_metadata?.avatar_url || null);
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);

  const handleUpdate = async () => {
    setLoading(true);
    try {
      const updates: any = {
        data: { nickname, avatar_url: avatarUrl }
      };

      if (password.trim()) {
        updates.password = password;
      }

      const { error } = await supabase.auth.updateUser(updates);
      if (error) throw error;

      toast.success(t('update_success'));
      setPassword(''); // Clear password field
    } catch (e: any) {
      toast.error(e.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="glass-card p-8 w-full h-full animate-in slide-in-from-left-4 duration-500">
      <div className="flex items-center gap-3 mb-8 border-b border-white/10 pb-4">
        <UserIcon className="text-indigo-400" />
        <h2 className="text-xl font-bold text-white">{t('title')}</h2>
      </div>

      <div className="space-y-8">
        {/* Avatar */}
        <div className="flex flex-col items-center gap-4">
            <ImagePicker 
                value={avatarUrl} 
                onChange={setAvatarUrl} 
                allowShuffle={true}
                seed={user.id}
                className="scale-125"
            />
        </div>

        {/* Form */}
        <div className="space-y-4">
            <div className="space-y-2">
                <label className="text-xs uppercase font-bold text-gray-500 ml-1">{t('placeholder_name')}</label>
                <Input 
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    className="glass-input"
                />
            </div>

            <div className="space-y-2">
                <label className="text-xs uppercase font-bold text-gray-500 ml-1 flex items-center gap-1">
                    <Lock size={10} /> {t('change_password')}
                </label>
                <Input 
                    type="password"
                    placeholder={t('new_password')}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="glass-input"
                />
            </div>

            <Button onClick={handleUpdate} isLoading={loading} className="w-full btn-primary mt-4">
                <Save size={16} className="mr-2" /> {t('update_btn')}
            </Button>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\voting-interface\ui\JollySelector.tsx
================================================================================
import { Candidate } from '@/entities/candidate/model/types';
import { SmartEntity } from '@/shared/ui/smart-entity';
import { useTranslations } from 'next-intl';
import { Sparkles } from 'lucide-react';

interface JollySelectorProps {
  candidates: Candidate[];
  selectedId: string | null;
  onSelect: (id: string | null) => void;
}

export const JollySelector = ({ candidates, selectedId, onSelect }: JollySelectorProps) => {
  const t = useTranslations('Voting');

  return (
    <div className="space-y-4 bg-gradient-to-r from-yellow-900/20 to-transparent p-6 rounded-2xl border border-yellow-500/30">
      <div className="flex items-center gap-2 text-yellow-400">
        <Sparkles className="animate-pulse" />
        <h3 className="font-bold text-lg">{t('jolly_title')}</h3>
      </div>
      <p className="text-sm text-yellow-200/60">{t('jolly_desc')}</p>

      <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4">
        {candidates.map(c => {
          const isSelected = selectedId === c.id;
          return (
            <button
              key={c.id}
              onClick={() => onSelect(isSelected ? null : c.id)}
              className={`
                relative p-4 rounded-xl border transition-all duration-300 flex flex-col items-center gap-3
                ${isSelected 
                  ? 'bg-yellow-500/20 border-yellow-400 shadow-[0_0_20px_rgba(250,204,21,0.3)] scale-105' 
                  : 'bg-gray-900/50 border-gray-700 hover:bg-gray-800 hover:border-gray-500'
                }
              `}
            >
              <SmartEntity 
                label="" 
                seed={c.id} 
                imageUrl={c.image_url} 
                className="pointer-events-none scale-125"
              />
              <span className={`text-xs font-bold truncate w-full text-center ${isSelected ? 'text-yellow-300' : 'text-gray-400'}`}>
                {c.name}
              </span>
              {isSelected && (
                <div className="absolute -top-2 -right-2 bg-yellow-400 text-black text-[10px] font-black px-2 py-0.5 rounded-full shadow-lg">
                  JOLLY
                </div>
              )}
            </button>
          );
        })}
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\voting-interface\ui\VotingCard.tsx
================================================================================
import React from 'react';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
import { SmartEntity } from '@/shared/ui/smart-entity';
import { SmartTooltip } from '@/shared/ui/tooltip';
import { useTranslations } from 'next-intl';
import { Star, ArrowDown, ArrowUp } from 'lucide-react';
import Image from 'next/image';

interface VotingCardProps {
  candidate: Candidate;
  factors: Factor[];
  votes: Record<string, number>;
  maxScale: number;
  onVote: (factorId: string, value: number) => void;
}

export const VotingCard = ({ candidate, factors, votes, maxScale, onVote }: VotingCardProps) => {
  const t = useTranslations('Voting');
  const tCommon = useTranslations('Common'); // [FIX]

  const votingFactors = factors.filter(f => !f.is_hidden && f.type === 'numerical');
  const constantFactors = factors.filter(f => !f.is_hidden && f.type === 'constant');

  const getGradientColor = (value: number, weight: number) => {
    const percent = value / maxScale;
    const isPositive = weight >= 0;
    const hue = isPositive ? percent * 120 : 120 - (percent * 120);
    return `hsla(${hue}, 70%, 40%, 0.2)`;
  };

  const renderInput = (factor: Factor, value: number) => {
    const bgStyle = { backgroundColor: getGradientColor(value, factor.weight) };
    const commonClasses = "w-full rounded-lg transition-colors duration-300 p-2 border border-white/5";

    switch (factor.input_control) {
      case 'stars':
        return (
          <div className={`${commonClasses} flex justify-center gap-1`} style={bgStyle}>
            {[1, 2, 3, 4, 5].map((star) => {
              const threshold = star * (maxScale / 5);
              const isActive = value >= threshold;
              return (
                <button
                  key={star}
                  onClick={() => onVote(factor.id, threshold)}
                  className={`transition-all hover:scale-125 ${isActive ? 'text-yellow-400 fill-yellow-400' : 'text-gray-600'}`}
                >
                  <Star size={20} />
                </button>
              );
            })}
          </div>
        );
      case 'toggle':
        return (
          <div className={`${commonClasses} flex gap-2`} style={bgStyle}>
            <button onClick={() => onVote(factor.id, maxScale)} className={`flex-1 py-1.5 rounded text-xs font-bold ${value === maxScale ? 'bg-white text-black shadow-lg' : 'bg-black/20 text-gray-400'}`}>
                {tCommon('yes')} {/* [FIX] */}
            </button>
            <button onClick={() => onVote(factor.id, 0)} className={`flex-1 py-1.5 rounded text-xs font-bold ${value === 0 ? 'bg-white text-black shadow-lg' : 'bg-black/20 text-gray-400'}`}>
                {tCommon('no')} {/* [FIX] */}
            </button>
          </div>
        );
      case 'number':
        return (
          <div className={commonClasses} style={bgStyle}>
             <input
              type="number"
              min={0} max={maxScale}
              value={value || 0}
              onChange={(e) => onVote(factor.id, Number(e.target.value))}
              className="w-full bg-transparent text-center font-mono font-bold text-white outline-none"
            />
          </div>
        );
      case 'slider':
      default:
        return (
          <div className={`${commonClasses} space-y-2`} style={bgStyle}>
             <div className="flex justify-between text-[10px] font-bold text-white/70 px-1">
               <span>0</span>
               <span className="text-white scale-110">{value.toFixed(1)}</span>
               <span>{maxScale}</span>
             </div>
             <input 
                type="range"
                min={0} max={maxScale} step={1}
                value={value}
                onChange={(e) => onVote(factor.id, Number(e.target.value))}
                className="w-full h-1.5 bg-black/30 rounded-lg appearance-none cursor-pointer accent-white"
              />
          </div>
        );
    }
  };

  return (
    <div className="glass-card p-6 hover:border-indigo-500/30 transition-all duration-300 group">
      <div className="flex items-start gap-4 mb-6">
        <SmartEntity label={candidate.name} seed={candidate.id} imageUrl={candidate.image_url} className="pointer-events-none scale-110" />
        <div className="min-w-0 flex-1">
          <div className="flex justify-between items-start">
             <SmartTooltip content={candidate.description}>
                <h3 className="font-bold text-lg text-white truncate cursor-help decoration-dotted underline-offset-4 hover:underline">
                    {candidate.name}
                </h3>
             </SmartTooltip>
          </div>
          
          <div className="flex flex-wrap gap-2 mt-2">
            {constantFactors.map(f => (
              <SmartTooltip key={f.id} content={f.description}>
                <span className="text-[10px] bg-gray-800/80 text-gray-300 px-2 py-1 rounded border border-gray-700 flex items-center gap-1 cursor-help">
                    {/* [FIX] Use Next/Image */}
                    {f.image_url && <Image src={f.image_url} width={12} height={12} className="rounded-full" alt="" />}
                    {f.name}: <span className="font-mono font-bold text-white">{candidate.static_values?.[f.id] ?? '-'}</span>
                </span>
              </SmartTooltip>
            ))}
          </div>
        </div>
      </div>

      <div className="space-y-5">
        {votingFactors.map(factor => (
          <div key={factor.id} className="space-y-1">
            <div className="flex justify-between items-center px-1">
                <SmartTooltip content={factor.description}>
                    <label className="text-xs font-bold uppercase text-gray-400 flex items-center gap-1 cursor-help hover:text-white transition-colors">
                        {factor.name}
                        {factor.weight < 0 ? <ArrowDown size={12} className="text-red-400" /> : <ArrowUp size={12} className="text-green-400" />}
                    </label>
                </SmartTooltip>
                {/* [FIX] Used translation key */}
                <span className={`text-[10px] font-mono ${factor.weight < 0 ? 'text-red-400' : 'text-green-400'}`}>
                    {t('weight_impact', { val: factor.weight })}
                </span>
            </div>
            {renderInput(factor, votes[factor.id] ?? 0)}
          </div>
        ))}
      </div>
    </div>
  );
};

================================================================================
FILE: src\widgets\voting-interface\ui\VotingFactorPanel.tsx
================================================================================
import React, { useState } from 'react';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
import { useTranslations } from 'next-intl';
import { ChevronDown, Star, ArrowUp, ArrowDown } from 'lucide-react';
import { SmartEntity } from '@/shared/ui/smart-entity';
import Image from 'next/image';


interface VotingFactorPanelProps {
  factor: Factor;
  candidates: Candidate[];
  votes: Record<string, number>; // CandidateID -> Score
  maxScale: number;
  onVote: (candidateId: string, value: number) => void;
}

export const VotingFactorPanel = ({ factor, candidates, votes, maxScale, onVote }: VotingFactorPanelProps) => {
  const [isOpen, setIsOpen] = useState(true);
  const t = useTranslations('Voting');
  
  const tCommon = useTranslations('Common'); // [FIX] Access Common keys

  // Helper: Get color based on value & weight trend
  const getColor = (value: number) => {
    const percent = value / maxScale;
    const isPositive = factor.weight >= 0;
    // Hue: 0 (Red) -> 120 (Green)
    const hue = isPositive ? percent * 120 : 120 - (percent * 120);
    return `hsl(${hue}, 70%, 50%)`;
  };

  const renderInput = (candidateId: string, value: number) => {
    const commonStyle = { accentColor: getColor(value) }; // For slider track

    switch (factor.input_control) {
      case 'stars':
        return (
          <div className="flex gap-1">
            {[1, 2, 3, 4, 5].map((s) => (
              <button key={s} onClick={() => onVote(candidateId, s * (maxScale / 5))}>
                <Star 
                  size={24} 
                  className={`transition-all ${value >= s * (maxScale / 5) ? 'fill-yellow-400 text-yellow-400' : 'text-gray-700'}`} 
                />
              </button>
            ))}
          </div>
        );
      case 'toggle':
        return (
          <div className="flex bg-black/40 rounded-lg p-1 gap-1">
            <button 
                onClick={() => onVote(candidateId, maxScale)} 
                className={`px-4 py-1.5 rounded-md text-xs font-bold transition-colors ${value === maxScale ? 'bg-green-500 text-black' : 'text-gray-400'}`}
            >
                {tCommon('yes')} {/* [FIX] Translated */}
            </button>
            <button 
                onClick={() => onVote(candidateId, 0)} 
                className={`px-4 py-1.5 rounded-md text-xs font-bold transition-colors ${value === 0 ? 'bg-red-500 text-white' : 'text-gray-400'}`}
            >
                {tCommon('no')} {/* [FIX] Translated */}
            </button>
          </div>
        );
      case 'number':
        return (
          <input 
            type="number" 
            min={0} max={maxScale} 
            step={factor.step} // Use configured step
            value={value}
            onChange={(e) => onVote(candidateId, Number(e.target.value))}
            className="w-20 bg-black/40 border border-gray-700 rounded-lg px-2 py-1 text-center font-mono text-white"
          />
        );
      default: // Slider
        return (
          <div className="flex-1 flex items-center gap-4">
            <input 
              type="range" 
              min={0} max={maxScale} 
              step={factor.step} // Use configured step
              value={value}
              onChange={(e) => onVote(candidateId, Number(e.target.value))}
              className="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer"
              style={commonStyle}
            />
            <span className="font-mono font-bold w-8 text-right" style={{ color: getColor(value) }}>
              {value}
            </span>
          </div>
        );
    }
  };

  return (
    <div className="glass-card overflow-hidden transition-all duration-500 border-l-4 border-l-indigo-500/50">
      {/* Header */}
      <div 
        onClick={() => setIsOpen(!isOpen)}
        className="p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors"
      >
        <div className="flex items-center gap-4">
          {factor.image_url ? (
            <div className="w-10 h-10 rounded-lg overflow-hidden bg-gray-900 border border-gray-700">
               <Image src={factor.image_url} alt="" width={40} height={40} className="object-cover w-full h-full" />
            </div>
          ) : (
            <div className="w-10 h-10 rounded-lg bg-gray-800 flex items-center justify-center font-bold text-gray-500">
                {factor.name.charAt(0)}
            </div>
          )}
          
          <div>
            <h3 className="font-bold text-white flex items-center gap-2">
                {factor.name}
                {factor.weight < 0 ? <ArrowDown size={14} className="text-red-400" /> : <ArrowUp size={14} className="text-green-400" />}
            </h3>
            <p className="text-xs text-gray-500 line-clamp-1">{factor.description || t('expand_to_vote')}</p>
          </div>
        </div>

        <div className="flex items-center gap-4">
            {/* Minimized DNA Bar */}
            {!isOpen && (
                <div className="flex gap-0.5 h-6 items-end opacity-70">
                    {candidates.map(c => (
                        <div 
                            key={c.id} 
                            className="w-2 rounded-t-sm transition-all"
                            style={{ 
                                height: `${((votes[c.id] || 0) / maxScale) * 100}%`,
                                backgroundColor: getColor(votes[c.id] || 0),
                                minHeight: '4px'
                            }}
                        />
                    ))}
                </div>
            )}
            <ChevronDown className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} />
        </div>
      </div>

      {/* Expanded Body */}
      {isOpen && (
        <div className="border-t border-white/5 bg-black/10">
            {candidates.map((cand) => (
                <div key={cand.id} className="p-4 flex items-center gap-4 border-b border-white/5 last:border-0 hover:bg-white/5 transition-colors">
                    {/* Centered Image Container */}
                    <div className="w-16 flex justify-center shrink-0">
                        <SmartEntity 
                            label="" 
                            seed={cand.id} 
                            imageUrl={cand.image_url} 
                            className="scale-125"
                        />
                    </div>
                    
                    <div className="flex-1">
                        <div className="flex justify-between mb-1">
                            <span className="text-sm font-bold text-gray-200">{cand.name}</span>
                            {/* Show constant values if relevant here? Optional. */}
                        </div>
                        {renderInput(cand.id, votes[cand.id] ?? 0)}
                    </div>
                </div>
            ))}
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: src\widgets\voting-interface\ui\VotingInterface.tsx
================================================================================
import React, { useState } from 'react';
import { useTranslations } from 'next-intl';
import { Candidate } from '@/entities/candidate/model/types';
import { Factor } from '@/entities/factor/model/types';
import { VotingFactorPanel } from './VotingFactorPanel'; // [NEW]
import { JollySelector } from './JollySelector';
import { useCastVote } from '@/features/cast-vote/model/useCastVote';
import { Button } from '@/shared/ui/button';

interface VotingInterfaceProps {
  lobbyId: string;
  userId: string;
  candidates: Candidate[];
  factors: Factor[];
  maxScale: number;
}

export const VotingInterface = ({ 
  lobbyId, userId, candidates, factors, maxScale 
}: VotingInterfaceProps) => {
  const t = useTranslations('Voting');
  const { localVotes, registerVote, commitVotes, isSubmitting } = useCastVote(lobbyId, userId);
  const [jollyId, setJollyId] = useState<string | null>(null);

  // Helper to invert the map: We need Candidate Votes grouped by Factor for the Panel
  // But localVotes is Record<CandidateId, Record<FactorId, Score>>
  // The panel needs logic to pull score: votes[candidateId][factor.id]
  const getVotesForFactor = (factorId: string) => {
    const map: Record<string, number> = {};
    candidates.forEach(c => {
        map[c.id] = localVotes[c.id]?.[factorId] ?? 0;
    });
    return map;
  };

  const activeFactors = factors.filter(f => !f.is_hidden && f.type === 'numerical');

  return (
    <div className="space-y-8 pb-40 max-w-3xl mx-auto"> {/* [FIX] Centered Container */}
      
      <JollySelector 
        candidates={candidates} 
        selectedId={jollyId} 
        onSelect={setJollyId} 
      />

      <div className="space-y-4">
        {activeFactors.map(factor => (
          <VotingFactorPanel
            key={factor.id}
            factor={factor}
            candidates={candidates}
            maxScale={maxScale}
            votes={getVotesForFactor(factor.id)}
            onVote={(candId, val) => registerVote(candId, factor.id, val)}
          />
        ))}
      </div>

      <div className="fixed bottom-0 left-0 w-full p-6 bg-[#030712]/90 backdrop-blur-xl border-t border-white/10 z-40">
        <div className="max-w-md mx-auto">
          <Button 
            onClick={commitVotes} 
            isLoading={isSubmitting} 
            className="w-full btn-primary py-4 text-lg shadow-2xl"
          >
            {t('submit')}
          </Button>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: tsconfig.json
================================================================================
{
  "compilerOptions": {
    "target": "es5",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "baseUrl": ".",
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
