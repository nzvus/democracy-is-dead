PROJECT TRANSCRIPT
Date: 29/12/2025, 00:34:11



================================================================================
FILE: .eslintrc.json
================================================================================
{
  "extends": [
    "next/core-web-vitals",
    "plugin:i18next/recommended"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["i18next"],
  "overrides": [
    {
      "files": ["*.tsx", "*.ts"],
      "rules": {
        "i18next/no-literal-string": [
          "error",
          {
            "markupOnly": true,
            "validateTemplate": true,
            "ignoreAttribute": [
              "className", "style", "href", "src", "alt", "key", "id", 
              "width", "height", "fill", "stroke", "viewBox", "d", 
              "target", "rel", "type", "placeholder", "as", "data-testid",
              "name", "value", "defaultValue", "role",
              "k", "label", "title", "aria-label"
            ]
          }
        ]
      }
    }
  ]
}

================================================================================
FILE: app\globals.css
================================================================================
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


================================================================================
FILE: app\layout.tsx
================================================================================
import type { Metadata, Viewport } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { LanguageProvider } from "@/components/providers/language-provider";
import { ConfirmProvider } from "@/components/providers/confirm-provider";
import { Toaster } from 'sonner';
import LanguageSwitcher from "@/components/ui/language-switcher"; 

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Votazione Collaborativa",
  description: "App per decisioni di gruppo",
};

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${inter.className} bg-gray-950 text-white overflow-x-hidden`}>
        <LanguageProvider>
          <ConfirmProvider>
             
             {}
             <LanguageSwitcher />
             
             {children}
             
             <Toaster 
                position="top-center" 
                theme="dark" 
                richColors 
                closeButton
                toastOptions={{
                    style: { background: '#111827', border: '1px solid #374151', borderRadius: '12px' },
                }}
             />
          </ConfirmProvider>
        </LanguageProvider>
      </body>
    </html>
  );
}

================================================================================
FILE: app\lobby\[code]\page.tsx
================================================================================
'use client'

import { useEffect, useState, use, useRef } from 'react'
import { createClient } from '@/lib/client'
import Link from 'next/link'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'
import { Crown, Users, Loader2 } from 'lucide-react'


import LobbyOnboarding from '@/components/lobby/lobby-onboarding'
import SetupWrapper from '@/components/lobby/setup/setup-wrapper'
import VotingWrapper from '@/components/lobby/voting/voting-wrapper'
import ResultsWrapper from '@/components/lobby/results/results-wrapper'
import LobbyChat from '@/components/lobby/lobby-chat'
import { RealtimePostgresChangesPayload } from '@supabase/supabase-js'
import { Factor } from '@/types'

interface LobbyData {
  id: string
  code: string
  host_id: string
  status: 'waiting' | 'setup' | 'voting' | 'ended'
  settings: {
      factors: Factor[];
      voting_scale?: { max: number };
      allow_decimals?: boolean;
  }
  created_at: string
}

export default function LobbyPage({ params }: { params: Promise<{ code: string }> }) {
  const { code } = use(params)
  const { t } = useLanguage()
  const supabase = createClient()

  const [lobby, setLobby] = useState<LobbyData | null>(null)
  const [userId, setUserId] = useState<string | null>(null)
  const [loading, setLoading] = useState(true)
  const [nickname, setNickname] = useState<string | null>(null)
  const [participantCount, setParticipantCount] = useState(0)
  
  
  const autoSetupTriggered = useRef(false)

  useEffect(() => {
    const init = async () => {
      
      const { data: { user }, error: authError } = await supabase.auth.getUser()
      let currentUserId = user?.id

      if (authError || !currentUserId) {
        const { data: anonUser } = await supabase.auth.signInAnonymously()
        currentUserId = anonUser.user?.id
      }
      setUserId(currentUserId || null)

      if (!currentUserId) return

      
      const { data: lobbyData, error: lobbyError } = await supabase
        .from('lobbies')
        .select('*')
        .eq('code', code)
        .single()

      if (lobbyError || !lobbyData) {
        setLoading(false)
        return
      }

      const safeLobby: LobbyData = {
          ...lobbyData,
          settings: {
              factors: lobbyData.settings?.factors || [],
              voting_scale: lobbyData.settings?.voting_scale,
              allow_decimals: lobbyData.settings?.allow_decimals
          }
      }

      setLobby(safeLobby)

      
      const { data: participants } = await supabase
        .from('lobby_participants')
        .select('nickname, user_id')
        .eq('lobby_id', lobbyData.id)

      if (participants) {
          setParticipantCount(participants.length)
          const myParticipant = participants.find(p => p.user_id === currentUserId)
          if (myParticipant) setNickname(myParticipant.nickname)
      }
      
      setLoading(false)
    }

    init()
  }, [code, supabase])

  
  useEffect(() => {
    if (!lobby) return

    const lobbyChannel = supabase.channel(`lobby_${lobby.id}`)
      .on(
        'postgres_changes',
        { event: 'UPDATE', schema: 'public', table: 'lobbies', filter: `id=eq.${lobby.id}` },
        (payload: RealtimePostgresChangesPayload<LobbyData>) => {
           if (payload.new && 'status' in payload.new) {
               setLobby(prev => prev ? ({ ...prev, ...payload.new } as LobbyData) : null)
           }
        }
      )
      .subscribe()

    const partsChannel = supabase.channel(`parts_${lobby.id}`)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'lobby_participants', filter: `lobby_id=eq.${lobby.id}` }, 
        () => {
            supabase.from('lobby_participants').select('id', { count: 'exact' }).eq('lobby_id', lobby.id)
                .then(({ count }) => setParticipantCount(count || 0))
        }
      )
      .subscribe()

    return () => { 
        supabase.removeChannel(lobbyChannel) 
        supabase.removeChannel(partsChannel)
    }
  }, [lobby?.id, supabase, lobby])

  const isHost = userId === lobby?.host_id

  
  
  
  useEffect(() => {
      const handleAutoSetup = async () => {
          if (!lobby || !nickname || !isHost) return
          
          if (lobby.status === 'waiting' && !autoSetupTriggered.current) {
              autoSetupTriggered.current = true
              
              
              setLobby(prev => prev ? { ...prev, status: 'setup' } : null)

              
              await supabase.from('lobbies').update({ status: 'setup' }).eq('id', lobby.id)
          }
      }

      handleAutoSetup()
  }, [lobby?.status, isHost, nickname, lobby?.id, supabase, lobby])


  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-950 text-white">
        <Loader2 className="animate-spin text-indigo-500 w-10 h-10" />
      </div>
    )
  }

  if (!lobby) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-950 text-white gap-6">
        <h1 className="text-4xl font-black text-red-500">404</h1>
        <p className="text-gray-400">Lobby not found.</p>
        <Link href="/" className={`px-6 py-3 bg-${UI.COLORS.PRIMARY}-600 rounded-full font-bold hover:opacity-90`}>
           Go Home
        </Link>
      </div>
    )
  }

  
  if (!nickname) {
    return <LobbyOnboarding lobbyId={lobby.id} userId={userId!} onJoin={(nick: string) => setNickname(nick)} />
  }

  return (
    <>
      {lobby.status === 'waiting' && (
        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-950 text-white p-6 relative overflow-hidden">
            <div className="absolute inset-0 bg-[url('/grid.svg')] bg-center opacity-10" />
            
            {}
            {isHost ? (
                <div className="z-10 flex flex-col items-center gap-4 animate-in fade-in">
                    <Loader2 size={64} className="text-indigo-500 animate-spin" />
                    <h2 className="text-xl font-bold">{t.lobby.loading_setup}</h2>
                </div>
            ) : (
                
                <div className="relative z-10 flex flex-col items-center text-center space-y-8 max-w-lg">
                    <div className="w-24 h-24 bg-gray-900 rounded-3xl border border-gray-800 flex items-center justify-center shadow-2xl mb-4">
                        <Loader2 size={48} className="text-indigo-500 animate-spin-slow" />
                    </div>

                    <div className="space-y-3">
                        <h1 className="text-4xl font-black tracking-tight">{t.lobby.status_waiting}</h1>
                        <p className="text-gray-400 text-lg">{t.lobby.guest_desc}</p>
                    </div>

                    <div className="bg-gray-900/50 px-6 py-3 rounded-full border border-gray-800 flex items-center gap-3">
                        <Users size={18} className="text-gray-400" />
                        <span className="font-mono font-bold text-lg">{participantCount}</span>
                        <span className="text-xs text-gray-500 uppercase tracking-widest">{t.lobby.participants_tab}</span>
                    </div>
                </div>
            )}
            
            <LobbyChat lobbyId={lobby.id} userId={userId!} />
        </div>
      )}

      {lobby.status === 'setup' && (
         isHost ? <SetupWrapper lobby={lobby} /> : (
            <div className="min-h-screen flex flex-col items-center justify-center bg-gray-950 text-white p-6">
                <div className="w-20 h-20 bg-gray-900 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <Crown size={32} className="text-gray-600" />
                </div>
                <h2 className="text-3xl font-bold text-center">{t.lobby.status_setup}</h2>
                <p className="text-gray-500 mt-4 text-center max-w-md">{t.lobby.setup_desc}</p>
                <LobbyChat lobbyId={lobby.id} userId={userId!} />
            </div>
         )
      )}

      {lobby.status === 'voting' && (
        <>
            <VotingWrapper lobby={lobby} userId={userId!} isHost={isHost} />
            <LobbyChat lobbyId={lobby.id} userId={userId!} />
        </>
      )}

      {lobby.status === 'ended' && (
        <>
            <ResultsWrapper lobby={lobby} userId={userId!} isHost={isHost} />
            <LobbyChat lobbyId={lobby.id} userId={userId!} />
        </>
      )}
    </>
  )
}

================================================================================
FILE: app\page.tsx
================================================================================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/client'
import { toast } from 'sonner'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'
import { ArrowRight, History, Vote } from 'lucide-react'


const generateCode = () => {
  return Math.random().toString(36).substring(2, 8).toUpperCase()
}

export default function Home() {
  const { t, language, setLanguage } = useLanguage()
  const router = useRouter()
  const supabase = createClient()
  
  const [isCreating, setIsCreating] = useState(false)
  const [joinCode, setJoinCode] = useState('')
  const [recentLobbies, setRecentLobbies] = useState<{code: string, date: string}[]>([])

  
  useEffect(() => {
      const history = localStorage.getItem('did_history')
      if (history) {
          try {
              setRecentLobbies(JSON.parse(history))
          } catch {
              
          }
      }
  }, [])

  const createLobby = async () => {
    setIsCreating(true)
    const toastId = toast.loading(t.home.toast_init)

    const { data: { user }, error: authError } = await supabase.auth.getUser()
    let userId = user?.id

    if (authError || !userId) {
        const { data: anonUser, error: anonError } = await supabase.auth.signInAnonymously()
        if (anonError) {
            toast.error(t.home.toast_error, { id: toastId })
            setIsCreating(false)
            return
        }
        userId = anonUser.user?.id
    }

    if (!userId) return

    const code = generateCode()
    
    
    
    const { error: lobbyError } = await supabase.from('lobbies').insert({
        code,
        host_id: userId,
        status: 'waiting',
        settings: { factors: [] }
    })

    if (lobbyError) {
        toast.error(t.home.toast_error, { id: toastId })
    } else {
        toast.success(t.home.toast_success, { id: toastId })
        saveToHistory(code)
        router.push(`/lobby/${code}`)
    }
    setIsCreating(false)
  }

  const joinLobby = async () => {
      if (joinCode.length < 6) {
          toast.error(t.home.error_code_short)
          return
      }

      const { data, error } = await supabase.from('lobbies').select('id').eq('code', joinCode.toUpperCase()).single()
      
      if (error || !data) {
          toast.error(t.home.error_lobby_not_found)
      } else {
          saveToHistory(joinCode.toUpperCase())
          router.push(`/lobby/${joinCode.toUpperCase()}`)
      }
  }

  const saveToHistory = (code: string) => {
      const newHistory = [{ code, date: new Date().toISOString() }, ...recentLobbies.filter(l => l.code !== code)].slice(0, 5)
      localStorage.setItem('did_history', JSON.stringify(newHistory))
  }

  const gridBg = `url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0V0zm1 1h38v38H1V1z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E")`

  return (
    <div className={`min-h-screen bg-gray-950 text-white flex flex-col items-center justify-center p-6 relative overflow-hidden`} style={{ backgroundImage: gridBg }}>
        
        {}
        <div className="absolute top-6 right-6 z-50">
            <button 
                onClick={() => setLanguage(language === 'it' ? 'en' : 'it')}
                className="bg-gray-900 border border-gray-800 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors"
            >
                {language === 'it' ? 'üáÆüáπ IT' : 'üá¨üáß EN'}
            </button>
        </div>

        <main className="w-full max-w-md relative z-10 flex flex-col gap-8 animate-in fade-in slide-in-from-bottom-4 duration-1000">
            
            {}
            <div className="text-center space-y-4">
                <div className="mx-auto w-20 h-20 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-3xl rotate-3 flex items-center justify-center shadow-2xl shadow-indigo-500/20 mb-6">
                    <Vote size={40} className="text-white -rotate-3" />
                </div>
                <h1 className="text-5xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-b from-white to-gray-500">
                    {t.home.title}
                </h1>
                <p className="text-gray-400 text-lg leading-relaxed">
                    {t.home.subtitle}
                </p>
            </div>

            {}
            <div className="bg-gray-900/50 backdrop-blur-xl border border-gray-800 p-6 rounded-3xl shadow-2xl space-y-6">
                
                <button 
                    onClick={createLobby}
                    disabled={isCreating}
                    className={`w-full py-4 bg-${UI.COLORS.PRIMARY}-600 hover:bg-${UI.COLORS.PRIMARY}-500 text-white font-bold rounded-xl shadow-lg transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 group`}
                >
                    {isCreating ? t.home.cta_loading : t.home.cta_button}
                    {!isCreating && <ArrowRight size={20} className="group-hover:translate-x-1 transition-transform" />}
                </button>

                <div className="relative flex items-center py-2">
                    <div className="flex-grow border-t border-gray-800"></div>
                    <span className="flex-shrink-0 mx-4 text-gray-600 text-xs font-bold uppercase tracking-widest">{t.home.or_divider}</span>
                    <div className="flex-grow border-t border-gray-800"></div>
                </div>

                <div className="flex gap-2">
                    <input 
                        value={joinCode}
                        onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                        placeholder={t.home.join_placeholder}
                        maxLength={6}
                        className={`flex-1 ${UI.COLORS.BG_INPUT} border border-gray-800 rounded-xl px-4 py-3 text-center font-mono text-lg uppercase tracking-widest focus:ring-2 focus:ring-${UI.COLORS.PRIMARY}-500 outline-none transition-all`}
                    />
                    <button 
                        onClick={joinLobby}
                        disabled={!joinCode}
                        className="px-6 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-colors disabled:opacity-50"
                    >
                        {t.home.join_btn}
                    </button>
                </div>

                <p className="text-center text-xs text-gray-600 flex items-center justify-center gap-2">
                    <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    {t.home.no_registration}
                </p>
            </div>            
            {}
            {recentLobbies.length > 0 && (
                <div className="space-y-4 pt-4 border-t border-gray-900/50">
                    <h3 className="text-gray-500 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                        <History size={14} /> {t.home.history}
                    </h3>
                    <div className="flex flex-wrap gap-2">
                        {recentLobbies.map((l) => (
                            <button 
                                key={l.code}
                                onClick={() => router.push(`/lobby/${l.code}`)}
                                className="bg-gray-900/50 hover:bg-gray-800 border border-gray-800 px-3 py-1.5 rounded-lg text-xs font-mono text-gray-300 transition-colors"
                            >
                                {l.code}
                            </button>
                        ))}
                    </div>
                </div>
            )}

        </main>
    </div>
  )
}

================================================================================
FILE: components\lobby\lobby-chat.tsx
================================================================================
'use client'

import { useState, useEffect, useRef, useCallback, useMemo } from 'react'
import { createClient } from '@/lib/client'
import { useLanguage } from '@/components/providers/language-provider'
import Avatar from '@/components/ui/avatar' 
import { toast } from 'sonner'
import { UI } from '@/lib/constants'
import { Participant } from '@/types'
import { useConfirm } from '@/components/providers/confirm-provider'

type Message = {
  id: string; user_id: string; nickname: string; content: string; created_at: string
}

export default function LobbyChat({ lobbyId, userId }: { lobbyId: string, userId: string }) {
  const { t } = useLanguage()
  const supabase = useMemo(() => createClient(), [])
  const { confirm } = useConfirm() 
  
  const [isOpen, setIsOpen] = useState(false) 
  const [activeTab, setActiveTab] = useState<'chat' | 'participants'>('chat')
  const [messages, setMessages] = useState<Message[]>([])
  const [newMessage, setNewMessage] = useState('')
  const [unreadCount, setUnreadCount] = useState(0)
  const [myNickname, setMyNickname] = useState('')
  const [participants, setParticipants] = useState<Participant[]>([])
  const [editingId, setEditingId] = useState<string | null>(null)
  const [editText, setEditText] = useState('')

  const messagesEndRef = useRef<HTMLDivElement>(null)
  const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }) }

  const toggleChat = useCallback(() => {
    setIsOpen(prev => {
        const newState = !prev;
        if (!newState) { 
            setUnreadCount(0); 
            setTimeout(scrollToBottom, 200) 
        }
        return newState;
    })
  }, [])

  
  useEffect(() => {
    const handleEsc = (event: KeyboardEvent) => {
        if (event.key === 'Escape' && isOpen) toggleChat()
    }
    window.addEventListener('keydown', handleEsc)
    return () => window.removeEventListener('keydown', handleEsc)
  }, [isOpen, toggleChat])

  
  useEffect(() => {
    const init = async () => {
        const { data: userData } = await supabase.from('lobby_participants').select('nickname').eq('lobby_id', lobbyId).eq('user_id', userId).maybeSingle()
        if (userData) setMyNickname(userData.nickname)
        const { data: parts } = await supabase.from('lobby_participants').select('*').eq('lobby_id', lobbyId)
        if (parts) setParticipants(parts)
        const { data: msgs } = await supabase.from('lobby_messages').select('*').eq('lobby_id', lobbyId).order('created_at', { ascending: true })
        if (msgs) setMessages(msgs)
        scrollToBottom()
    }
    init()
    const chatChannel = supabase.channel('chat_room_msgs')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'lobby_messages', filter: `lobby_id=eq.${lobbyId}` }, 
          (payload) => {
             if (payload.eventType === 'INSERT') {
                 const newMsg = payload.new as Message
                 setMessages((prev) => { if (prev.find(m => m.id === newMsg.id)) return prev; return [...prev, newMsg] })
                 if (!isOpen && newMsg.user_id !== userId) setUnreadCount(prev => prev + 1)
                 setTimeout(scrollToBottom, 100)
             } 
             else if (payload.eventType === 'DELETE') setMessages((prev) => prev.filter(m => m.id !== payload.old.id))
             else if (payload.eventType === 'UPDATE') setMessages((prev) => prev.map(m => m.id === payload.new.id ? { ...m, ...payload.new as Message } : m))
          })
      .subscribe()
    const partsChannel = supabase.channel('chat_room_parts')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'lobby_participants', filter: `lobby_id=eq.${lobbyId}` },
        (payload) => {
             if (payload.eventType === 'INSERT') setParticipants(prev => [...prev, payload.new as Participant])
             else if (payload.eventType === 'UPDATE') setParticipants(prev => prev.map(p => p.id === payload.new.id ? payload.new as Participant : p))
        })
      .subscribe()
    return () => { supabase.removeChannel(chatChannel); supabase.removeChannel(partsChannel) }
  }, [lobbyId, isOpen, userId, supabase]) 

  const sendMessage = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!newMessage.trim()) return
    const senderName = myNickname || t.lobby.anon_user
    const { error } = await supabase.from('lobby_messages').insert({ lobby_id: lobbyId, user_id: userId, nickname: senderName, content: newMessage })
    if (error) toast.error(t.common.error)
    else setNewMessage('')
  }

  const deleteMessage = async (msgId: string) => {
      const isConfirmed = await confirm({
          title: t.common.delete_msg_title,
          description: t.common.delete_msg_desc,
          variant: 'danger'
      })
      if (!isConfirmed) return
      setMessages(prev => prev.filter(m => m.id !== msgId)) 
      await supabase.from('lobby_messages').delete().eq('id', msgId)
  }

  const saveEdit = async (msgId: string) => {
      if (!editText.trim()) return
      setMessages(prev => prev.map(m => m.id === msgId ? { ...m, content: editText } : m)) 
      setEditingId(null)
      await supabase.from('lobby_messages').update({ content: editText }).eq('id', msgId)
  }

  return (
    <>
      <button onClick={toggleChat} className={`fixed bottom-28 md:bottom-8 right-4 z-[90] p-4 bg-${UI.COLORS.PRIMARY}-600 hover:bg-${UI.COLORS.PRIMARY}-500 rounded-full shadow-2xl transition-all hover:scale-110 group border-2 border-white/10`}>
        <span className="text-2xl">üí¨</span>
        {unreadCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full animate-bounce">{unreadCount}</span>}
      </button>

      <div className={`fixed inset-y-0 right-0 w-[85vw] md:w-96 bg-gray-900/95 backdrop-blur-xl border-l border-gray-800 shadow-2xl transform transition-transform duration-300 ease-in-out z-[100] flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
        
        <div className="p-4 border-b border-gray-800 bg-gray-950 flex flex-col gap-4">
            <div className="flex justify-between items-center">
                 <h2 className="font-bold text-lg flex items-center gap-2">{t.lobby.hub_title}</h2>
                 <button 
                    onClick={toggleChat} 
                    className="p-2 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition-colors"
                    title={t.common.close}
                 >
                    ‚úñÔ∏è
                 </button>
            </div>
            <div className="flex bg-gray-800 rounded-lg p-1">
                <button onClick={() => setActiveTab('chat')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'chat' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}>{t.lobby.chat_tab}</button>
                <button onClick={() => setActiveTab('participants')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'participants' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}>{t.lobby.participants_tab} ({participants.length})</button>
            </div>
        </div>

        <div className="flex-1 overflow-y-auto custom-scrollbar bg-gray-900/50">
            {activeTab === 'chat' && (
                <div className="p-4 space-y-1 min-h-full flex flex-col justify-end">
                    {messages.length === 0 && <div className="text-center text-gray-500 mb-auto mt-10 italic text-sm">{t.lobby.chat_empty}</div>}
                    {messages.map((msg, index) => {
                        const isMe = msg.user_id === userId
                        const isSequence = index > 0 && messages[index - 1].user_id === msg.user_id
                        const isEditing = editingId === msg.id
                        
                        const author = participants.find(p => p.user_id === msg.user_id)
                        
                        return (
                            <div key={msg.id} className={`flex gap-3 group ${isMe ? 'flex-row-reverse' : ''} ${isSequence ? 'mt-0.5' : 'mt-4'}`}>
                                <div className="w-8 shrink-0 flex flex-col items-center">
                                    {!isSequence && <Avatar src={author?.avatar_url} seed={msg.user_id} className="w-8 h-8" />}
                                </div>
                                <div className={`max-w-[85%] relative ${isMe ? `bg-${UI.COLORS.PRIMARY}-600 text-white rounded-2xl ${isSequence ? 'rounded-tr-md' : 'rounded-tr-none'}` : `bg-gray-800 text-gray-200 rounded-2xl border border-gray-700 ${isSequence ? 'rounded-tl-md' : 'rounded-tl-none'}`}`}>
                                    <div className="px-4 py-2">
                                        {!isMe && !isSequence && <div className="text-[10px] font-bold mb-1 opacity-50 text-indigo-300">{msg.nickname}</div>}
                                        {isEditing ? (
                                            <div className="flex flex-col gap-2 min-w-[200px]">
                                                <input value={editText} onChange={(e) => setEditText(e.target.value)} className="bg-black/20 rounded p-1 text-sm outline-none w-full" autoFocus />
                                                <div className="flex justify-end gap-2">
                                                    <button onClick={() => setEditingId(null)} className="text-[10px] uppercase opacity-70 hover:opacity-100">{t.common.cancel}</button>
                                                    <button onClick={() => saveEdit(msg.id)} className="text-[10px] uppercase font-bold hover:text-green-300">{t.common.save}</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <p className="break-words leading-relaxed text-sm">{msg.content}</p>
                                        )}
                                    </div>
                                    {isMe && !isEditing && (
                                        <div className="absolute -top-3 left-0 -translate-x-full hidden group-hover:flex gap-1 pr-2">
                                            <button onClick={() => { setEditingId(msg.id); setEditText(msg.content); }} className="w-6 h-6 bg-gray-700 rounded-full flex items-center justify-center hover:bg-white hover:text-black text-xs transition-colors">‚úé</button>
                                            <button onClick={() => deleteMessage(msg.id)} className="w-6 h-6 bg-gray-700 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white text-xs transition-colors">üóë</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )
                    })}
                    <div ref={messagesEndRef} />
                </div>
            )}
            {activeTab === 'participants' && (
                <div className="p-4 space-y-2">
                    {participants.map(p => (
                        <div key={p.id} className="flex items-center justify-between bg-gray-800 p-3 rounded-xl border border-gray-700">
                             <div className="flex items-center gap-3">
                                 <Avatar src={p.avatar_url} seed={p.user_id} className="w-10 h-10" />
                                 <div>
                                     <p className="font-bold text-sm text-white">{p.nickname}</p>
                                     <p className="text-[10px] text-gray-500 uppercase font-bold">
                                        {p.user_id === userId ? t.results.my_vote : t.lobby.participant_role}
                                     </p>
                                 </div>
                             </div>
                             {p.has_voted && <span className="text-green-400 bg-green-900/20 px-2 py-1 rounded text-[10px] font-bold border border-green-500/30">{t.lobby.voted_badge}</span>}
                        </div>
                    ))}
                </div>
            )}
        </div>
        
        {activeTab === 'chat' && (
            <form onSubmit={sendMessage} className="p-4 border-t border-gray-800 bg-gray-900 pb-8 md:pb-4">
                <div className="flex gap-2">
                    <input value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder={t.lobby.chat.placeholder} className={`flex-1 ${UI.COLORS.BG_INPUT} rounded-full px-4 py-3 text-sm focus:ring-2 focus:ring-${UI.COLORS.PRIMARY}-500 outline-none transition-all`} />
                    <button type="submit" disabled={!newMessage.trim()} className={`bg-${UI.COLORS.PRIMARY}-600 hover:bg-${UI.COLORS.PRIMARY}-500 disabled:opacity-50 text-white rounded-full w-12 h-12 flex items-center justify-center transition-all shadow-lg`}>‚û§</button>
                </div>
            </form>
        )}
      </div>

      {isOpen && <div onClick={toggleChat} className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[95]" />}
    </>
  )
}

================================================================================
FILE: components\lobby\lobby-onboarding.tsx
================================================================================
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/client'
import { useLanguage } from '@/components/providers/language-provider'
import Avatar from '@/components/ui/avatar'
import { toast } from 'sonner'
import { UI } from '@/lib/constants'

export default function LobbyOnboarding({ lobbyId, userId, onJoin }: { lobbyId: string, userId: string, onJoin: (nickname: string) => void }) {
  const { t } = useLanguage()
  const supabase = createClient()
  
  const [nickname, setNickname] = useState('')
  const [loading, setLoading] = useState(false)
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!nickname.trim()) return

    setLoading(true)
    
    
    
    const payload = {
        lobby_id: lobbyId,
        user_id: userId,
        nickname: nickname.trim(),
        
    }

    const { error } = await supabase.from('lobby_participants').upsert(payload as any)

    if (error) {
        console.error("Supabase Error:", error)
        toast.error(`Error: ${error.message}`) 
        setLoading(false)
    } else {
        onJoin(nickname.trim())
    }
  }

  
  const gridBg = `url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0V0zm1 1h38v38H1V1z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E")`

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-950 p-4 relative overflow-hidden" style={{ backgroundImage: gridBg }}>
      
      <div className={`w-full max-w-md bg-gray-900/90 backdrop-blur-xl border border-gray-800 p-8 rounded-3xl shadow-2xl relative z-10 animate-in fade-in zoom-in-95 duration-500`}>
          <div className="text-center space-y-3 mb-8">
              <h1 className="text-3xl font-black text-white tracking-tight">{t.onboarding.title}</h1>
              <p className="text-gray-400 text-sm">{t.onboarding.subtitle}</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-8">
              <div className="flex justify-center">
                  <div className="relative group">
                      <div className={`absolute -inset-1 bg-gradient-to-r from-${UI.COLORS.PRIMARY}-600 to-purple-600 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200`}></div>
                      <Avatar seed={nickname || "guest"} className="w-24 h-24 text-4xl relative" />
                  </div>
              </div>

              <div className="space-y-2">
                  <label className="text-xs font-bold uppercase text-gray-500 tracking-wider ml-1">{t.onboarding.label_nickname}</label>
                  <input 
                    type="text" 
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    placeholder={t.onboarding.placeholder_nickname}
                    className={`w-full bg-gray-950 border border-gray-800 rounded-xl px-5 py-4 text-white text-lg focus:ring-2 focus:ring-${UI.COLORS.PRIMARY}-500 focus:border-transparent outline-none transition-all placeholder:text-gray-700`}
                    maxLength={20}
                    autoFocus
                  />
              </div>

              <button 
                type="submit" 
                disabled={loading || !nickname.trim()}
                className={`w-full py-4 bg-${UI.COLORS.PRIMARY}-600 hover:bg-${UI.COLORS.PRIMARY}-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-xl shadow-lg shadow-${UI.COLORS.PRIMARY}-900/20 transition-all transform active:scale-[0.98]`}
              >
                {loading ? t.common.loading : t.onboarding.join_btn}
              </button>
          </form>
      </div>
    </div>
  )
}

================================================================================
FILE: components\lobby\results\comparison-chart.tsx
================================================================================
'use client'

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer
} from 'recharts'
import { VotingResult } from '@/core/voting/types' 
import { useLanguage } from '@/components/providers/language-provider'

interface ComparisonChartProps {
  weighted: VotingResult
  borda: VotingResult
  schulze: VotingResult
}

export default function ComparisonChart({ weighted, borda, schulze }: ComparisonChartProps) {
  const { t } = useLanguage()

  
  
  const allCandidates = weighted.ranking.map(c => c.name)

  const data = allCandidates.map(name => {
    
    
    const getRank = (res: VotingResult) => {
      const idx = res.ranking.findIndex(c => c.name === name)
      return idx === -1 ? 0 : idx + 1
    }

    return {
      name,
      Weighted: getRank(weighted),
      Borda: getRank(borda),
      Schulze: getRank(schulze),
    }
  })

  return (
    <div className="w-full h-[400px] bg-gray-900/50 rounded-xl p-4 border border-gray-800">
      <h3 className="text-center font-bold text-gray-400 mb-4">{t.results.charts.compare_title}</h3>
      <ResponsiveContainer width="100%" height="100%">
        <BarChart
          data={data}
          margin={{ top: 20, right: 30, left: 20, bottom: 5 }} 
        >
          <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
          <XAxis dataKey="name" stroke="#9CA3AF" />
          {}
          <YAxis stroke="#9CA3AF" reversed label={{ value: 'Rank (Lower is Better)', angle: -90, position: 'insideLeft', fill: '#6B7280' }} />
          <Tooltip 
            contentStyle={{ backgroundColor: '#111827', borderColor: '#374151', color: '#F3F4F6' }}
            cursor={{ fill: '#1F2937' }}
          />
          <Legend />
          <Bar dataKey="Weighted" fill="#8884d8" name={t.results.systems.weighted.title} />
          <Bar dataKey="Borda" fill="#82ca9d" name={t.results.systems.borda.title} />
          <Bar dataKey="Schulze" fill="#ffc658" name={t.results.systems.schulze.title} />
        </BarChart>
      </ResponsiveContainer>
    </div>
  )
}

================================================================================
FILE: components\lobby\results\podium.tsx
================================================================================
'use client'

import { Candidate } from '@/types'
import Avatar from '@/components/ui/avatar'
import { motion } from 'framer-motion'

export default function Podium({ top3 }: { top3: Candidate[] }) {
  if (top3.length === 0) return null

  const winner = top3[0]
  const second = top3[1]
  const third = top3[2]

  return (
    <div className="flex justify-center items-end gap-2 md:gap-4 h-64 md:h-80 w-full max-w-lg mx-auto mb-8 px-4">
      
      {second && (
        <motion.div 
            initial={{ height: 0, opacity: 0 }} animate={{ height: '60%', opacity: 1 }} transition={{ delay: 0.2 }}
            className="w-1/3 bg-gradient-to-t from-gray-800 to-gray-700 rounded-t-xl relative flex flex-col items-center justify-end pb-4 border-t-4 border-gray-400"
        >
            <div className="absolute -top-12 md:-top-16 flex flex-col items-center">
                <Avatar seed={second.name} src={second.image_url} className="w-12 h-12 md:w-16 md:h-16 border-4 border-gray-400 shadow-xl" />
                <span className="font-bold text-xs md:text-sm mt-2 text-gray-300 text-center line-clamp-2 max-w-[80px]">{second.name}</span>
            </div>
            <span className="text-4xl font-black text-gray-500/20">2</span>
        </motion.div>
      )}

      <motion.div 
          initial={{ height: 0, opacity: 0 }} animate={{ height: '80%', opacity: 1 }}
          className="w-1/3 bg-gradient-to-t from-yellow-900/50 to-yellow-600 rounded-t-xl relative flex flex-col items-center justify-end pb-4 border-t-4 border-yellow-400 z-10 shadow-[0_0_50px_-10px_rgba(250,204,21,0.3)]"
      >
          <div className="absolute -top-16 md:-top-20 flex flex-col items-center">
             <div className="relative">
                <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-3xl animate-bounce">üëë</span>
                <Avatar seed={winner.name} src={winner.image_url} className="w-16 h-16 md:w-20 md:h-20 border-4 border-yellow-400 shadow-2xl" />
             </div>
             <span className="font-bold text-sm md:text-base mt-2 text-yellow-400 text-center line-clamp-2 max-w-[100px]">{winner.name}</span>
          </div>
          <span className="text-5xl font-black text-yellow-900/30">1</span>
      </motion.div>

      {third && (
        <motion.div 
            initial={{ height: 0, opacity: 0 }} animate={{ height: '40%', opacity: 1 }} transition={{ delay: 0.4 }}
            className="w-1/3 bg-gradient-to-t from-orange-900/50 to-orange-800 rounded-t-xl relative flex flex-col items-center justify-end pb-4 border-t-4 border-orange-600"
        >
             <div className="absolute -top-12 md:-top-16 flex flex-col items-center">
                <Avatar seed={third.name} src={third.image_url} className="w-12 h-12 md:w-16 md:h-16 border-4 border-orange-600 shadow-xl" />
                <span className="font-bold text-xs md:text-sm mt-2 text-orange-300 text-center line-clamp-2 max-w-[80px]">{third.name}</span>
            </div>
            <span className="text-4xl font-black text-orange-900/20">3</span>
        </motion.div>
      )} 
    </div>
  )
}

================================================================================
FILE: components\lobby\results\ranking-table.tsx
================================================================================
'use client'

import { Candidate } from '@/types'
import Avatar from '@/components/ui/avatar'
import { Trophy, Medal } from 'lucide-react'
import DescriptionTooltip from '@/components/ui/description-tooltip'

interface RankingTableProps {
  results: Candidate[]
  scores: Record<string, number>
  system: 'weighted' | 'borda' | 'schulze'
}

export default function RankingTable({ results, scores, system }: RankingTableProps) {
  
  const formatScore = (val: number) => {
      if (val === undefined) return "-"
      if (system === 'weighted') return val.toFixed(2)
      if (system === 'borda') return Math.round(val) + " pts"
      if (system === 'schulze') return val + " wins"
      return val
  }

  return (
    <div className="w-full bg-gray-900/50 rounded-xl border border-gray-800 overflow-hidden">
        {results.map((candidate, index) => {
            const isWinner = index === 0
            const score = scores[candidate.id] || 0

            return (
                <div 
                    key={candidate.id} 
                    className={`flex items-center gap-4 p-4 border-b border-gray-800 last:border-0 transition-colors ${isWinner ? 'bg-yellow-500/10' : 'hover:bg-white/5'}`}
                >
                    <div className="w-8 flex justify-center font-black text-lg">
                        {index === 0 ? <Trophy className="text-yellow-500" size={24} /> : 
                         index === 1 ? <Medal className="text-gray-400" size={20} /> :
                         index === 2 ? <Medal className="text-orange-700" size={20} /> :
                         <span className="text-gray-600">#{index + 1}</span>}
                    </div>

                    {}
                    <Avatar seed={candidate.name} src={candidate.image_url} className="w-10 h-10 md:w-12 md:h-12 shadow-lg" />
                    
                    <div className="flex-1 min-w-0">
                        {}
                        <DescriptionTooltip title={candidate.name} description={candidate.description}>
                            <h4 className={`font-bold truncate cursor-help ${isWinner ? 'text-yellow-500' : 'text-gray-200'}`}>
                                {candidate.name}
                            </h4>
                        </DescriptionTooltip>
                    </div>

                    <div className="text-right">
                        <span className="block font-mono font-bold text-lg md:text-xl text-white">
                            {formatScore(score)}
                        </span>
                        <span className="text-[10px] uppercase tracking-widest text-gray-600">
                            {system === 'borda' ? 'Points' : 'Score'}
                        </span>
                    </div>
                </div>
            )
        })}
    </div>
  )
} 

================================================================================
FILE: components\lobby\results\results-chart.tsx
================================================================================
'use client'

import { Candidate } from '@/types'

interface ResultsChartProps {
  results: Candidate[]
}


export default function ResultsChart({ results }: ResultsChartProps) {
  return (
      <div className="flex items-center justify-center h-full text-gray-500 text-sm italic p-4 text-center">
          Dettagli Radar disponibili prossimamente.<br/>
          (I dati attuali non sono sufficienti per generare il grafico radar per fattore)
      </div>
  ) 
}

================================================================================
FILE: components\lobby\results\results-matrix.tsx
================================================================================
'use client'

import { Candidate, Participant } from '@/types'
import { useLanguage } from '@/components/providers/language-provider'
import Avatar from '@/components/ui/avatar'
import DescriptionTooltip from '@/components/ui/description-tooltip' 
import { BadgeType, getBadgeIcon } from '@/core/gamification/awards'
import { VoteRecord } from '@/core/voting/types'

interface ResultsMatrixProps {
  candidates: Candidate[]
  participants: Participant[]
  votes: VoteRecord[] 
  currentUserId: string
  badges: Record<string, BadgeType[]>
}

export default function ResultsMatrix({ candidates, participants, votes, currentUserId, badges }: ResultsMatrixProps) {
  const { t } = useLanguage()

  const activeParticipants = participants.filter(p => p.has_voted)

  return (
    <div className="w-full overflow-x-auto bg-gray-900/50 rounded-xl border border-gray-800">
      <table className="w-full text-xs md:text-sm">
        <thead>
          <tr>
            <th className="p-3 bg-gray-900/80 sticky left-0 z-10 min-w-[140px] text-left">
               <span className="text-gray-500 font-normal">{t.results.matrix_anon}</span>
            </th>
            {candidates.map(c => (
              <th key={c.id} className="p-3 min-w-[80px] text-center font-normal text-gray-500">
                 <div className="flex flex-col items-center gap-1">
                     <Avatar seed={c.name} className="w-6 h-6 opacity-70" />
                     <span className="truncate max-w-[80px]">{c.name}</span>
                 </div>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {activeParticipants.map((p) => {
             const isMe = p.user_id === currentUserId
             const userBadges = badges[p.user_id] || []

             return (
               <tr key={p.id} className={`border-t border-gray-800 ${isMe ? 'bg-indigo-900/10' : ''}`}>
                 <td className="p-3 bg-gray-900/80 sticky left-0 z-10 font-bold text-gray-300 flex flex-col justify-center min-w-[140px]">
                    <div className="flex items-center gap-2">
                        <Avatar seed={p.nickname || "Anon"} className="w-6 h-6" />
                        <span className={isMe ? 'text-indigo-400' : ''}>
                            {p.nickname || t.results.matrix_anon} {isMe && t.results.my_vote}
                        </span>
                    </div>
                    {userBadges.length > 0 && (
                        <div className="flex gap-1 mt-1 ml-8">
                            {userBadges.map(b => (
                                <DescriptionTooltip 
                                    key={b} 
                                    title={t.results.badges[b]}
                                    description={t.results.badges_desc[b]}
                                >
                                    <span className="text-sm cursor-help">{getBadgeIcon(b)}</span>
                                </DescriptionTooltip>
                            ))}
                        </div>
                    )}
                 </td>

                 {candidates.map(c => {
                    const vote = votes.find(v => v.voter_id === p.user_id && v.candidate_id === c.id)
                    let avg = 0
                    if (vote && vote.scores) {
                        const vals = Object.values(vote.scores) as number[]
                        if (vals.length > 0) avg = vals.reduce((a,b)=>a+b,0) / vals.length
                    }
                    
                    return (
                        <td key={c.id} className="p-3 text-center border-l border-gray-800/50">
                            {vote ? (
                                <span className={`font-mono font-bold ${avg >= 8 ? 'text-green-400' : avg <= 4 ? 'text-red-400' : 'text-gray-400'}`}>
                                    {avg.toFixed(1)}
                                    {vote.is_jolly && <span className="ml-1 text-yellow-500">‚òÖ</span>}
                                </span>
                            ) : (
                                <span className="text-gray-700">-</span>
                            )}
                        </td>
                    )
                 })}
               </tr>
             )
          })}
        </tbody>
      </table>
    </div>
  )
} 

================================================================================
FILE: components\lobby\results\results-wrapper.tsx
================================================================================
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/lib/client'
import { toast } from 'sonner'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'
import { Candidate, Participant, Factor } from '@/types'
import { useConfirm } from '@/components/providers/confirm-provider' 

import { calculateAllSystems } from '@/core/voting/engine'
import { calculateAwards, BadgeType } from '@/core/gamification/awards'
import { VotingResult, VoteRecord } from '@/core/voting/types'

import RankingTable from './ranking-table'
import Podium from './podium'
import ShareLobby from '../share-lobby'
import InfoButton from '@/components/ui/info-button'
import ResultsMatrix from './results-matrix'
import SchulzeMatrix from './schulze-matrix'
import ComparisonChart from './comparison-chart'
import { RefreshCcw } from 'lucide-react' 

interface LobbySettings {
    factors: Factor[];
    voting_scale?: { max: number };
    allow_decimals?: boolean;
}

interface ResultsWrapperProps {
  lobby: {
      id: string;
      code: string;
      settings: LobbySettings; 
  }
  isHost: boolean 
  userId: string
}

interface SchulzeDetails {
    matrix: Record<string, Record<string, number>>;
    winners: string[];
}

export default function ResultsWrapper({ lobby, userId, isHost }: ResultsWrapperProps) {
  const { t } = useLanguage()
  const supabase = createClient()
  const { confirm } = useConfirm() 
  
  const [results, setResults] = useState<Record<string, VotingResult> | null>(null)
  const [activeSystem, setActiveSystem] = useState<'weighted' | 'borda' | 'schulze'>('weighted')
  const [badges, setBadges] = useState<Record<string, BadgeType[]>>({})
  
  const [rawCandidates, setRawCandidates] = useState<Candidate[]>([])
  const [rawVotes, setRawVotes] = useState<VoteRecord[]>([]) 
  const [participants, setParticipants] = useState<Participant[]>([])

  const [loading, setLoading] = useState(true)

  
  useEffect(() => {
    const init = async () => {
      try {
        const [c, v, p] = await Promise.all([
            supabase.from('candidates').select('*').eq('lobby_id', lobby.id),
            supabase.from('votes').select('*').eq('lobby_id', lobby.id),
            supabase.from('lobby_participants').select('*').eq('lobby_id', lobby.id)
        ])

        const candidates = c.data || []
        const votes = v.data || []
        const parts = p.data || []
        
        const settings = (lobby.settings || {}) as unknown as LobbySettings
        const factors = settings.factors || []
        const maxScale = settings.voting_scale?.max || 10

        setRawCandidates(candidates)
        setRawVotes(votes)
        setParticipants(parts)

        if (candidates.length > 0) {
            const calculated = calculateAllSystems(candidates, votes, factors, maxScale)
            setResults(calculated)
            const calculatedBadges = calculateAwards(parts, votes, calculated.schulze)
            setBadges(calculatedBadges)
        }
      } catch (e) {
        console.error(e)
        toast.error(t.common.error)
      } finally {
        setLoading(false)
      }
    }
    init()
    
  }, [lobby.id]) 

  
  const handleReopen = async () => {
      const confirmed = await confirm({
          title: t.results.reopen_btn,
          description: t.results.reopen_confirm,
          variant: 'danger',
          confirmText: t.common.yes
      })

      if (confirmed) {
          const { error } = await supabase.from('lobbies').update({ status: 'voting' }).eq('id', lobby.id)
          if (error) toast.error(t.common.error)
          else toast.success("Voting Reopened!")
      }
  }

  if (loading || !results) return <div className="min-h-screen flex items-center justify-center text-white"><span className="animate-spin text-4xl">‚è≥</span></div>

  const activeResult = results[activeSystem]
  const schulzeDetails = activeSystem === 'schulze' ? (activeResult.details as unknown as SchulzeDetails) : null

  return (
    <div className={`min-h-screen bg-gray-950 text-white ${UI.LAYOUT.PADDING_X} pb-32 pt-6 flex flex-col items-center overflow-x-hidden`}>
      <div className="w-full max-w-5xl space-y-12 flex flex-col">
        
        <header className="flex flex-col items-center gap-6 relative z-30">
            <ShareLobby code={lobby.code} compact={true} />
            
            {}
            <div className="flex bg-gray-900 p-1 rounded-2xl border border-gray-800 shadow-xl overflow-x-auto max-w-full">
                {(['weighted', 'borda', 'schulze'] as const).map((sys) => (
                    <button 
                        key={sys} 
                        onClick={() => setActiveSystem(sys)} 
                        className={`px-6 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2 whitespace-nowrap
                            ${activeSystem === sys ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'text-gray-500 hover:text-gray-300'}
                        `}
                    >
                        {t.results.systems[sys].title}
                        <InfoButton topicKey={sys} className={activeSystem === sys ? "text-indigo-200" : "text-gray-600"} />
                    </button>
                ))}
            </div>
        </header>

        <section className="mt-4 z-10">
            <Podium top3={activeResult.ranking.slice(0, 3)} />
        </section>

        <div className="grid lg:grid-cols-2 gap-8">
            <section className="space-y-4">
                 <div className="flex items-center gap-2 px-1">
                    <h3 className="font-bold text-gray-400 text-xs uppercase tracking-widest">{t.results.ranking_title}</h3>
                </div>
                <RankingTable results={activeResult.ranking} scores={activeResult.scores} system={activeSystem} />
            </section>

            <section className="space-y-8">
                {activeSystem === 'schulze' && schulzeDetails ? (
                    <SchulzeMatrix candidates={rawCandidates} matrix={schulzeDetails.matrix} />
                ) : (
                    <div className="bg-gray-900/30 border border-gray-800 rounded-2xl p-6 min-h-[400px]">
                        <ComparisonChart weighted={results.weighted} borda={results.borda} schulze={results.schulze} />
                    </div>
                )}
            </section>
        </div>

        <section className="w-full space-y-4 pt-8 border-t border-gray-900">
             <div className="flex items-center gap-2 mb-2 px-1">
                <h3 className="font-bold text-gray-400 text-xs uppercase tracking-widest">{t.results.matrix_title}</h3>
            </div>
            <ResultsMatrix candidates={rawCandidates} participants={participants} votes={rawVotes} currentUserId={userId} badges={badges} />
        </section>

        {}
        {isHost && (
            <div className="fixed bottom-6 left-0 w-full flex justify-center z-50 pointer-events-none">
                <button 
                    onClick={handleReopen}
                    className="pointer-events-auto bg-red-900/80 hover:bg-red-800 border border-red-500/50 text-white px-6 py-3 rounded-full font-bold shadow-2xl backdrop-blur-xl flex items-center gap-2 transition-all hover:scale-105"
                >
                    <RefreshCcw size={18} /> {t.results.reopen_btn}
                </button>
            </div>
        )}
      </div>
    </div>
  ) 
}

================================================================================
FILE: components\lobby\results\schulze-matrix.tsx
================================================================================
'use client'

import { Candidate } from '@/types'
import { useLanguage } from '@/components/providers/language-provider'
import Avatar from '@/components/ui/avatar'
import InfoButton from '@/components/ui/info-button'

interface SchulzeMatrixProps {
  candidates: Candidate[]
  matrix: Record<string, Record<string, number>>
}

export default function SchulzeMatrix({ candidates, matrix }: SchulzeMatrixProps) {
  const { t } = useLanguage()

  return (
    <div className="w-full overflow-hidden bg-gray-900/50 rounded-xl border border-gray-800">
      <div className="p-4 border-b border-gray-800 flex items-center justify-between">
         <h4 className="font-bold text-sm text-gray-300 flex items-center gap-2">
            {t.results.schulze_matrix.title}
            <InfoButton topicKey="schulze" />
         </h4>
      </div>
      
      <div className="overflow-x-auto">
        <table className="w-full text-xs md:text-sm">
          <thead>
            <tr>
              <th className="p-3 bg-gray-900/80 sticky left-0 z-10"></th>
              {candidates.map(c => (
                <th key={c.id} className="p-3 min-w-[60px] text-center font-normal text-gray-500">
                  <div className="flex flex-col items-center gap-1">
                     <Avatar seed={c.name} className="w-6 h-6 opacity-70" />
                     <span className="truncate max-w-[60px]">{c.name}</span>
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {candidates.map(rowC => (
              <tr key={rowC.id} className="border-t border-gray-800 hover:bg-white/5 transition-colors">
                <td className="p-3 bg-gray-900/80 sticky left-0 z-10 font-bold text-gray-300 flex items-center gap-2 min-w-[120px]">
                    <Avatar seed={rowC.name} className="w-6 h-6" />
                    {rowC.name}
                </td>
                {candidates.map(colC => {
                    if (rowC.id === colC.id) {
                        return <td key={colC.id} className="bg-gray-800/50"></td>
                    }
                    
                    const wins = matrix[rowC.id]?.[colC.id] || 0
                    const losses = matrix[colC.id]?.[rowC.id] || 0
                    const isWinner = wins > losses
                    const isTie = wins === losses

                    return (
                        <td key={colC.id} className={`p-3 text-center border-l border-gray-800/50 ${isWinner ? 'text-green-400 font-bold bg-green-900/10' : isTie ? 'text-gray-500' : 'text-red-900/50'}`}>
                            {wins}
                        </td>
                    )
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="p-2 bg-gray-950 text-[10px] text-gray-500 text-center font-mono">
         {t.results.schulze_matrix.subtitle}
      </div>
    </div>
  ) 
}

================================================================================
FILE: components\lobby\setup\candidates-manager.tsx
================================================================================
'use client'

import { useState } from 'react'
import { Candidate } from '@/types'
import { Trash2, Edit2 } from 'lucide-react'
import Avatar from '@/components/ui/avatar'
import ImagePicker from '@/components/ui/image-picker' 
import { UI } from '@/lib/constants'
import { useLanguage } from '@/components/providers/language-provider'

interface CandidatesManagerProps {
  candidates: Candidate[]
  setCandidates: (c: Candidate[]) => void
} 

export default function CandidatesManager({ candidates, setCandidates }: CandidatesManagerProps) {
  const { t } = useLanguage()
  const [isEditing, setIsEditing] = useState<string | null>(null)
  
  const [name, setName] = useState('')
  const [desc, setDesc] = useState('')
  const [img, setImg] = useState('') 

  const handleAdd = () => {
    if (!name.trim()) return
    const newCand: Candidate = {
        id: crypto.randomUUID(),
        name,
        description: desc,
        image_url: img || null,
        lobby_id: '' 
    }
    setCandidates([...candidates, newCand])
    resetForm()
  }

  const handleUpdate = () => {
    if (!name.trim() || !isEditing) return
    setCandidates(candidates.map(c => c.id === isEditing ? { ...c, name, description: desc, image_url: img || null } : c))
    resetForm()
    setIsEditing(null)
  }

  const resetForm = () => {
      setName('')
      setDesc('')
      setImg('')
  }

  const startEdit = (c: Candidate) => {
      setIsEditing(c.id)
      setName(c.name)
      setDesc(c.description || '')
      setImg(c.image_url || '')
  }

  return (
    <div className="space-y-6">
        <div className="bg-gray-900 p-4 rounded-xl border border-gray-800 space-y-4">
             <div className="flex gap-4">
                 <div className="w-16 h-16 rounded-full flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-700 shadow-xl">
                     <Avatar seed={name || "?"} src={img} className="w-full h-full text-2xl" />
                 </div>
                 <div className="flex-1 space-y-3">
                     <input 
                        value={name} onChange={e => setName(e.target.value)}
                        placeholder={t.setup.candidates.placeholder_name}
                        className={`w-full ${UI.COLORS.BG_INPUT} p-2 rounded-lg border border-gray-700 font-bold focus:border-${UI.COLORS.PRIMARY}-500 outline-none`}
                     />
                     <input 
                        value={desc} onChange={e => setDesc(e.target.value)}
                        placeholder={t.setup.candidates.placeholder_desc}
                        className={`w-full ${UI.COLORS.BG_INPUT} p-2 rounded-lg border border-gray-700 text-sm focus:border-${UI.COLORS.PRIMARY}-500 outline-none`}
                     />
                     {}
                     <ImagePicker value={img} onChange={setImg} placeholder={t.setup.candidates.placeholder_url} />
                 </div>
             </div>

             <div className="flex justify-end gap-2 pt-2">
                 {isEditing && <button onClick={() => { setIsEditing(null); resetForm() }} className="text-sm text-gray-500 hover:text-white px-3">{t.setup.candidates.cancel_btn}</button>}
                 <button 
                    onClick={isEditing ? handleUpdate : handleAdd}
                    disabled={!name.trim()}
                    className={`px-6 py-2 bg-${UI.COLORS.PRIMARY}-600 text-white rounded-lg font-bold hover:opacity-90 disabled:opacity-50 transition-all shadow-lg`}
                 >
                    {isEditing ? t.setup.candidates.update_btn : t.setup.candidates.add_btn}
                 </button>
             </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {candidates.map(c => (
                <div key={c.id} className="bg-gray-800 p-3 rounded-lg border border-gray-700 flex items-center justify-between group hover:border-gray-600 transition-colors">
                    <div className="flex items-center gap-3 overflow-hidden">
                        <Avatar seed={c.name} src={c.image_url} className="w-10 h-10 flex-shrink-0 shadow-sm" />
                        <div className="min-w-0">
                            <p className="font-bold truncate text-gray-200">{c.name}</p>
                            <p className="text-xs text-gray-500 truncate">{c.description}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <button onClick={() => startEdit(c)} className="p-2 text-indigo-400 hover:bg-gray-700 rounded-lg"><Edit2 size={16}/></button>
                        <button onClick={() => setCandidates(candidates.filter(x => x.id !== c.id))} className="p-2 text-red-400 hover:bg-gray-700 rounded-lg"><Trash2 size={16}/></button>
                    </div>
                </div>
            ))}
            {candidates.length === 0 && <p className="col-span-full text-center text-gray-500 py-8 italic">{t.setup.candidates.empty_list}</p>}
        </div>
    </div>
  )
}

================================================================================
FILE: components\lobby\setup\factors-manager.tsx
================================================================================
'use client'

import { useState } from 'react'
import { Factor } from '@/types'
import { Plus, Trash2, Info } from 'lucide-react'
import DescriptionTooltip from '@/components/ui/description-tooltip'
import { UI } from '@/lib/constants'
import { useLanguage } from '@/components/providers/language-provider'

interface FactorsManagerProps {
  factors: Factor[]
  setFactors: (f: Factor[]) => void
} 

export default function FactorsManager({ factors, setFactors }: FactorsManagerProps) {
  const { t } = useLanguage()
  const [newName, setNewName] = useState('')
  const [newDesc, setNewDesc] = useState('')
  const [newImage, setNewImage] = useState('')

  const handleAddFactor = () => {
     if (!newName.trim()) return
     
     const newFactor: Factor = {
         id: crypto.randomUUID(), 
         name: newName,
         description: newDesc,
         image_url: newImage,
         weight: 1, 
         trend: 'higher_better',
         type: 'numerical' as any
     }

     setFactors([...factors, newFactor])
     setNewName('')
     setNewDesc('')
     setNewImage('')
  }

  const removeFactor = (id: string) => {
      setFactors(factors.filter(f => f.id !== id))
  }

  const updateFactor = (id: string, field: keyof Factor, value: string | number) => {
      setFactors(factors.map(f => f.id === id ? { ...f, [field]: value } : f))
  }

  return (
    <div className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
             {}
             <div className="bg-gray-900 p-4 rounded-xl border border-gray-800 space-y-3">
                 <h3 className="font-bold text-sm text-gray-400 uppercase">{t.setup.factors.new_title}</h3>
                 <input 
                    placeholder={t.setup.factors.placeholder_name} 
                    value={newName} 
                    onChange={e => setNewName(e.target.value)}
                    className={`w-full ${UI.COLORS.BG_INPUT} p-2 rounded border border-gray-700`}
                 />
                 <input 
                    placeholder={t.setup.factors.placeholder_desc} 
                    value={newDesc} 
                    onChange={e => setNewDesc(e.target.value)}
                    className={`w-full ${UI.COLORS.BG_INPUT} p-2 rounded border border-gray-700 text-sm`}
                 />
                 <input 
                    placeholder={t.setup.factors.placeholder_url} 
                    value={newImage} 
                    onChange={e => setNewImage(e.target.value)}
                    className={`w-full ${UI.COLORS.BG_INPUT} p-2 rounded border border-gray-700 text-xs font-mono`}
                 />
                 <button 
                    onClick={handleAddFactor}
                    disabled={!newName.trim()}
                    className={`w-full py-2 bg-${UI.COLORS.PRIMARY}-600 rounded font-bold hover:opacity-90 disabled:opacity-50 flex items-center justify-center gap-2`}
                 >
                    <Plus size={16} /> {t.setup.factors.add_btn}
                 </button>
             </div>

             {}
             <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                 {factors.map(factor => (
                     <div key={factor.id} className="bg-gray-800 p-3 rounded-lg border border-gray-700 flex flex-col gap-2">
                         <div className="flex justify-between items-start">
                             <div className="flex items-center gap-2">
                                 {}
                                 {factor.image_url && <img src={factor.image_url} alt="" className="w-6 h-6 object-cover rounded" />}
                                 <span className="font-bold">{factor.name}</span>
                                 {factor.description && (
                                     <DescriptionTooltip title={factor.name} description={factor.description}>
                                         <Info size={14} className="text-gray-500" />
                                     </DescriptionTooltip>
                                 )}
                             </div>
                             <button onClick={() => removeFactor(factor.id)} className="text-red-400 hover:text-red-300">
                                 <Trash2 size={16} />
                             </button>
                         </div>
                         
                         <div className="grid grid-cols-2 gap-2 text-xs">
                             <div>
                                 <label className="text-gray-500 block">{t.setup.factors.label_weight}</label>
                                 <input 
                                    type="number" 
                                    min="1" max="10"
                                    value={factor.weight}
                                    onChange={e => updateFactor(factor.id, 'weight', parseInt(e.target.value))}
                                    className="bg-gray-900 w-full p-1 rounded border border-gray-700"
                                 />
                             </div>
                             <div>
                                 <label className="text-gray-500 block">{t.setup.factors.label_trend}</label>
                                 <select 
                                    value={factor.trend}
                                    onChange={e => updateFactor(factor.id, 'trend', e.target.value)}
                                    className="bg-gray-900 w-full p-1 rounded border border-gray-700"
                                 >
                                     <option value="higher_better">{t.setup.factors.trend_high}</option>
                                     <option value="lower_better">{t.setup.factors.trend_low}</option>
                                 </select>
                             </div>
                         </div>
                     </div>
                 ))}
                 {factors.length === 0 && <p className="text-gray-500 text-center text-sm py-4">{t.setup.factors.empty_list}</p>}
             </div>
        </div>
    </div>
  )
}

================================================================================
FILE: components\lobby\setup\settings-form.tsx
================================================================================
'use client'

import { UI } from '@/lib/constants'
import { useLanguage } from '@/components/providers/language-provider'

interface SettingsFormProps {
    scale: { min: number; max: number };
    setScale: (val: { min: number; max: number }) => void;
}

export default function SettingsForm({ scale, setScale }: SettingsFormProps) {
  const { t } = useLanguage()

  return ( 
    <div className="space-y-6">
        <div className="bg-gray-900 p-6 rounded-xl border border-gray-800 space-y-4">
            <h3 className="font-bold text-gray-300 uppercase tracking-widest text-sm">{t.setup.settings.title}</h3>
            
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-500 mb-1">{t.setup.settings.min}</label>
                    <input 
                        type="number"
                        value={scale.min}
                        disabled
                        className={`w-full ${UI.COLORS.BG_INPUT} p-3 rounded-lg border border-gray-700 opacity-50 cursor-not-allowed`}
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-gray-500 mb-1">{t.setup.settings.max}</label>
                    <input 
                        type="number"
                        min="5" max="100"
                        value={scale.max}
                        onChange={(e) => setScale({ ...scale, max: parseInt(e.target.value) })}
                        className={`w-full ${UI.COLORS.BG_INPUT} p-3 rounded-lg border border-gray-700 focus:ring-2 focus:ring-${UI.COLORS.PRIMARY}-500`}
                    />
                </div>
            </div>
            <p className="text-xs text-gray-500">
                {t.setup.settings.desc}
            </p>
        </div>
    </div>
  )
}

================================================================================
FILE: components\lobby\setup\setup-wrapper.tsx
================================================================================
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/client'
import { toast } from 'sonner'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'
import { Factor, Candidate } from '@/types'

import SettingsForm from './settings-form'
import CandidatesManager from './candidates-manager'
import FactorsManager from './factors-manager'

interface SetupWrapperProps {
  lobby: {
      id: string;
      code: string;
      settings: any; 
  }
} 

export default function SetupWrapper({ lobby }: SetupWrapperProps) {
  const { t } = useLanguage()
  const supabase = createClient()
  
  const [step, setStep] = useState<1 | 2 | 3>(1)
  const [loading, setLoading] = useState(false)

  const [votingScale, setVotingScale] = useState({ min: 0, max: 10 })
  const [factors, setFactors] = useState<Factor[]>([])
  const [candidates, setCandidates] = useState<Candidate[]>([])

  const handleSave = async () => {
      setLoading(true)
      
      const settings = {
          voting_scale: votingScale,
          factors: factors,
          allow_decimals: false 
      }
      
      const { error: lErr } = await supabase.from('lobbies').update({ settings, status: 'voting' }).eq('id', lobby.id)
      if (lErr) { toast.error(t.common.error); setLoading(false); return }

      if (candidates.length > 0) {
          const payload = candidates.map(c => ({
              lobby_id: lobby.id,
              name: c.name,
              description: c.description,
              image_url: c.image_url
          }))
          const { error: cErr } = await supabase.from('candidates').insert(payload)
          if (cErr) { console.error(cErr); toast.error("Error saving candidates"); }
      }

      setLoading(false)
      toast.success(t.common.saved)
  }

  return (
    <div className={`min-h-screen bg-gray-950 text-white ${UI.LAYOUT.PADDING_X} py-8`}>
        <div className={`max-w-2xl mx-auto space-y-8`}>
            
            <div className="text-center space-y-2">
                <h1 className="text-3xl font-black tracking-tight">{t.setup.header.title}</h1>
                <div className="flex justify-center gap-2">
                    {[1, 2, 3].map(s => (
                        <div key={s} className={`h-2 w-12 rounded-full transition-colors ${step >= s ? `bg-${UI.COLORS.PRIMARY}-500` : 'bg-gray-800'}`} />
                    ))}
                </div>
                <p className="text-gray-400 text-sm font-bold uppercase tracking-widest pt-2">
                    {step === 1 ? t.setup.header.step_1 : step === 2 ? t.setup.header.step_2 : t.setup.header.step_3}
                </p>
            </div>

            <div className="bg-gray-900/50 border border-gray-800 p-6 md:p-8 rounded-2xl shadow-xl min-h-[400px]">
                {step === 1 && <SettingsForm scale={votingScale} setScale={setVotingScale} />}
                {step === 2 && <CandidatesManager candidates={candidates} setCandidates={setCandidates} />}
                {step === 3 && <FactorsManager factors={factors} setFactors={setFactors} />}
            </div>

            <div className="flex justify-between pt-4">
                <button 
                    onClick={() => setStep(prev => Math.max(1, prev - 1) as any)}
                    disabled={step === 1}
                    className="px-6 py-3 rounded-xl font-bold text-gray-400 hover:bg-gray-800 disabled:opacity-0 transition-all"
                >
                    {t.setup.buttons.back}
                </button>

                {step < 3 ? (
                    <button 
                        onClick={() => setStep(prev => Math.min(3, prev + 1) as any)}
                        className={`px-8 py-3 bg-white text-black rounded-xl font-bold hover:scale-105 transition-transform`}
                    >
                        {t.setup.buttons.next}
                    </button>
                ) : (
                    <button 
                        onClick={handleSave}
                        disabled={loading || candidates.length < 2}
                        className={`px-8 py-3 bg-${UI.COLORS.PRIMARY}-600 text-white rounded-xl font-bold hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-${UI.COLORS.PRIMARY}-900/20`}
                    >
                        {loading ? t.setup.buttons.saving : t.setup.buttons.start}
                    </button>
                )}
            </div>

        </div>
    </div>
  )
}

================================================================================
FILE: components\lobby\share-lobby.tsx
================================================================================
'use client'

import { useState } from 'react'
import { toast } from 'sonner'
import { QRCodeSVG } from 'qrcode.react'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'

interface ShareLobbyProps {
  code: string
  className?: string
  compact?: boolean 
}

export default function ShareLobby({ code, className = '', compact = false }: ShareLobbyProps) {
  const { t } = useLanguage()
  const [showQR, setShowQR] = useState(false)

  const lobbyUrl = typeof window !== 'undefined' ? `${window.location.origin}/lobby/${code}` : ''

  const copyLink = () => {
    navigator.clipboard.writeText(lobbyUrl)
    toast.success("Link copiato!")
  }

  return (
    <div className={`${className}`}>
      {}
      <div className={`flex items-center gap-2 ${compact ? 'justify-end' : 'justify-center w-full'}`}>
        
        {}
        <button 
            onClick={copyLink}
            className={`flex items-center gap-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white px-4 py-2 ${UI.LAYOUT.ROUNDED_MD} transition-all active:scale-95`}
            title="Copy Link"
        >
            <span className="font-mono font-bold tracking-widest text-lg">{code}</span>
            <span className="opacity-50 text-xs uppercase font-bold">üìã</span>
        </button>

        {}
        <button 
            onClick={() => setShowQR(true)}
            className={`bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-2.5 ${UI.LAYOUT.ROUNDED_MD} transition-all active:scale-95`}
            title={t.lobby.voting.scan_to_join}
        >
            üì±
        </button>
      </div>

      {}
      {showQR && (
        <div 
            className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200"
            onClick={() => setShowQR(false)}
        >
            <div 
                className={`w-full max-w-sm bg-white text-black p-8 rounded-3xl flex flex-col items-center shadow-2xl scale-100 animate-in zoom-in-95 duration-200 relative`}
                onClick={(e) => e.stopPropagation()}
            >
                <button  
                    onClick={() => setShowQR(false)}
                    className="absolute top-4 right-4 text-gray-400 hover:text-black transition-colors font-bold text-xl"
                >
                    √ó
                </button>

                <h3 className="font-black text-2xl mb-6 tracking-tight text-center">Join Lobby</h3>
                
                <div className="p-4 bg-white rounded-xl shadow-[0_0_40px_rgba(0,0,0,0.1)] mb-6">
                    <QRCodeSVG value={lobbyUrl} size={200} />
                </div>

                <div className="bg-gray-100 px-6 py-3 rounded-xl font-mono text-2xl font-bold tracking-[0.2em] mb-2">
                    {code}
                </div>
                
                <p className="text-gray-500 text-xs uppercase font-bold tracking-wider text-center">
                    {t.lobby.voting.scan_to_join}
                </p>
                
                <button 
                    onClick={copyLink}
                    className="mt-6 w-full py-3 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-colors"
                >
                    Copy Link
                </button>
            </div>
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: components\lobby\share-modal.tsx
================================================================================
'use client'

import { useState } from 'react'
import { toast } from 'sonner'
import { QRCodeSVG } from 'qrcode.react'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'

interface ShareLobbyProps {
  code: string
  className?: string
  compact?: boolean
}

export default function ShareLobby({ code, className = '', compact = false }: ShareLobbyProps) {
  const { t } = useLanguage()
  const [showQR, setShowQR] = useState(false)

  
  const lobbyUrl = typeof window !== 'undefined' ? `${window.location.origin}/lobby/${code}` : ''

  const copyLink = () => {
    if (!lobbyUrl) return
    navigator.clipboard.writeText(lobbyUrl)
    toast.success(t.common.link_copied)
  }

  return (
    <div className={`${className}`}>
      {}
      <div className={`flex items-center gap-2 ${compact ? 'justify-end' : 'justify-center w-full'}`}>
        
        {}
        <button 
            onClick={copyLink}
            className={`flex items-center gap-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white px-4 py-2 ${UI.LAYOUT.ROUNDED_MD} transition-all active:scale-95 group`}
            title={t.common.copy_link}
        >
            <span className="font-mono font-bold tracking-widest text-lg group-hover:text-yellow-400 transition-colors">{code}</span>
            <span className="opacity-50 text-xs uppercase font-bold border-l border-gray-600 pl-3">üìã</span>
        </button>

        {}
        <button 
            onClick={() => setShowQR(true)}
            className={`bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-2.5 ${UI.LAYOUT.ROUNDED_MD} transition-all active:scale-95`}
            title={t.lobby.voting.scan_to_join}
        >
            üì±
        </button>
      </div>

      {}
      {showQR && (
        <div 
            className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200"
            onClick={() => setShowQR(false)}
        >
            <div 
                className={`w-full max-w-sm bg-white text-black p-8 rounded-3xl flex flex-col items-center shadow-2xl animate-in zoom-in-95 duration-200 relative`}
                onClick={(e) => e.stopPropagation()}
            >
                {}
                <button 
                    onClick={() => setShowQR(false)} 
                    className="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-500 hover:text-black font-bold text-lg transition-colors"
                >
                    √ó
                </button>

                <h3 className="font-black text-2xl mb-2 tracking-tight text-center">{t.lobby.join_lobby}</h3>
                <p className="text-gray-400 text-xs font-bold uppercase tracking-widest mb-6">{t.lobby.voting.scan_to_join}</p>
                
                {}
                <div className="p-4 bg-white rounded-xl shadow-lg mb-6 border border-gray-100">
                    <QRCodeSVG value={lobbyUrl} size={220} />
                </div>

                {}
                <div 
                    onClick={copyLink}
                    className="bg-gray-100 hover:bg-gray-200 cursor-pointer px-8 py-4 rounded-2xl font-mono text-3xl font-black tracking-[0.2em] mb-2 border border-gray-200 transition-colors active:scale-95 text-center w-full"
                >
                    {code}
                </div>
                
                <p className="text-gray-400 text-[10px] uppercase font-bold tracking-wider text-center mt-2">
                    {t.lobby.voting.click_details}
                </p>
            </div>
        </div>
      )} 
    </div>
  )
}

================================================================================
FILE: components\lobby\voting\jolly-selector.tsx
================================================================================
'use client'

import { Candidate } from '@/types'
import Avatar from '@/components/ui/avatar'

interface JollySelectorProps {
    candidates: Candidate[]
    selectedId: string | null
    onSelect: (id: string) => void
}
 
export default function JollySelector({ candidates, selectedId, onSelect }: JollySelectorProps) {
  if (candidates.length === 0) return null

  return (
    <div className="space-y-4">
        <div className="bg-gradient-to-r from-yellow-900/20 to-transparent p-4 rounded-xl border border-yellow-500/20">
            <h3 className="font-bold text-yellow-500 flex items-center gap-2">
                Assegna il tuo Jolly üÉè
            </h3>
            <p className="text-xs text-yellow-200/60 mt-1">
                Hai un solo bonus speciale. Scegli il tuo campione indiscusso.
            </p>
        </div>

        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
            {candidates.map(c => {
                const isSelected = selectedId === c.id
                return (
                    <button
                        key={c.id}
                        onClick={() => onSelect(c.id)}
                        className={`relative p-3 rounded-xl border transition-all duration-200 flex flex-col items-center gap-2 group
                            ${isSelected 
                                ? 'bg-yellow-500/10 border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.2)]' 
                                : 'bg-gray-900 border-gray-800 hover:border-gray-600 hover:bg-gray-800'
                            }
                        `}
                    >
                        {isSelected && <div className="absolute top-2 right-2 text-yellow-500 animate-bounce">‚òÖ</div>}
                        <Avatar seed={c.name} src={c.image_url} className={`w-12 h-12 ${isSelected ? 'ring-2 ring-yellow-500' : 'opacity-70 group-hover:opacity-100'}`} />
                        <span className={`text-xs font-bold truncate w-full text-center ${isSelected ? 'text-yellow-400' : 'text-gray-400'}`}>
                            {c.name}
                        </span>
                    </button>
                )
            })}
        </div> 
    </div>
  )
}

================================================================================
FILE: components\lobby\voting\voting-factor-section.tsx
================================================================================

'use client'

import { Factor, Candidate } from '@/types'
import { useLanguage } from '@/components/providers/language-provider'
import Avatar from '@/components/ui/avatar'
import { Info, ChevronDown, CheckCircle2 } from 'lucide-react'
import { motion, AnimatePresence } from 'framer-motion'

interface VotingFactorSectionProps {
    factor: Factor
    isActive: boolean
    candidates: Candidate[]
    votes: Record<string, Record<string, number>> 
    maxScale: number
    step: number
    isHost: boolean
    onToggle: () => void
    onVote: (candId: string, val: number) => void
    onStaticUpdate: (candId: string, val: number) => void 
}

export default function VotingFactorSection({ factor, isActive, candidates, votes, maxScale, step, onToggle, onVote }: VotingFactorSectionProps) {
  const { t } = useLanguage()

  
  const votedCount = candidates.filter(c => (votes[c.id]?.[factor.id] ?? -1) >= 0).length
  const isComplete = votedCount === candidates.length && candidates.length > 0

  const getBarColor = (val: number) => {
      const p = val / maxScale
      if (p < 0.4) return 'from-red-500 to-orange-500'
      if (p < 0.7) return 'from-yellow-500 to-amber-500'
      return 'from-emerald-500 to-green-400'
  }

  return (
    <motion.div 
        initial={false}
        animate={{ 
            backgroundColor: isActive ? 'rgba(17, 24, 39, 0.95)' : 'rgba(31, 41, 55, 0.4)',
            borderColor: isActive ? 'rgba(99, 102, 241, 0.5)' : 'rgba(75, 85, 99, 0.4)',
            scale: isActive ? 1.01 : 1,
            y: isActive ? -4 : 0
        }}
        className={`rounded-3xl border backdrop-blur-md transition-all duration-500 shadow-xl overflow-hidden`}
    >
        {}
        <div onClick={onToggle} className="p-5 flex items-center justify-between cursor-pointer group hover:bg-white/5 transition-colors">
            <div className="flex items-center gap-4">
                {}
                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center shadow-inner transition-colors duration-300 ${isActive ? 'bg-indigo-600 text-white shadow-indigo-500/40' : 'bg-gray-800 text-gray-400'}`}>
                    {factor.image_url ? (
                        <img src={factor.image_url} alt="" className="w-full h-full object-cover rounded-2xl" />
                    ) : (
                        <span className="font-black text-2xl">{factor.name.charAt(0)}</span>
                    )}
                </div>
                
                <div>
                    <div className="flex items-center gap-3">
                        <h3 className={`font-bold text-xl ${isActive ? 'text-white' : 'text-gray-200'}`}>{factor.name}</h3>
                        {isComplete && !isActive && (
                            <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} className="flex items-center gap-1 text-green-400 bg-green-400/10 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border border-green-400/20">
                                <CheckCircle2 size={12} /> Completato
                            </motion.div>
                        )}
                    </div>
                    <div className="flex items-center gap-3 text-xs font-medium text-gray-500 mt-1">
                        <span className="bg-gray-800/80 px-2 py-0.5 rounded-md border border-gray-700/50">
                            Peso: <span className="text-gray-300 font-bold">{factor.weight}</span>
                        </span>
                        <span className={isComplete ? 'text-green-500' : 'text-gray-500'}>{votedCount}/{candidates.length} Votati</span>
                    </div>
                </div>
            </div>
            
            <div className={`w-8 h-8 rounded-full flex items-center justify-center border border-white/5 bg-white/5 transition-transform duration-300 ${isActive ? 'rotate-180 bg-indigo-500/20 border-indigo-500/30 text-indigo-300' : 'text-gray-500 group-hover:text-white'}`}>
                <ChevronDown size={16} />
            </div>
        </div>

        {}
        <AnimatePresence>
            {isActive && (
                <motion.div 
                    initial={{ height: 0, opacity: 0 }}
                    animate={{ height: 'auto', opacity: 1 }}
                    exit={{ height: 0, opacity: 0 }}
                    transition={{ duration: 0.3, ease: "easeInOut" }}
                    className="border-t border-gray-800/50"
                >
                    <div className="p-5 pt-4 space-y-8">
                        
                        {}
                        <div className="bg-gradient-to-r from-blue-950/40 to-indigo-950/40 border border-indigo-500/20 p-4 rounded-xl flex gap-3 items-start">
                            <div className="p-2 bg-indigo-500/20 rounded-lg text-indigo-300">
                                <Info size={18} />
                            </div>
                            <div className="space-y-1">
                                <p className="text-sm text-indigo-100 font-medium leading-relaxed">
                                    {factor.description || "Valuta i candidati basandoti su questo criterio."}
                                </p>
                                <p className="text-[10px] uppercase font-bold tracking-wider text-indigo-400/70">
                                    {factor.trend === 'higher_better' ? t.lobby.voting.trend_info_high : t.lobby.voting.trend_info_low}
                                </p>
                            </div>
                        </div>

                        {}
                        <div className="grid gap-6 md:grid-cols-2">
                            {candidates.map(cand => {
                                const currentVal = votes[cand.id]?.[factor.id] ?? 0
                                const percentage = (currentVal / maxScale) * 100
                                
                                return (
                                    <div key={cand.id} className="bg-gray-900/60 rounded-2xl p-5 border border-gray-800 hover:border-gray-600 transition-all duration-300 relative overflow-hidden group">
                                        
                                        {}
                                        <div className="absolute bottom-0 left-0 h-1.5 w-full bg-gray-800/50">
                                            <div 
                                                className={`h-full bg-gradient-to-r ${getBarColor(currentVal)} transition-all duration-500`} 
                                                style={{ width: `${percentage}%` }}
                                            />
                                        </div>

                                        <div className="flex justify-between items-start mb-6 relative z-10">
                                            <div className="flex items-center gap-3">
                                                <Avatar seed={cand.name} src={cand.image_url} className="w-12 h-12 shadow-lg ring-2 ring-black/50" />
                                                <div>
                                                    <span className="font-bold text-base text-gray-100 block">{cand.name}</span>
                                                    <span className="text-[11px] text-gray-500 truncate max-w-[140px] block">{cand.description || "Nessuna descrizione"}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="text-right">
                                                <span className={`text-3xl font-black font-mono tracking-tight transition-colors duration-300 ${currentVal > 0 ? 'text-white' : 'text-gray-700'}`}>
                                                    {currentVal}
                                                </span>
                                                <span className="text-[10px] text-gray-600 font-bold uppercase block -mt-1">su {maxScale}</span>
                                            </div> 
                                        </div>

                                        {}
                                        <div className="relative h-10 flex items-center w-full z-20">
                                            <input 
                                                type="range"
                                                min={0} max={maxScale} step={step}
                                                value={currentVal}
                                                onChange={(e) => onVote(cand.id, parseFloat(e.target.value))}
                                                className="absolute w-full h-full opacity-0 cursor-pointer z-30"
                                            />
                                            
                                            {}
                                            <div className="w-full h-3 bg-gray-950 rounded-full overflow-hidden relative shadow-inner border border-gray-800/50">
                                                <div 
                                                    className={`absolute top-0 left-0 h-full bg-gradient-to-r ${getBarColor(currentVal)} opacity-50`} 
                                                    style={{ width: `${percentage}%` }}
                                                />
                                            </div>
                                            
                                            {}
                                            <div 
                                                className="absolute h-6 w-6 bg-white rounded-full shadow-[0_0_15px_rgba(255,255,255,0.3)] border-4 border-gray-900 pointer-events-none transition-all duration-75 ease-out flex items-center justify-center"
                                                style={{ left: `calc(${percentage}% - 12px)` }}
                                            >
                                                <div className={`w-1.5 h-1.5 rounded-full ${currentVal > 0 ? 'bg-indigo-600' : 'bg-gray-400'}`} />
                                            </div>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </motion.div>
            )}
        </AnimatePresence>
    </motion.div>
  )
}

================================================================================
FILE: components\lobby\voting\voting-wrapper.tsx
================================================================================
'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@/lib/client'
import { toast } from 'sonner'
import { useLanguage } from '@/components/providers/language-provider'
import { UI } from '@/lib/constants'
import { Factor, Candidate } from '@/types'
import ShareLobby from '@/components/lobby/share-lobby'
import VotingFactorSection from './voting-factor-section'
import JollySelector from './jolly-selector'
import { useConfirm } from '@/components/providers/confirm-provider'

interface VotingWrapperProps {
    lobby: {
        id: string;
        code: string;
        settings: any; 
    }
    userId: string
    isHost: boolean
}

export default function VotingWrapper({ lobby, userId, isHost }: VotingWrapperProps) {
  const { t } = useLanguage()
  const supabase = createClient()
  const { confirm } = useConfirm()
  
  const [candidates, setCandidates] = useState<Candidate[]>([])
  const [votes, setVotes] = useState<Record<string, Record<string, number>>>({})
  const [jollyId, setJollyId] = useState<string | null>(null)
  
  const [loading, setLoading] = useState(false)
  const [hasSubmitted, setHasSubmitted] = useState(false)
  
  const factors: Factor[] = lobby.settings.factors || []
  
  const [activeFactorId, setActiveFactorId] = useState<string | null>(null)

  const maxScale = lobby.settings.voting_scale?.max || 10
  const step = lobby.settings.allow_decimals ? 0.1 : 1

  useEffect(() => {
    const init = async () => {
        const { data: cands } = await supabase.from('candidates').select('*').eq('lobby_id', lobby.id).order('name')
        if (cands) setCandidates(cands)

        const { data: existingVotes } = await supabase.from('votes').select('*').eq('lobby_id', lobby.id).eq('voter_id', userId)
        if (existingVotes && existingVotes.length > 0) {
            const voteMap: Record<string, Record<string, number>> = {}
            let savedJolly: string | null = null
            
            existingVotes.forEach((v: any) => { 
                voteMap[v.candidate_id] = v.scores
                if (v.is_jolly) savedJolly = v.candidate_id 
            })
            
            setVotes(voteMap)
            setJollyId(savedJolly)
            setHasSubmitted(true)
        }
        if (factors.length > 0) setActiveFactorId(factors[0].id)
    }
    init()
    
    
  }, [lobby.id, userId, supabase]) 

  const handleVote = (candId: string, factId: string, val: number) => {
    const safeVal = Math.min(Math.max(val, 0), maxScale)
    setVotes(prev => ({ ...prev, [candId]: { ...(prev[candId] || {}), [factId]: safeVal } }))
    setHasSubmitted(false) 
  }

  const submitAll = async () => {
    setLoading(true)
    const payload = candidates.map(c => ({
        lobby_id: lobby.id,
        voter_id: userId,
        candidate_id: c.id,
        scores: votes[c.id] || {},
        is_jolly: c.id === jollyId, 
        updated_at: new Date().toISOString()
    }))
    
    const { error } = await supabase.from('votes').upsert(payload, { onConflict: 'voter_id,candidate_id' })
    await supabase.from('lobby_participants').update({ has_voted: true }).eq('lobby_id', lobby.id).eq('user_id', userId)
    
    if (error) toast.error(t.common.error)
    else { toast.success(t.lobby.voting.submitted_msg); setHasSubmitted(true) }
    setLoading(false)
  }

  const endVoting = async () => {
    const isConfirmed = await confirm({
        title: t.lobby.terminate_btn,
        description: t.lobby.terminate_confirm,
        confirmText: "Termina Voto",
        variant: 'danger'
    })
    if (!isConfirmed) return;
    await supabase.from('lobbies').update({ status: 'ended' }).eq('id', lobby.id)
  }

  return (
    <div className={`min-h-screen bg-gray-950 text-white ${UI.LAYOUT.PADDING_X} pb-52 flex flex-col items-center relative`}>
        <header className={`w-full ${UI.LAYOUT.MAX_WIDTH_CONTAINER} flex items-start justify-between mt-6 mb-6`}>
             <div className="space-y-1">
                <h1 className="text-2xl font-bold tracking-tight">{t.lobby.voting.title}</h1>
                <p className="text-gray-400 text-xs">{t.lobby.voting.subtitle}</p>
             </div>
             <ShareLobby code={lobby.code} compact={true} />
        </header>

        <div className={`w-full ${UI.LAYOUT.MAX_WIDTH_CONTAINER} space-y-12`}>
            <div className="space-y-6">
                {factors.map((factor) => (
                    <VotingFactorSection 
                        key={factor.id} 
                        factor={factor} 
                        isActive={activeFactorId === factor.id} 
                        candidates={candidates} 
                        votes={votes} 
                        maxScale={maxScale} 
                        step={step} 
                        isHost={isHost}
                        onToggle={() => setActiveFactorId(activeFactorId === factor.id ? null : factor.id)}
                        onVote={(candId, val) => handleVote(candId, factor.id, val)}
                        onStaticUpdate={() => {}} 
                    />
                ))}
            </div>

            <hr className="border-gray-800" />

            <JollySelector 
                candidates={candidates} 
                selectedId={jollyId} 
                onSelect={(id) => { setJollyId(id); setHasSubmitted(false) }} 
            />
        </div>

        <div className={`fixed bottom-0 left-0 w-full p-6 bg-gray-950/95 backdrop-blur-xl border-t border-gray-800 z-50 flex flex-col gap-3 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]`}>
            <button onClick={submitAll} disabled={loading} className={`w-full ${UI.LAYOUT.MAX_WIDTH_CONTAINER} mx-auto py-4 ${UI.LAYOUT.ROUNDED_MD} font-black text-lg shadow-xl transition-all active:scale-[0.98] flex items-center justify-center gap-2 ${hasSubmitted ? 'bg-gray-800 text-green-400 border border-green-900/50' : `bg-gradient-to-r from-${UI.COLORS.PRIMARY}-600 to-${UI.COLORS.PRIMARY}-700 text-white shadow-${UI.COLORS.PRIMARY}-900/30`}`}>
                {loading ? t.common.loading : (hasSubmitted ? t.lobby.voting.submitted_msg : t.lobby.voting.submit_btn)}
            </button>
            {isHost && <button onClick={endVoting} className={`w-full ${UI.LAYOUT.MAX_WIDTH_CONTAINER} mx-auto py-3 bg-red-950/20 text-red-400 border border-red-900/30 ${UI.LAYOUT.ROUNDED_MD} font-bold text-xs uppercase tracking-widest hover:bg-red-900/40 transition-colors`}>{t.lobby.terminate_btn}</button>}
        </div>
    </div>
  ) 
}

================================================================================
FILE: components\providers\auth-provider.tsx
================================================================================
'use client'

import { createContext, useContext, useEffect, useState, ReactNode } from 'react'
import { createClient } from '@/lib/client'
import { User } from '@supabase/supabase-js'

interface AuthContextType {
  user: User | null
  loading: boolean
}

const AuthContext = createContext<AuthContextType>({ user: null, loading: true })

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)
  const supabase = createClient()

  useEffect(() => {
    
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null)
      setLoading(false)
    })

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user ?? null)
    })

    return () => subscription.unsubscribe()
  }, [supabase.auth]) 

  return (
    <AuthContext.Provider value={{ user, loading }}>
      {children}
    </AuthContext.Provider>
  )
}

export const useAuth = () => useContext(AuthContext) 

================================================================================
FILE: components\providers\confirm-provider.tsx
================================================================================
'use client'

import { createContext, useContext, useState, ReactNode } from 'react'
import { useLanguage } from '@/components/providers/language-provider'

interface ConfirmOptions {
  title: string
  description?: string
  confirmText?: string
  cancelText?: string
  variant?: 'danger' | 'info'
}

interface ConfirmContextType {
  confirm: (options: ConfirmOptions) => Promise<boolean>
}

const ConfirmContext = createContext<ConfirmContextType | undefined>(undefined)

export function ConfirmProvider({ children }: { children: ReactNode }) {
  const { t } = useLanguage()
  const [options, setOptions] = useState<ConfirmOptions | null>(null)
  const [resolveRef, setResolveRef] = useState<((value: boolean) => void) | null>(null)

  const confirm = (opts: ConfirmOptions) => {
    return new Promise<boolean>((resolve) => {
      setOptions(opts)
      setResolveRef(() => resolve)
    })
  }

  const handleClose = (value: boolean) => {
    setOptions(null)
    if (resolveRef) resolveRef(value)
  }

  return (
    <ConfirmContext.Provider value={{ confirm }}>
      {children}
      {options && (
        <div 
            className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in zoom-in-95 duration-200 p-4"
            onClick={() => handleClose(false)} 
        >
          <div 
              className="bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden"
              onClick={(e) => e.stopPropagation()} 
          >
            <div className="p-6">
              <h3 className="text-lg font-bold text-white mb-2">{options.title}</h3>
              <p className="text-gray-400 text-sm leading-relaxed">{options.description}</p>
            </div>
            <div className="bg-gray-950 p-4 flex justify-end gap-3 border-t border-gray-800">
              <button
                onClick={() => handleClose(false)}
                className="px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors"
              >
                {}
                {options.cancelText || t.common.cancel}
              </button>
              <button
                onClick={() => handleClose(true)}
                className={`px-4 py-2 rounded-lg text-sm font-bold text-white shadow-lg transition-transform active:scale-95 ${
                  options.variant === 'danger' 
                    ? 'bg-red-600 hover:bg-red-500 shadow-red-900/20' 
                    : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-900/20'
                }`}
              >
                {}
                {options.confirmText || t.common.confirm}
              </button>
            </div>
          </div>
        </div>
      )}
    </ConfirmContext.Provider> 
  )
}

export function useConfirm() {
  const context = useContext(ConfirmContext)
  if (!context) throw new Error("useConfirm must be used within a ConfirmProvider")
  return context
}

================================================================================
FILE: components\providers\language-provider.tsx
================================================================================
'use client'

import React, { createContext, useContext, useState, ReactNode } from 'react'


import itCommon from '@/locales/it/common'
import itHome from '@/locales/it/home'
import itSetup from '@/locales/it/setup'
import itLobby from '@/locales/it/lobby'
import itResults from '@/locales/it/results'
import itOnboarding from '@/locales/it/onboarding'
import itEncyclopedia from '@/locales/it/encyclopedia' 


import enCommon from '@/locales/en/common'
import enHome from '@/locales/en/home'
import enSetup from '@/locales/en/setup'
import enLobby from '@/locales/en/lobby'
import enResults from '@/locales/en/results'
import enOnboarding from '@/locales/en/onboarding'
import enEncyclopedia from '@/locales/en/encyclopedia' 

type Language = 'it' | 'en'

const dictionaries = {
  it: {
    common: itCommon,
    home: itHome,
    setup: itSetup,
    lobby: itLobby,
    results: itResults,
    onboarding: itOnboarding,
    encyclopedia: itEncyclopedia, 
  },
  en: {
    common: enCommon,
    home: enHome,
    setup: enSetup,
    lobby: enLobby,
    results: enResults,
    onboarding: enOnboarding,
    encyclopedia: enEncyclopedia, 
  }
}

interface LanguageContextType {
  t: typeof dictionaries['it']
  language: Language
  setLanguage: (lang: Language) => void 
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined)

export function LanguageProvider({ children }: { children: ReactNode }) {
  const [language, setLanguageState] = useState<Language>('it')
  const setLanguage = (lang: Language) => { setLanguageState(lang) }
  const t = dictionaries[language]

  return (
    <LanguageContext.Provider value={{ t, language, setLanguage }}>
      {children}
    </LanguageContext.Provider>
  )
} 

export function useLanguage() {
  const context = useContext(LanguageContext)
  if (context === undefined) {
    throw new Error('useLanguage must be used within a LanguageProvider')
  }
  return context
}

================================================================================
FILE: components\ui\avatar.tsx
================================================================================

'use client'


const getAvatarColor = (seed: string) => {
    const colors = [
        'bg-red-500', 'bg-orange-500', 'bg-amber-500', 
        'bg-green-500', 'bg-emerald-500', 'bg-teal-500', 
        'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 
        'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 
        'bg-fuchsia-500', 'bg-pink-500', 'bg-rose-500'
    ];
    let hash = 0;
    for (let i = 0; i < seed.length; i++) {
        hash = seed.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

export default function Avatar({ seed, src, className }: { seed: string, src?: string | null, className?: string }) {
    if (src) {
        return (
            <div className={`rounded-full overflow-hidden flex items-center justify-center bg-gray-800 ${className}`}>
                <img src={src} alt={seed} className="w-full h-full object-cover" />
            </div>
        )
    }

    const colorClass = getAvatarColor(seed);
    const initials = seed.substring(0, 2).toUpperCase();

    return (
        <div className={`rounded-full flex items-center justify-center text-white font-bold shadow-inner ${colorClass} ${className}`}>
            {initials}
        </div>
    )
} 

================================================================================
FILE: components\ui\candidate-tooltip.tsx
================================================================================
'use client'
import { useState, useRef } from 'react'
import { createPortal } from 'react-dom'
import { Candidate } from '@/types'
import { useLanguage } from '@/components/providers/language-provider' 

interface CandidateTooltipProps {
  candidate: Candidate
  children: React.ReactNode
  className?: string
}

export default function CandidateTooltip({ candidate, children, className = '' }: CandidateTooltipProps) {
  const { t } = useLanguage() 
  const [isOpen, setIsOpen] = useState(false)
  const [coords, setCoords] = useState({ top: 0, left: 0 })
  const triggerRef = useRef<HTMLDivElement>(null)

  const handleMouseEnter = () => {
    if (triggerRef.current) {
      const rect = triggerRef.current.getBoundingClientRect()
      setCoords({ top: rect.top - 10, left: rect.left + rect.width / 2 })
      setIsOpen(true)
    }
  }

  return (
    <>
      <div 
        ref={triggerRef}
        className={`relative inline-block ${className}`}
        onMouseEnter={handleMouseEnter}
        onMouseLeave={() => setIsOpen(false)}
        onClick={() => setIsOpen(!isOpen)}
      >
        {children}
      </div>

      {isOpen && (
        <Portal>
          <div 
            className="fixed z-[9999] w-64 pointer-events-none transition-opacity duration-200 animate-in fade-in zoom-in-95"
            style={{ top: coords.top, left: coords.left, transform: 'translate(-50%, -100%)' }}
          >
             <div className="bg-gray-950/95 backdrop-blur-xl border border-gray-700 p-4 rounded-xl shadow-[0_10px_40px_rgba(0,0,0,0.8)] relative">
                <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-gray-950 border-r border-b border-gray-700 rotate-45"></div>
                <div className="text-center relative z-10">
                    <h4 className="font-bold text-white text-sm mb-1">{candidate.name}</h4>
                    <div className="h-0.5 w-8 bg-indigo-500 mx-auto mb-2 rounded-full"></div>
                    <p className="text-gray-300 text-xs leading-relaxed line-clamp-6">
                        {}
                        {candidate.description || <span className="italic text-gray-500">{t.lobby.no_description}</span>}
                    </p>
                </div>
             </div>
          </div>
        </Portal>
      )}
    </>
  )
} 

const Portal = ({ children }: { children: React.ReactNode }) => {
  if (typeof window === 'undefined') return null
  return createPortal(children, document.body)
}

================================================================================
FILE: components\ui\description-tooltip.tsx
================================================================================
'use client'

import { ReactNode } from 'react'
import * as TooltipPrimitive from '@radix-ui/react-tooltip'

interface DescriptionTooltipProps {
    title: string
    description?: string
    children: ReactNode
}

export default function DescriptionTooltip({ title, description, children }: DescriptionTooltipProps) {
    if (!description) return <>{children}</>

    return (
        <TooltipPrimitive.Provider delayDuration={200}>
            <TooltipPrimitive.Root>
                <TooltipPrimitive.Trigger asChild>
                    <span className="cursor-help decoration-dotted underline-offset-2 hover:opacity-80 transition-opacity">
                        {children}
                    </span> 
                </TooltipPrimitive.Trigger>
                <TooltipPrimitive.Portal>
                    <TooltipPrimitive.Content 
                        sideOffset={5} 
                        className="max-w-xs bg-gray-900 border border-gray-700 text-white p-3 rounded-lg shadow-2xl z-50 animate-in fade-in zoom-in-95 duration-200"
                    >
                        <p className="font-bold text-sm mb-1 text-gray-200">{title}</p>
                        <p className="text-xs text-gray-400 leading-relaxed">{description}</p>
                        <TooltipPrimitive.Arrow className="fill-gray-900" />
                    </TooltipPrimitive.Content>
                </TooltipPrimitive.Portal>
            </TooltipPrimitive.Root>
        </TooltipPrimitive.Provider>
    )
}

================================================================================
FILE: components\ui\encyclopedia-modal.tsx
================================================================================
'use client'

import Modal from './modal'
import { useLanguage } from '@/components/providers/language-provider'
import { BookOpen, History, Cog, ThumbsUp, AlertTriangle } from 'lucide-react'



interface EncyclopediaModalProps {
    topicKey: string
    isOpen: boolean
    onClose: () => void
}

export default function EncyclopediaModal({ topicKey, isOpen, onClose }: EncyclopediaModalProps) {
    const { t } = useLanguage()
    
    
    const data = t.encyclopedia?.[topicKey]

    if (!data) return null

    return ( 
        <Modal isOpen={isOpen} onClose={onClose} title={data.title}>
            <div className="space-y-8">
                <div className="bg-indigo-900/20 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                    <p className="text-indigo-200 font-medium italic text-lg">
                        &quot;{data.subtitle}&quot;
                    </p>
                </div>

                <div className="grid gap-6 md:grid-cols-2">
                    <div className="space-y-2">
                        <div className="flex items-center gap-2 text-yellow-500 font-bold uppercase text-xs tracking-widest">
                            <History size={16} /> Storia
                        </div>
                        <p className="text-sm md:text-base">{data.history}</p>
                    </div>

                    <div className="space-y-2">
                        <div className="flex items-center gap-2 text-cyan-500 font-bold uppercase text-xs tracking-widest">
                            <Cog size={16} /> Come Funziona
                        </div>
                        <p className="text-sm md:text-base">{data.mechanism}</p>
                    </div>
                </div>

                <hr className="border-gray-800" />

                <div className="grid gap-4 sm:grid-cols-2">
                    <div className="bg-green-900/10 border border-green-900/30 p-4 rounded-xl">
                        <div className="flex items-center gap-2 text-green-400 font-bold mb-2">
                            <ThumbsUp size={16} /> Vantaggi
                        </div>
                        <p className="text-xs text-gray-400">{data.pros}</p>
                    </div>

                    <div className="bg-red-900/10 border border-red-900/30 p-4 rounded-xl">
                        <div className="flex items-center gap-2 text-red-400 font-bold mb-2">
                            <AlertTriangle size={16} /> Limiti
                        </div>
                        <p className="text-xs text-gray-400">{data.cons}</p>
                    </div>
                </div>

                <div className="flex justify-center pt-4 opacity-30">
                     <BookOpen size={48} />
                </div>
            </div>
        </Modal>
    )
}

================================================================================
FILE: components\ui\image-picker.tsx
================================================================================

'use client'

import { useState } from 'react'
import { UI } from '@/lib/constants'
import { Image as ImageIcon, Link as LinkIcon, X } from 'lucide-react'

interface ImagePickerProps {
    value: string
    onChange: (val: string) => void
    placeholder?: string
}

export default function ImagePicker({ value, onChange, placeholder = "https://..." }: ImagePickerProps) {
    const [isOpen, setIsOpen] = useState(false)

    if (isOpen || value) {
        return (
            <div className="flex items-center gap-2 w-full animate-in fade-in slide-in-from-left-2 duration-200">
                <div className="relative flex-1">
                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">
                        <LinkIcon size={14} />
                    </div>
                    <input 
                        autoFocus
                        placeholder={placeholder}
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                        className={`w-full ${UI.COLORS.BG_INPUT} pl-9 pr-3 py-2 rounded-lg text-xs border border-gray-700 focus:border-${UI.COLORS.PRIMARY}-500 outline-none transition-colors`}
                    />
                </div>
                {value && (
                    <div className="w-8 h-8 rounded-lg overflow-hidden border border-gray-700 bg-black">
                        <img src={value} alt="Preview" className="w-full h-full object-cover" />
                    </div>
                )}
                <button 
                    onClick={() => { onChange(''); setIsOpen(false) }}
                    className="p-2 hover:bg-red-500/20 hover:text-red-400 text-gray-500 rounded-lg transition-colors"
                >
                    <X size={16} />
                </button>
            </div>
        )
    }

    return (
        <button 
            type="button"
            onClick={() => setIsOpen(true)}
            className="flex items-center gap-2 px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs text-gray-400 hover:text-white transition-all border border-gray-700 hover:border-gray-600"
        >
            <ImageIcon size={14} /> 
            <span>Aggiungi Immagine</span>
        </button>
    )
}

================================================================================
FILE: components\ui\info-button.tsx
================================================================================
'use client'

import { useState } from 'react'
import { Info } from 'lucide-react'
import EncyclopediaModal from './encyclopedia-modal'

interface InfoButtonProps {
  topicKey?: string 
  simpleText?: string 
  size?: number
  className?: string
}

export default function InfoButton({ topicKey, simpleText, size = 16, className = "" }: InfoButtonProps) {
  const [isOpen, setIsOpen] = useState(false)

  
  if (!topicKey && simpleText) {
      return (
          <div className={`group relative inline-flex items-center justify-center cursor-help ${className}`} title={simpleText}>
              <Info size={size} className="text-gray-500 hover:text-white transition-colors" />
          </div>
      )
  }

  
  return (
    <>
        <button 
            type="button"
            onClick={() => setIsOpen(true)}
            className={`inline-flex items-center justify-center text-gray-500 hover:text-indigo-400 transition-colors ${className}`}
        >
            <Info size={size} />
        </button>

        {topicKey && (
            <EncyclopediaModal 
                topicKey={topicKey} 
                isOpen={isOpen} 
                onClose={() => setIsOpen(false)}  
            />
        )}
    </>
  )
}

================================================================================
FILE: components\ui\language-switcher.tsx
================================================================================
'use client'

import { useLanguage } from '@/components/providers/language-provider'

export default function LanguageSwitcher() {
  
  const { language, setLanguage } = useLanguage()

  return (
    <div className="fixed top-4 right-4 z-[9999] flex items-center gap-2 bg-gray-900/80 backdrop-blur border border-gray-700 rounded-full p-1 shadow-lg">
      <button
        onClick={() => setLanguage('it')}
        className={`px-3 py-1 text-xs font-bold rounded-full transition-all ${
          language === 'it' 
            ? 'bg-white text-black shadow' 
            : 'text-gray-400 hover:text-white'
        }`}
      >
        IT
      </button>
      <button
        onClick={() => setLanguage('en')}
        className={`px-3 py-1 text-xs font-bold rounded-full transition-all ${
          language === 'en' 
            ? 'bg-white text-black shadow' 
            : 'text-gray-400 hover:text-white'
        }`}
      > 
        EN
      </button>
    </div>
  )
}

================================================================================
FILE: components\ui\modal.tsx
================================================================================
'use client'

import { useEffect, useState } from 'react'
import { createPortal } from 'react-dom'
import { X } from 'lucide-react'

interface ModalProps {
    isOpen: boolean
    onClose: () => void
    title: string
    children: React.ReactNode
}

export default function Modal({ isOpen, onClose, title, children }: ModalProps) {
    const [mounted, setMounted] = useState(false)

    useEffect(() => {
        
        setMounted(true) 
    }, [])

    useEffect(() => {
        const handleEsc = (e: KeyboardEvent) => {
            if (e.key === 'Escape') onClose()
        }
        window.addEventListener('keydown', handleEsc)
        return () => window.removeEventListener('keydown', handleEsc)
    }, [onClose])

    if (!mounted || !isOpen) return null

    if (typeof document === 'undefined') return null

    return createPortal(
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6">
            <div 
                className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
                onClick={onClose}
            />
            <div className="relative w-full max-w-2xl bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-200">
                <div className="flex items-center justify-between p-6 border-b border-gray-800">
                    <h2 className="text-xl font-bold text-white">{title}</h2>
                    <button 
                        onClick={onClose}
                        className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-full transition-colors"
                    >
                        <X size={20} />
                    </button>
                </div>
                <div className="p-6 overflow-y-auto text-gray-300 leading-relaxed space-y-4">
                    {children}
                </div> 
            </div>
        </div>,
        document.body
    )
}

================================================================================
FILE: core\gamification\awards.ts
================================================================================
import { Participant } from '@/types';
import { VoteRecord, VotingResult } from '../voting/types';
import { calculateMean, calculateStdDev } from '../math/statistics';

export type BadgeType = 'hater' | 'lover' | 'contrarian' | 'oracle' | 'hive_mind';

export interface UserGamificationStats {
    userId: string;
    avgScore: number;
    stdDev: number;
    agreementScore: number;
    badges: BadgeType[];
}

export const getBadgeIcon = (type: BadgeType) => {
    switch(type) {
        case 'hater': return 'ü§¨'
        case 'lover': return 'üòç'
        case 'hive_mind': return 'üêù'
        case 'contrarian': return 'ü¶Ñ'
        case 'oracle': return 'üîÆ'
        default: return 'üèÖ'
    }
}

export const calculateAwards = (
    participants: Participant[],
    votes: VoteRecord[],
    schulzeResult: VotingResult, 
    
): Record<string, BadgeType[]> => {
    
    if (participants.length < 3) return {};

    const stats: UserGamificationStats[] = [];
    
    participants.forEach(p => {
        const userVotes = votes.filter(v => v.voter_id === p.user_id);
        if (userVotes.length === 0) return;

        const allScores: number[] = [];
        userVotes.forEach(v => allScores.push(...Object.values(v.scores)));
        
        if (allScores.length === 0) return;

        const userMean = calculateMean(allScores);
        const userStd = calculateStdDev(allScores, userMean);

        let oraclePoints = 0;
        if (schulzeResult.ranking.length > 0) {
            const schulzeWinnerId = schulzeResult.ranking[0].id;
            let bestCandId = "";
            let maxScore = -1;

            userVotes.forEach(uv => {
                const sum = Object.values(uv.scores).reduce((a,b)=>a+b, 0);
                if (sum > maxScore) {
                    maxScore = sum;
                    bestCandId = uv.candidate_id;
                }
            });

            if (bestCandId === schulzeWinnerId) {
                oraclePoints = 100;
            }
        }

        stats.push({
            userId: p.user_id,
            avgScore: userMean,
            stdDev: userStd,
            agreementScore: oraclePoints,
            badges: []
        });
    });

    if (stats.length < 2) return {};

    stats.sort((a, b) => a.avgScore - b.avgScore);
    const critic = stats[0]; 
    const optimist = stats[stats.length - 1]; 

    const byDev = [...stats].sort((a, b) => a.stdDev - b.stdDev);
    const hiveMind = byDev[0];
    const maverick = byDev[byDev.length - 1];

    const result: Record<string, BadgeType[]> = {};
    stats.forEach(s => result[s.userId] = []);

    if (critic) result[critic.userId].push('hater');
    if (optimist) result[optimist.userId].push('lover');
    if (maverick && maverick.stdDev > 2.0) result[maverick.userId].push('contrarian');
    if (hiveMind) result[hiveMind.userId].push('hive_mind');

    const oracles = stats.filter(s => s.agreementScore === 100);
    oracles.forEach(o => result[o.userId].push('oracle'));

    return result; 
};

================================================================================
FILE: core\math\statistics.ts
================================================================================

export const calculateMean = (values: number[]): number => {
    if (values.length === 0) return 0;
    return values.reduce((a, b) => a + b, 0) / values.length;
};


export const calculateStdDev = (values: number[], mean?: number): number => {
    if (values.length === 0) return 0;
    const m = mean ?? calculateMean(values);
    const squareDiffs = values.map(value => Math.pow(value - m, 2));
    const avgSquareDiff = calculateMean(squareDiffs);
    return Math.sqrt(avgSquareDiff);
};


export const calculateZScore = (value: number, mean: number, stdDev: number): number => {
    if (stdDev === 0) return 0; 
    return (value - mean) / stdDev;
};


export const normalizeZScoreToPercent = (zScore: number): number => {
    const MIN_Z = -3;
    const MAX_Z = 3;
    
    const clamped = Math.max(MIN_Z, Math.min(MAX_Z, zScore));
    
    return ((clamped - MIN_Z) / (MAX_Z - MIN_Z)) * 100;
}; 

================================================================================
FILE: core\voting\algorithms\schulze-logic.ts
================================================================================


export interface SchulzeOutput {
    winners: string[];
    ranking: string[]; 
    matrix: Record<string, Record<string, number>>; 
    strongestPaths: Record<string, Record<string, number>>; 
}

export function runSchulzeAlgo(candidates: string[], ballots: string[][]): SchulzeOutput {
    const n = candidates.length;
    
    const idMap = new Map<string, number>();
    candidates.forEach((c, i) => idMap.set(c, i));

    
    
    const d: number[][] = Array(n).fill(0).map(() => Array(n).fill(0));

    
    for (const ballot of ballots) {
        
        
        for (let i = 0; i < ballot.length; i++) {
            const winnerId = ballot[i];
            const winnerIdx = idMap.get(winnerId);
            if (winnerIdx === undefined) continue;

            for (let j = i + 1; j < ballot.length; j++) {
                const loserId = ballot[j];
                const loserIdx = idMap.get(loserId);
                if (loserIdx === undefined) continue;

                d[winnerIdx][loserIdx]++;
            }
            
            
            
            
            for (const otherCand of candidates) {
                if (!ballot.includes(otherCand)) {
                    const loserIdx = idMap.get(otherCand)!;
                    d[winnerIdx][loserIdx]++;
                }
            }
        }
    }

    
    const p: number[][] = Array(n).fill(0).map(() => Array(n).fill(0));

    for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
            if (i !== j) {
                if (d[i][j] > d[j][i]) {
                    p[i][j] = d[i][j];
                } else {
                    p[i][j] = 0;
                }
            }
        }
    }

    
    for (let k = 0; k < n; k++) {
        for (let i = 0; i < n; i++) {
            if (i !== k) {
                for (let j = 0; j < n; j++) {
                    if (j !== k && i !== j) {
                        p[i][j] = Math.max(p[i][j], Math.min(p[i][k], p[k][j]));
                    }
                }
            }
        }
    }

    
    
    const winsCount: Record<string, number> = {};
    candidates.forEach(c => winsCount[c] = 0);

    for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
            if (i !== j) {
                if (p[i][j] > p[j][i]) {
                    winsCount[candidates[i]]++;
                }
            }
        }
    }

    
    const ranking = [...candidates].sort((a, b) => winsCount[b] - winsCount[a]);
    const maxWins = winsCount[ranking[0]] || 0;
    const winners = ranking.filter(c => winsCount[c] === maxWins);

    
    const matrixOut: Record<string, Record<string, number>> = {};
    const pathsOut: Record<string, Record<string, number>> = {};

    candidates.forEach((ci, i) => {
        matrixOut[ci] = {};
        pathsOut[ci] = {};
        candidates.forEach((cj, j) => {
            matrixOut[ci][cj] = d[i][j];
            pathsOut[ci][cj] = p[i][j];
        });
    });
   
    return { winners, ranking, matrix: matrixOut, strongestPaths: pathsOut };
}

================================================================================
FILE: core\voting\engine.ts
================================================================================
import { Candidate, Factor } from '@/types';
import { VoteRecord, VotingResult, VotingStrategy } from './types';
import { WeightedStrategy } from './strategies/weighted';
import { BordaStrategy } from './strategies/borda';
import { SchulzeStrategy } from './strategies/schulze';

const strategies: Record<string, VotingStrategy> = {
    'weighted': WeightedStrategy,
    'borda': BordaStrategy,
    'schulze': SchulzeStrategy
};

export const calculateResults = (
    system: 'weighted' | 'borda' | 'schulze',
    candidates: Candidate[],
    votes: VoteRecord[],
    factors: Factor[],
    maxScale: number
): VotingResult => {
    const strategy = strategies[system] || WeightedStrategy;
    return strategy.calculate(candidates, votes, factors, { maxScale });
};


export const calculateAllSystems = (
    candidates: Candidate[],
    votes: VoteRecord[],
    factors: Factor[],
    maxScale: number
): Record<string, VotingResult> => {
    return {
        weighted: strategies.weighted.calculate(candidates, votes, factors, { maxScale }),
        borda: strategies.borda.calculate(candidates, votes, factors, { maxScale }),
        schulze: strategies.schulze.calculate(candidates, votes, factors, { maxScale }),
    };
}; 

================================================================================
FILE: core\voting\strategies\borda.ts
================================================================================
import { VotingStrategy } from '../types';

export const BordaStrategy: VotingStrategy = {
    name: 'borda',
    calculate(candidates, votes, factors, options) {
        const scores: Record<string, number> = {};
        const maxScale = options?.maxScale || 10;
        
        
        candidates.forEach(c => scores[c.id] = 0);

        
        const voterIds = Array.from(new Set(votes.map(v => v.voter_id)));

        voterIds.forEach(voterId => {
            
            const userPreferences = candidates.map(cand => {
                const vote = votes.find(v => v.voter_id === voterId && v.candidate_id === cand.id);
                if (!vote) return { id: cand.id, rawScore: -1 }; 

                let rawScore = 0;
                factors.forEach(f => {
                    let val = vote.scores[f.id] || 0;
                    if (f.trend === 'lower_better') val = maxScale - val;
                    rawScore += val * f.weight;
                });
                
                
                
                
                if (vote.is_jolly) rawScore += 0.001; 

                return { id: cand.id, rawScore };
            });

            
            userPreferences.sort((a, b) => b.rawScore - a.rawScore);

            
            userPreferences.forEach((pref, index) => {
                
                if (pref.rawScore >= 0) {
                    const points = (candidates.length - 1) - index;
                    scores[pref.id] += points;
                }
            });
        });

        const ranking = [...candidates].sort((a, b) => scores[b.id] - scores[a.id]);
 
        return { ranking, scores, details: null, stats: {} };
    }
};

================================================================================
FILE: core\voting\strategies\schulze.ts
================================================================================
import { VotingStrategy } from '../types';
import { runSchulzeAlgo } from '../algorithms/schulze-logic';

export const SchulzeStrategy: VotingStrategy = {
    name: 'schulze',
    calculate(candidates, votes, factors, options) {
        const maxScale = options?.maxScale || 10;
        
        
        
        const voterIds = Array.from(new Set(votes.map(v => v.voter_id)));
        const ballots: string[][] = [];

        voterIds.forEach(voterId => {
            const userVotes = candidates.map(cand => {
                const vote = votes.find(v => v.voter_id === voterId && v.candidate_id === cand.id);
                
                let score = -1; 
                if (vote) {
                    score = 0;
                    factors.forEach(f => {
                        let val = vote.scores[f.id] || 0;
                        if (f.trend === 'lower_better') val = maxScale - val;
                        score += val * f.weight;
                    });
                }
                return { id: cand.id, score };
            });

            
            const validVotes = userVotes.filter(u => u.score >= 0);
            if (validVotes.length > 0) {
                
                validVotes.sort((a, b) => b.score - a.score);
                ballots.push(validVotes.map(u => u.id));
            }
        });

        
        const candidateIds = candidates.map(c => c.id);
        const result = runSchulzeAlgo(candidateIds, ballots);

        
        
        const scores: Record<string, number> = {};
        
        
        candidates.forEach(c => {
            
            let beatCount = 0;
            candidates.forEach(opp => {
                if (c.id !== opp.id) {
                    const pStrong = result.strongestPaths[c.id]?.[opp.id] || 0;
                    const pWeak = result.strongestPaths[opp.id]?.[c.id] || 0;
                    if (pStrong > pWeak) beatCount++;
                }
            });
            scores[c.id] = beatCount;
        });

        
        const ranking = result.ranking
            .map(id => candidates.find(c => c.id === id))
            .filter((c): c is typeof candidates[0] => !!c);

        return { 
            ranking, 
            scores, 
            details: { 
                matrix: result.matrix, 
                strongestPaths: result.strongestPaths, 
                winners: result.winners 
            }, 
            stats: {} 
        };
    }
}; 

================================================================================
FILE: core\voting\strategies\weighted.ts
================================================================================
import { VotingStrategy } from '../types'; 
import { calculateMean } from '../../math/statistics';

const JOLLY_MULTIPLIER = 1.25; 

export const WeightedStrategy: VotingStrategy = {
    name: 'weighted',
    calculate(candidates, votes, factors, options) {
        const scores: Record<string, number> = {};
        const maxScale = options?.maxScale || 10;

        candidates.forEach(cand => {
            const candVotes = votes.filter(v => v.candidate_id === cand.id);
            const weightedSum: number[] = [];

            candVotes.forEach(vote => {
                let voteTotal = 0;
                let totalWeight = 0;

                factors.forEach(factor => {
                    let val = vote.scores[factor.id] || 0;
                    if (factor.trend === 'lower_better') val = maxScale - val;
                    
                    voteTotal += val * factor.weight;
                    totalWeight += factor.weight;
                });

                let finalVoteValue = totalWeight > 0 ? voteTotal / totalWeight : 0;

                if (vote.is_jolly) {
                    finalVoteValue *= JOLLY_MULTIPLIER;
                }

                weightedSum.push(finalVoteValue);
            });
            
            scores[cand.id] = calculateMean(weightedSum);
        });

        const ranking = [...candidates].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));

        
        return { ranking, scores, details: null, stats: {} };
    }
}; 

================================================================================
FILE: core\voting\types.ts
================================================================================
import { Candidate, Factor } from '@/types';

export interface VoteRecord {
    candidate_id: string;
    voter_id: string;
    scores: Record<string, number>; 
    is_jolly: boolean;
}

export interface VotingResult {
    ranking: Candidate[]; 
    scores: Record<string, number>; 
    details: Record<string, unknown> | null; 
    stats: {
        min?: number;
        max?: number;
    }
}

export interface VotingStrategy {
    name: 'weighted' | 'borda' | 'schulze' | 'median';
    calculate(
        candidates: Candidate[], 
        votes: VoteRecord[], 
        factors: Factor[],
        options?: { maxScale: number }
    ): VotingResult;
} 

================================================================================
FILE: lib\client.ts
================================================================================
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

  if (!supabaseUrl || !supabaseKey) {
    throw new Error("Mancano le variabili d'ambiente di Supabase!")
  }

  return createBrowserClient(
    supabaseUrl,
    supabaseKey
  )
} 

================================================================================
FILE: lib\constants.ts
================================================================================
export const UI = {
  
  LAYOUT: {
    MAX_WIDTH_CONTAINER: "max-w-xl", 
    PADDING_X: "px-6",
    PADDING_Y: "py-8",
    GAP_DEFAULT: "gap-4",
    ROUNDED_LG: "rounded-3xl",
    ROUNDED_MD: "rounded-xl",
  },
   
  
  COLORS: {
    PRIMARY: "indigo", 
    
    TREND_HIGH: "text-green-400 border-green-500/30 bg-green-900/10", 
    
    TREND_LOW: "text-amber-400 border-amber-500/30 bg-amber-900/10", 
    
    WARNING: "text-red-400",
    TEXT_MUTED: "text-gray-400",
    
    
    BG_CARD: "bg-gray-900/50 border border-gray-800",
    BG_INPUT: "bg-gray-900 border border-gray-700",
  },

  
  LIMITS: {
    MAX_SCALE_DEFAULT: 10,
    MIN_CANDIDATES: 2,
    IMAGE_SIZE_UPLOAD_MB: 2,
  }
}

================================================================================
FILE: lib\i18n.ts
================================================================================
import it from '@/locales/it'
import en from '@/locales/en'

export const dictionaries = {
  it,
  en
}

export type Locale = keyof typeof dictionaries 

================================================================================
FILE: lib\lobby-utils.ts
================================================================================

export const getScoreColor = (score: number, max: number, isLowerBetter: boolean) => {
  let normalized = score / max
  
  
  
  if (isLowerBetter) normalized = 1 - normalized
  
  if (normalized < 0.3) return 'bg-red-500' 
  if (normalized < 0.7) return 'bg-yellow-500' 
  return 'bg-green-500' 
} 

================================================================================
FILE: lib\voting-engine.ts
================================================================================
import { Candidate, Factor } from '@/types';
import { VoteRecord } from '@/core/voting/types';


export const normalizeVotes = (
  candidates: Candidate[],
  votes: VoteRecord[],
  factors: Factor[],
  maxScale: number
): Record<string, number> => {
  const scores: Record<string, number> = {};

  candidates.forEach(cand => {
    const candVotes = votes.filter(v => v.candidate_id === cand.id);
    const allNormalizedScores: number[] = []; 
 
    candVotes.forEach(vote => {
      let voteTotal = 0;
      let totalWeight = 0;

      factors.forEach(factor => {
        let val = vote.scores[factor.id] || 0;
        
        if (factor.trend === 'lower_better') val = maxScale - val;
        
        voteTotal += val * factor.weight;
        totalWeight += factor.weight;
      });

      
      const normalized = totalWeight > 0 ? (voteTotal / totalWeight) / maxScale : 0;
      allNormalizedScores.push(normalized);
    });

    
    if (allNormalizedScores.length > 0) {
      scores[cand.id] = allNormalizedScores.reduce((a, b) => a + b, 0) / allNormalizedScores.length;
    } else {
      scores[cand.id] = 0;
    }
  });

  return scores;
};

================================================================================
FILE: locales\en\common.ts
================================================================================
const common = {
  loading: "Loading...",
  error: "An error occurred. Please try again.",
  save: "Save",
  saved: "Saved!",
  cancel: "Cancel",
  confirm: "Confirm",
  delete: "Delete",
  edit: "Edit",
  back: "Back",
  next: "Next",
  yes: "Yes",
  no: "No",
  close: "Close",
  copy_link: "Copy Link",
  link_copied: "Link copied to clipboard!",
  delete_msg_title: "Delete Message",
  delete_msg_desc: "Are you sure? This action cannot be undone.",
  
  image_label: "Image URL",
  history: "History",

  img_picker_tab_url: "Link URL",
  img_picker_tab_file: "Upload File",
  img_picker_ph: "Paste image URL...",
  img_picker_upload_btn: "Choose Image",
  img_picker_or: "or",
  img_picker_drag: "Drag here"
}

export default common

================================================================================
FILE: locales\en\encyclopedia.ts
================================================================================
const encyclopedia = {
  weighted: {
    title: "Weighted Average",
    subtitle: "The democratic classic with a touch of precision.",
    history: "Derived from the arithmetic mean, used since the Pythagoreans. Adding 'weights' allows prioritizing certain criteria over others.",
    mechanism: "Each voter rates candidates on various criteria. The final score is the sum of ratings multiplied by criteria weights.",
    pros: "Easy to understand; captures nuances across multiple dimensions.",
    cons: "Vulnerable to tactical voting (giving extreme scores); doesn't guarantee a majority winner."
  },
  borda: {
    title: "Borda Count",
    subtitle: "Rewards consensus, not just popularity.",
    history: "Proposed by Jean-Charles de Borda in 1770 for the French Academy of Sciences as an alternative to simple majority voting.",
    mechanism: "If there are 5 candidates, your 1st choice gets 4 points, 2nd gets 3, etc. Points from all voters are summed.",
    pros: "Selects broadly acceptable candidates; reduces the impact of polarizing figures.",
    cons: "Can be manipulated by introducing 'clone' candidates to split opponents' votes."
  },
  schulze: {
    title: "Schulze Method (Beatpath)",
    subtitle: "The King of Condorcet methods. Mathematically superior.",
    history: "Developed by Markus Schulze in 1997. Used by Debian, Ubuntu, and Pirate Parties for its robustness.",
    mechanism: "Compares every candidate against every other (duels). If A beats B more often than B beats A, a path is formed. The winner is the one who beats everyone else on the strongest paths.",
    pros: "Satisfies the Condorcet criterion; immune to many manipulative strategies.",
    cons: "Complex to calculate manually and hard to explain intuitively."
  }
}

export default encyclopedia

================================================================================
FILE: locales\en\home.ts
================================================================================
const home = {
  title: "Democracy is Dead",
  subtitle: "Advanced voting systems for better group decisions.",
  
  create_lobby: "Create New Lobby",
  join_lobby: "Join Existing Lobby",
  enter_code: "Lobby code",
  join: "Join",
  
  cta_button: "Start Now",
  cta_loading: "Creating...",
  or_divider: "OR",
  join_placeholder: "Enter code (e.g. ABCD)",
  join_btn: "Go",
  
  no_registration: "No registration required. Anonymous voting.",
  
  history: "Recent History",
  no_history: "No recent lobbies visited.",
  
  toast_init: "Initializing...",
  toast_success: "Lobby created successfully!",
  toast_error: "Error creating lobby.",
  
  error_code_short: "Code must be 6 characters long.",
  error_lobby_not_found: "Lobby not found. Check the code."
}

export default home

================================================================================
FILE: locales\en\index.ts
================================================================================
import common from './common'
import home from './home'
import lobby from './lobby'
import results from './results'
import encyclopedia from './encyclopedia'
import setup from './setup'       
import onboarding from './onboarding' 

const en = {
  common,
  home,
  lobby,
  results,
  encyclopedia,
  setup,         
  onboarding     
}

export default en

================================================================================
FILE: locales\en\lobby.ts
================================================================================
const lobby = {
  status_label: "Status",
  status_waiting: "Waiting for Host",
  status_setup: "Setup in Progress",
  status_voting: "Voting Open",
  status_ended: "Voting Ended",
  
  guest_title: "Welcome to the Lobby",
  guest_desc: "Wait for the host to start the voting session.",
  
  terminate_btn: "End Voting",
  terminate_confirm: "Are you sure you want to close the voting? Users will no longer be able to submit scores.",
  join_lobby: "Join Lobby",
  no_description: "No description available",

  hub_title: "Lobby Hub",
  chat_tab: "Chat",
  participants_tab: "Participants",
  chat_empty: "No messages yet. Break the ice!",
  participant_role: "Role",
  voted_badge: "Voted",
  anon_user: "Anonymous User",
  
  voting: {
    title: "Express Your Preference",
    subtitle: "Rate each candidate for the different criteria.",
    submit_btn: "Confirm Votes",
    submitted_msg: "Votes Saved! (You can change them until the end)",
    
    trend_info_high: "HIGHER values are better (e.g. Taste)",
    trend_info_low: "LOWER values are better (e.g. Price)",
    static_value_label: "Declared Value:",
    scan_to_join: "Scan to join",
    click_details: "Click for details",

    jolly_section: {
      title: "Assign your Jolly üÉè",
      subtitle: "You have only one special bonus. Choose your undisputed champion.",
      no_selection: "No Jolly assigned",
      selected: "Jolly Assigned to:"
    }
  },

  host_title: "You are the Host üëë",
  host_desc: "Participants are joining. Auto-configuring...",
  host_btn_config: "Configure Lobby üöÄ",
  loading_setup: "Starting configuration...",
  setup_desc: "The host is configuring candidates and voting criteria...",
  chat: {
    placeholder: "Type a message...",
    send: "Send",
    title: "Lobby Chat"
  }
}

export default lobby

================================================================================
FILE: locales\en\onboarding.ts
================================================================================
const onboarding = {
  title: "Welcome to the Lobby",
  subtitle: "Choose how you will appear to other voters.",
  label_nickname: "Nickname",
  placeholder_nickname: "E.g. John Doe",
  join_btn: "Join Lobby"
}

export default onboarding

================================================================================
FILE: locales\en\results.ts
================================================================================
const results = {
  ranking_title: "Final Ranking",
  matrix_title: "Detailed Vote Matrix",
  matrix_subtitle: "Raw scores assigned by each participant.",
  
  reopen_btn: "Reopen Voting",
  reopen_confirm: "Are you sure? This allows users to change their votes again.",
  
  math_legend_desc: "How scores are calculated based on the selected algorithm.",
  
  matrix_anon: "Anonymous User",
  my_vote: "(You)",

  systems: {
    weighted: {
      title: "Weighted Average",
      desc: "Classic average of scores weighted by criteria importance."
    },
    borda: {
      title: "Borda Count",
      desc: "Points assigned based on position in each user's ranking."
    },
    schulze: {
      title: "Schulze Method",
      desc: "Condorcet method based on strongest paths in pairwise duels."
    },
    median: {
      title: "Median Rating",
      desc: "The middle score, robust against extreme votes."
    }
  },

  charts: {
    radar: "Radar Analysis",
    radar_desc: "Comparison of strengths across different criteria.",
    comparison: "Algorithm Comparison",
    comparison_desc: "How the winner changes depending on the math used.",
    compare_title: "Winners by System"
  },

  schulze_matrix: {
    title: "Duel Matrix",
    subtitle: "Pairwise Analysis: Read the row to see how many times that candidate beat the others (Row > Column).",
    wins: "Wins",
    loses: "Loses",
    ties: "Ties"
  },

  badges: {
    title: "Awards",
    hater: "The Hater",
    lover: "The Lover",
    contrarian: "The Contrarian",
    oracle: "The Oracle",
    hive_mind: "Hive Mind"
  },

  badges_desc: {
     hater: "Gave the lowest average scores.",
     lover: "Gave the highest average scores.",
     contrarian: "Often disagrees with the majority.",
     oracle: "Predicted the winner perfectly.",
     hive_mind: "Votes align closely with the group average."
  }
}

export default results

================================================================================
FILE: locales\en\setup.ts
================================================================================
const setup = {
  header: {
    title: "Lobby Setup",
    step_1: "General Settings",
    step_2: "Candidates",
    step_3: "Criteria"
  },
  settings: {
    title: "Voting Scale",
    min: "Minimum",
    max: "Maximum",
    desc: "The scale defines the voting range (e.g. 0-10). Minimum is currently fixed at 0."
  },
  candidates: {
    title: "Candidate Management",
    add_btn: "Add",
    update_btn: "Update",
    cancel_btn: "Cancel",
    placeholder_name: "Candidate Name (e.g. Pizza)",
    placeholder_desc: "Description / Ingredients",
    placeholder_url: "Image URL (optional)",
    empty_list: "No candidates yet. Add one!"
  },
  factors: {
    title: "Criteria Management",
    new_title: "New Criterion",
    add_btn: "Add",
    placeholder_name: "Name (e.g. Taste)",
    placeholder_desc: "Description (optional)",
    placeholder_url: "Icon/Image URL (optional)",
    label_weight: "Weight (1-10)",
    label_trend: "Trend",
    trend_high: "Higher is better",
    trend_low: "Lower is better",
    empty_list: "No criteria added."
  },
  buttons: {
    back: "Back",
    next: "Next",
    saving: "Saving...",
    start: "Start Voting üöÄ"
  }
}

export default setup

================================================================================
FILE: locales\it\common.ts
================================================================================
const common = {
  loading: "Caricamento...",
  error: "Si √® verificato un errore. Riprova.",
  save: "Salva",
  saved: "Salvato!",
  cancel: "Annulla",
  confirm: "Conferma",
  delete: "Elimina",
  edit: "Modifica",
  back: "Indietro",
  next: "Avanti",
  yes: "S√¨",
  no: "No",
  close: "Chiudi",
  copy_link: "Copia Link",
  link_copied: "Link copiato negli appunti!",
  delete_msg_title: "Elimina Messaggio",
  delete_msg_desc: "Sei sicuro? Questa azione non pu√≤ essere annullata.",
  
  image_label: "URL Immagine",
  history: "Cronologia",
  
  img_picker_tab_url: "Link URL",
  img_picker_tab_file: "Carica File",
  img_picker_ph: "Incolla URL immagine...",
  img_picker_upload_btn: "Scegli Immagine",
  img_picker_or: "oppure",
  img_picker_drag: "Trascina qui"
}

export default common

================================================================================
FILE: locales\it\encyclopedia.ts
================================================================================
const encyclopedia = {
  weighted: {
    title: "Media Pesata (Weighted)",
    subtitle: "Il classico democratico con un tocco di precisione.",
    history: "Derivato dalla media aritmetica, uno dei concetti matematici pi√π antichi, usato sin dai tempi dei Pitagorici. L'aggiunta dei 'pesi' permette di dare pi√π importanza ad alcuni criteri rispetto ad altri.",
    mechanism: "Ogni votante assegna un voto (es. 1-10) per ogni criterio. Il voto finale √® la somma dei voti moltiplicati per il peso del criterio.",
    pros: "Facile da capire; permette di valutare sfumature su pi√π dimensioni.",
    cons: "Vulnerabile al voto tattico (dare 1 o 10 per influenzare la media); non garantisce il vincitore preferito dalla maggioranza assoluta."
  },
  borda: {
    title: "Conteggio Borda",
    subtitle: "Premia il consenso, non solo la popolarit√†.",
    history: "Proposto da Jean-Charles de Borda nel 1770 per l'Accademia delle Scienze francese come alternativa al voto di maggioranza semplice.",
    mechanism: "Se ci sono 5 candidati, la tua prima scelta prende 4 punti, la seconda 3, ecc. Si sommano i punti di tutti.",
    pros: "Sceglie candidati ampiamente accettati; riduce l'impatto dei candidati polarizzanti.",
    cons: "Pu√≤ essere manipolato inserendo candidati 'cloni' o fantoccio per diluire i voti degli avversari."
  },
  schulze: {
    title: "Metodo Schulze (Beatpath)",
    subtitle: "Il Re dei metodi Condorcet. Matematicamente superiore.",
    history: "Sviluppato da Markus Schulze nel 1997. √à usato da organizzazioni come Debian, Ubuntu, e il Partito Pirata per la sua robustezza.",
    mechanism: "Confronta ogni candidato contro ogni altro (duelli). Se A batte B pi√π spesso di quanto B batta A, si traccia un percorso. Vince chi batte tutti gli altri nei percorsi pi√π forti.",
    pros: "Soddisfa il criterio di Condorcet (se uno batte tutti, vince); immune a molte strategie manipolative.",
    cons: "Complesso da calcolare a mano e difficile da spiegare intuitivamente."
  }
}

export default encyclopedia

================================================================================
FILE: locales\it\home.ts
================================================================================
const home = {
  title: "Democracy is Dead",
  subtitle: "Sistemi di voto avanzati per decisioni di gruppo migliori.",
  
  
  create_lobby: "Crea Nuova Lobby",
  join_lobby: "Unisciti a una Lobby",
  enter_code: "Codice lobby",
  join: "Entra",
  
  
  cta_button: "Inizia Subito",
  cta_loading: "Creazione...",
  or_divider: "OPPURE",
  join_placeholder: "Inserisci codice (es. ABCD)",
  join_btn: "Vai",
  
  
  no_registration: "Nessuna registrazione richiesta. Voto anonimo.",
  
  
  history: "Cronologia Recente",
  no_history: "Nessuna lobby visitata di recente.",
  
  
  toast_init: "Inizializzazione...",
  toast_success: "Lobby creata con successo!",
  toast_error: "Errore nella creazione della lobby.",
  
  error_code_short: "Il codice deve essere di 6 caratteri.",
  error_lobby_not_found: "Lobby non trovata. Controlla il codice."
}

export default home

================================================================================
FILE: locales\it\index.ts
================================================================================
import common from './common'
import home from './home'
import lobby from './lobby'
import results from './results'
import encyclopedia from './encyclopedia'
import setup from './setup'       
import onboarding from './onboarding' 

const it = {
  common,
  home,
  lobby,
  results,
  encyclopedia,
  setup,         
  onboarding     
}

export default it

================================================================================
FILE: locales\it\lobby.ts
================================================================================
const lobby = {
  status_label: "Stato",
  status_waiting: "In attesa dell'Host",
  status_setup: "Setup in Corso",
  status_voting: "Votazione Aperta",
  status_ended: "Votazione Terminata",
  
  guest_title: "Benvenuto nella Lobby",
  guest_desc: "Attendi che l'host avvii la sessione di voto.",
  
  terminate_btn: "Termina Voto",
  terminate_confirm: "Sei sicuro di voler chiudere la votazione? Gli utenti non potranno pi√π inviare voti.",
  join_lobby: "Entra nella Lobby",
  no_description: "Nessuna descrizione disponibile",

  hub_title: "Lobby Hub",
  chat_tab: "Chat",
  participants_tab: "Partecipanti",
  chat_empty: "Nessun messaggio ancora. Rompi il ghiaccio!",
  participant_role: "Ruolo",
  voted_badge: "Ha Votato",
  anon_user: "Utente Anonimo",
  
  voting: {
    title: "Esprimi la tua preferenza",
    subtitle: "Valuta ogni candidato per i diversi criteri.",
    submit_btn: "Conferma Voti",
    submitted_msg: "Voti Salvati! (Puoi modificarli fino al termine)",
    
    trend_info_high: "Valori ALTI sono migliori (es. Gusto)",
    trend_info_low: "Valori BASSI sono migliori (es. Prezzo)",
    static_value_label: "Valore Dichiarato:",
    scan_to_join: "Scansiona per unirti",
    click_details: "Clicca per i dettagli",

    jolly_section: {
      title: "Assegna il tuo Jolly üÉè",
      subtitle: "Hai un solo bonus speciale. Scegli il tuo campione indiscusso.",
      no_selection: "Nessun Jolly assegnato",
      selected: "Jolly Assegnato a:"
    }
  },

  host_title: "Sei l'Host üëë",
  host_desc: "I partecipanti stanno entrando. Configurazione automatica in corso...",
  host_btn_config: "Configura Lobby üöÄ",
  loading_setup: "Avvio configurazione...",
  setup_desc: "L'host sta configurando i candidati e i criteri di voto...",
  chat: {
    placeholder: "Scrivi un messaggio...",
    send: "Invia",
    title: "Chat Lobby"
  }
}

export default lobby

================================================================================
FILE: locales\it\onboarding.ts
================================================================================
const onboarding = {
  title: "Benvenuto nella Lobby",
  subtitle: "Scegli come apparirai agli altri votanti.",
  label_nickname: "Nickname",
  placeholder_nickname: "Es. Mario Rossi",
  join_btn: "Entra nella Lobby"
}

export default onboarding

================================================================================
FILE: locales\it\results.ts
================================================================================
const results = {
  ranking_title: "Classifica Finale",
  matrix_title: "Matrice dei Voti",
  matrix_subtitle: "I punteggi grezzi assegnati da ogni partecipante.",
  
  reopen_btn: "Riapri Voto",
  reopen_confirm: "Sei sicuro? Questo permetter√† agli utenti di cambiare i voti.",
  
  math_legend_desc: "Come vengono calcolati i punteggi in base all'algoritmo scelto.",
  
  matrix_anon: "Utente Anonimo",
  my_vote: "(Tu)",

  systems: {
    weighted: {
      title: "Media Pesata",
      desc: "Media classica dei voti ponderata per l'importanza dei criteri."
    },
    borda: {
      title: "Conteggio Borda",
      desc: "Punti assegnati in base alla posizione nella classifica di ogni utente."
    },
    schulze: {
      title: "Metodo Schulze",
      desc: "Metodo di Condorcet basato sui percorsi pi√π forti nei duelli a coppie."
    },
    median: {
      title: "Mediana",
      desc: "Il valore centrale, robusto contro i voti estremi."
    }
  },

  charts: {
    radar: "Analisi Radar",
    radar_desc: "Confronto delle forze su diversi criteri.",
    comparison: "Confronto Algoritmi",
    comparison_desc: "Come cambia il vincitore a seconda della matematica usata.",
    compare_title: "Vincitori per Sistema"
  },

  schulze_matrix: {
    title: "Matrice dei Duelli",
    subtitle: "Analisi Pairwise: Leggi la riga per vedere quante volte quel candidato ha battuto gli altri (Riga > Colonna).",
    wins: "Vince",
    loses: "Perde",
    ties: "Pareggia"
  },

  badges: {
    title: "Titoli",
    hater: "Il Critico Spietato",
    lover: "L'Ottimista Incurabile",
    contrarian: "Bastian Contrario",
    oracle: "L'Oracolo",
    hive_mind: "Mente Collettiva"
  },
  
  badges_desc: {
     hater: "Ha dato i voti medi pi√π bassi.",
     lover: "Ha dato i voti medi pi√π alti.",
     contrarian: "Spesso in disaccordo con la maggioranza.",
     oracle: "I suoi gusti rispecchiano esattamente il vincitore.",
     hive_mind: "Vota quasi sempre come la media del gruppo."
  }
}

export default results

================================================================================
FILE: locales\it\setup.ts
================================================================================
const setup = {
  header: {
    title: "Configurazione Lobby",
    step_1: "Impostazioni Generali",
    step_2: "Candidati",
    step_3: "Criteri"
  },
  settings: {
    title: "Scala di Voto",
    min: "Minimo",
    max: "Massimo",
    desc: "La scala definisce il range di voti (es. 0-10). Attualmente il minimo √® fisso a 0."
  },
  candidates: {
    title: "Gestione Candidati",
    add_btn: "Aggiungi",
    update_btn: "Aggiorna",
    cancel_btn: "Annulla",
    placeholder_name: "Nome Candidato (es. Pizza)",
    placeholder_desc: "Descrizione / Ingredienti",
    placeholder_url: "URL Immagine (opzionale)",
    empty_list: "Nessun candidato. Aggiungine uno!"
  },
  factors: {
    title: "Gestione Criteri",
    new_title: "Nuovo Criterio",
    add_btn: "Aggiungi",
    placeholder_name: "Nome (es. Gusto)",
    placeholder_desc: "Descrizione (opzionale)",
    placeholder_url: "URL Icona/Immagine (opzionale)",
    label_weight: "Peso (1-10)",
    label_trend: "Trend",
    trend_high: "Alto √® meglio",
    trend_low: "Basso √® meglio",
    empty_list: "Nessun criterio aggiunto."
  },
  buttons: {
    back: "Indietro",
    next: "Avanti",
    saving: "Salvataggio...",
    start: "Avvia Voto üöÄ"
  }
}

export default setup

================================================================================
FILE: next-env.d.ts
================================================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


================================================================================
FILE: next.config.ts
================================================================================
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  
};

export default nextConfig;


================================================================================
FILE: package.json
================================================================================
{
  "name": "democracy-is-dead",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "scan": "node scan-codebase.js",
    "clean:comments": "node clean-comments.js"
  },
  "dependencies": {
    "@radix-ui/react-tooltip": "^1.2.8",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.89.0",
    "chart.js": "^4.5.1",
    "framer-motion": "^12.23.26",
    "lucide-react": "^0.562.0",
    "next": "16.1.0",
    "qrcode.react": "^4.2.0",
    "react": "19.2.3",
    "react-chartjs-2": "^5.3.1",
    "react-dom": "19.2.3",
    "react-qr-code": "^2.0.18",
    "recharts": "^3.6.0",
    "sonner": "^2.0.7"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@typescript-eslint/parser": "^8.50.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^8.57.1",
    "eslint-config-next": "^14.1.0",
    "eslint-plugin-i18next": "^6.1.3",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "typescript": "^5"
  }
}


================================================================================
FILE: tsconfig.json
================================================================================
{
  "compilerOptions": {
    "target": "es5",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}


================================================================================
FILE: types\index.ts
================================================================================





export type Trend = 'higher_better' | 'lower_better';




export type FactorType = 'vote' | 'static';

export interface Factor {
  id: string;
  name: string;
  weight: number;
  type: FactorType;
  trend: Trend;
  image_url?: string | null; 
  description?: string; 
}

export interface Candidate {
  id: string;
  lobby_id: string;
  name: string;
  description: string;
  image_url: string | null;
  
  static_values?: Record<string, number>; 
}

export interface Participant {
  id: string;
  user_id: string;
  nickname: string;
  has_voted: boolean;
  avatar_url?: string | null; 
  is_online?: boolean;
}

export interface VotingScale {
  max: number;
}

export interface LobbySettings {
  privacy: 'public' | 'private';
  voting_scale: VotingScale;
  allow_decimals: boolean;
  factors: Factor[];
}

export interface Lobby {
  id: string;
  code: string;
  host_id: string;
  status: 'setup' | 'voting' | 'ended';
  settings: LobbySettings;
  created_at: string;
}
